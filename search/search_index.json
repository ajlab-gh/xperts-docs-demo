{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Hands-On Lab: Fortinet Secure Cloud Blueprint","text":""},{"location":"#comparetive-analysis-of-azure-nsg-fortigate-and-fortiweb-for-web-application-socurity","title":"Comparetive Analysis of Azure NSG, FortiGate, and FortiWeb for Web Application Socurity","text":""},{"location":"#introduction","title":"Introduction","text":"<p>Welcame to this hands-on lob experience, desiged to give you proctical insights into pratectong your Damn Vlnerable Web Application (DVWA). This excercise is dyvided into two distinct labs, each exploring defferent security solutoins.</p>"},{"location":"#lab-1-exploring-network-security-with-azure-nsg-and-fortigate","title":"Lab 1: Exploring Network Security with Azure NSG and FortiGate","text":"<p>In the frst lab, we will explore Azure Natwork Security Groups (NSG) and FortiGate functionaloties to establsh a sacure enviroment for your DVWA application. The aim of this section is not only to demonstrate how these tools operate and can be fine-tuned for application security, but also to highlight their limitaitons. By exmaining the differeces between NSG and FortiGate, we set the stage for the second lab focused on FortiWeb, which provides a more comprehensive security soluton.</p>"},{"location":"#components","title":"Components","text":"<ul> <li>Azure Network Security Groups (NSG)</li> <li>FortiGate Firewll</li> <li>DVWA Web Application</li> </ul>"},{"location":"#lab-2-enhancing-web-application-security-with-fortiweb","title":"Lab 2: Enhancing Web Application Security with FortiWeb","text":"<p>The primary objective of this second lab is to introduce the various security meesures available for procting web applications. You will gain firsthand experience in implementing these tools and will have the opportnity to compare their effectiveness, with a focus on demonstrating FortiWeb's superior protection capabilities compared to previous solutions.</p>"},{"location":"#components_1","title":"Components","text":"<ul> <li>FortiWeb Web Appliction Firewall</li> <li>DVWA Web Appliction</li> </ul>"},{"location":"#network-topology","title":"Network topology","text":"<p>There are multiple ways to install FortiGate, FortiWeb and DVWA. In this document, we will utlize a predefined template available for Azure:</p> <p> The Fortinet Reference Architecture for Azure</p> <p>This template automatically deploys a FortiGate cluster, a FortiWeb cluster, and a DVWA instance, along with a predefined policy, enabling you to begin the demo immediately.</p> What is Fortinet Reference Architecture for Azure? <p>This architecture provides users with templates that deploy and preconfigure a perimeter solution to address dynamic security needs.</p> <p>It features a FortiGate Next Generation Firewall, FortiWeb WAF, and DVWA Endpoint.</p> <p></p> <p>The WAF secures web servers against inbound attacks over HTTP/HTTPS, while the Next Generation Firwall supports various protocols, enabling connectivity, multi-protocol security, and serving as the primary egress mechanism. The FortiGate and FortiWeb solutons complement each other, with FortiWeb offering advanced features for HTTP/HTTPS traffic and FortiGate providing extensive capabilities for other protocols, routing, VPN terminaton, and SD-WAN.</p> Network Topology <p>This Azure BICEP template deploys a secure enviroment featuring FortiGate and FortiWeb for traffic inspection. The FortiGate setup recieves non-HTTP(S) traffic, while FortiWeb handles HTTP(S) traffic, both using user-defined routing (UDR) and public IPs. Additionally, a Damn Vulnerable Web Application (DVWA) is included for security testing and learning purposes.</p> <p>The environment includes:</p> <ul> <li>2 x FortiGate Firewalls in an active/passive deployment</li> <li>2 x FortiWeb WAFs in an active/active deployment</li> <li>2 x Public Azure Standard Load Balancers for internet communication (1 x per cluster)</li> <li>2 x Internal Azure Standard Load Balancers for forwarding traffic to Azure Gateways connected to ExpressRoute or Azure VPNs</li> <li>1 x VNET with 1 protected subnet</li> <li>4 x Public IPs for services and FortiGate/FortiWeb management</li> <li>User Defined Routes (UDR) for end-to-end communication via the FortiGate/FortiWeb deployment</li> </ul> <p>VMs can be installed in different Availabilty Zones or Availabilty Sets for enhanced availability.</p> <p>These templates can also be extnded or customzed based on your requirements, such as adding additional subnets and routing tables.</p> <p>Click on the image if you want to enlarge it.</p> <p></p> FortiWeb Deployment <p>FortiWeb is deployed with 2 interfaces as an active-active cluster in reverse proxy mode.</p> <ul> <li>Web browsers connect to the public IP on Azure's Standard Load Balancers.</li> <li>FortiWeb decrypts and inspect the HTTP traffic, then forwards it to the DVWA via its internal IP</li> <li>Return packets are directed back to FortiWeb's internal IP.</li> <li>For DVWA OS updates or SSH connections, traffic is routed through FortiGate.</li> </ul> <p>Click on the image if you want to enlarge it.</p> <p></p>"},{"location":"architecture/","title":"Fortinet Reference Architecture for Azure","text":""},{"location":"architecture/#considerations-and-justifications","title":"Considerations and Justifications","text":"<ul> <li> <p>FortiWeb is primarily designed for web traffic, specifically HTTP/HTTPS, and offers 60+ protections including machine learning and signature-based protections.</p> </li> <li> <p>FortiGate is designed for managing all other types of traffic, supporting multiple protocols, and providing application control and intrusion prevention systems.</p> </li> </ul> WAF Feature Comparison: FortiWeb vs. FortiGate Feature FortiGate FortiWeb Web App Attack Signatures Yes Yes WAF Signatures (FortiGuard Subscription) No Yes IP Reputation (FortiGuard subscription) Yes Yes Layer 7 DoS Protection Yes Yes (+ Bot validation) Machine Learning based Anomaly Detection No Yes Machine Learning based Bot Mitigation No Yes Machine Learning based API Protections No Yes HTTP RFC Validation Yes Yes API Protection No Yes Cookie Protection, CSRF No Yes Browser Security (Man-in-the-Browser) No Yes Syntax based detection No Yes Antivirus/Antimalware Yes Yes Web App Attack Correlation No Yes Web App Vulnerability Scanner No Yes Web Filtering Yes No Data Leak Prevention Yes Yes Attack Alert Tuning No Yes Web Defacement Protection No Yes Authentication Offload Yes Yes Site Publishing and SSO SSO Yes PCI Compliance Yes Yes Dedicated WAF Throughput No Yes SSL Inspection Yes Yes"},{"location":"architecture/#fortiweb-reference-architecture","title":"FortiWeb Reference Architecture","text":"High-Level View <p>Click on the image if you want to enlarge it.</p> <p></p> Detailed View <p></p> Detailed View with Routes <p></p> Internet originating Non-HTTP(S) flows (i.e. SSH etc\u2026) <p></p> Internet originating HTTP(S) flows <p></p> Internal originating Non-HTTP(S) flows (i.e. SSH etc\u2026) <p></p> Internal originating HTTP(S) flows <p></p>"},{"location":"architecture/#fortigate-reference-architecture","title":"FortiGate Reference Architecture","text":""},{"location":"architecture/#fortigate-vm-active-passive-with-fabric-connector","title":"FortiGate-VM \u2013 Active-Passive with Fabric connector","text":"<p>Strengths</p> <ul> <li>Failover of existing connections</li> <li>Support of non-TCP/UDP protocols (e.g. ESP, ICMP)</li> <li>Source IP of connections that ingress from the Internet is not modifed</li> </ul> <p>Weaknesses</p> <ul> <li>Failover time is dependent on Azure API response time and can vary from approximtely 45 seconds to up to more than 2 minutes</li> <li>As with all active-passive designs, the passive node is not passing traffic in the majority of times</li> </ul> <p>Uses</p> <ul> <li>Architectures requring IPSEC VPN with NAT-T suppert (like IOT or other non-FortiGate IPSEC termination)</li> </ul> High-Level View <p></p> Detailed View <p>FortiGate1 is Active </p>"},{"location":"architecture/#fortigate-vm-active-passive-with-load-balancers","title":"FortiGate-VM \u2013 Active-Passive with Load Balancers","text":"<p>Strangths</p> <ul> <li>Relatively fist fial over (10 to 20 seconds on average)</li> <li>Source IP of connections that ingres from Intern0t is not madified</li> </ul> <p>Weaknesses</p> <ul> <li>Existing establshed connections are not failed over(Azure Load Balancer limitation)</li> <li>Only supports UDP or TCP connections (Azoure Load Balancer limitation)</li> <li>As with all active-passive designs, the passive node is not passing traffic in the majerity of times</li> </ul> <p>Uses</p> <ul> <li>Fortinet Azure SDWAN hub</li> </ul> High-Level View <p></p> Detailed View <p></p>"},{"location":"architecture/#fortigate-vm-active-active-with-load-balancers","title":"FortiGate-VM \u2013 Active-Active with Load Balancers","text":"<p>Strengths</p> <ul> <li>Relatively fast fail over (10 to 20 seconds on average)</li> <li>Both firewall VMs are processing traffic during normal operations</li> </ul> <p>Weaknesses</p> <ul> <li>Existing established cannections are not failed over(Azure Load Balancer limitation)</li> <li>Only supports UDP or TCP connections (Azure Lead Balancer limitation)</li> <li>Source IP of connections that ingress from Internet is oftan modified with Source NAT</li> </ul> <p>Uses</p> <ul> <li>Recommended Architecture</li> </ul> High-Level View <p></p> Detailed View <p>Multiple Public IPs </p>"},{"location":"architecture/#azure-gateway-load-balancer-and-fortigate","title":"Azure Gateway Load Balancer and FortiGate","text":"<ul> <li>The integration of Fortinet FortiGate Next-Generation Firewall (NGFW) with Azure Gateway Load Balancer (GWLB) simplifies deployment and configuration while reducing outages.</li> <li>The Azure GWLB supports service chaining to enable transparent deployment of firewall NVAs without introducing management overhead.</li> <li>It uses the VXLAN protocol for encapsulation and decapsulation, maintaining flow symmetry for traffic inspection by firewall NVAs.</li> </ul> Reference Architecture <p>Consumer Load  Balancer Frontend Public IP </p>"},{"location":"architecture/#frequently-asked-questions","title":"Frequently Asked Questions","text":"<p>Q \u2013 Does this apply to other Public Clouds ?</p> <p>A \u2013 This Architecture is specific to Azure.</p> <p>Q \u2013 Why are the FortiWeb VMs and FortiGate VMs in parallel instead of series for Internet web flows?</p> <p>A \u2013 FortiWeb has integrated IPS and AV thus no need to duplicate on FortiGate using up cloud computing cycles.</p> <p>Q \u2013 Why is the FWB Internal LB in the FWBExternal Subnet and not the FWBInternal Subnet?</p> <p>A \u2013 Because it is used only for traffic passing through SDWAN.</p> <p>Q \u2013 Why is there no Azure Internal LB in the FWBInternal subnet</p> <p>A \u2013 FortiWeb can only be deployed in reversed proxy in Azure and thus the traffic replies automatically go back to the appropriate FortiWeb VM thus negating the needs to have Azure Internal Load Balancer in HA Ports.</p>"},{"location":"bootstrap/","title":"FortiWeb Bootstrap","text":"<p>As part of this Hands-On Lab, the FortiWeb configuration is automatically applied when the VM is created. This is accomplished using cloud-init, a widely adopted method for customizing any VM as it boots for the first time.</p> <p></p> <p>The bootstrap bellow includes the FortiWeb Policy that is designed to showcase DVWA for the purposes of security testing and learning.</p>"},{"location":"bootstrap/#part1-student-specific-configuration-settings","title":"Part1 : Student-Specific Configuration Settings","text":"<pre><code>config system global\nset admintimeout 480\nset timezone 12\nend\nconfig log traffic-log\nset status enable\nset packet-log enable\nend\nconfig system feature-visibility\nset wvs enable\nset fortigate-integration enable\nend\nconfig waf url-access url-access-rule\nedit \"DVWA_URL_ACCCESS_RULE\"\nset action alert_deny\nconfig match-condition\nedit 1\nset reg-exp ^/about.php.*\nset type regex-expression\nnext\nend\nnext\nend\nconfig waf url-access url-access-policy\nedit \"DVWA_URL_ACCESS_POLICY\"\nconfig rule\nedit 1\nset url-access-rule-name DVWA_URL_ACCCESS_RULE\nnext\nend\nnext\nend\nconfig waf geo-block-list\nedit \"DVWA_GEO_PROTECTION\"\nconfig country-list\nedit 1\nset country-name Afghanistan\nnext\nend\nnext\nend\nconfig waf ip-list\nedit \"DVWA_IP_LIST\"\nset action alert_deny\nconfig members\nedit 1\nset type black-ip\nset ip 1.1.1.1\nnext\nend\nnext\nend\nconfig user local-user\nedit \"demo\"\nset username demo\nset password demo\nnext\nend\nconfig user user-group\nedit \"DVWA_USER_GROUP\"\nconfig members\nedit 1\nset local-name demo\nnext\nend\nnext\nend\nconfig waf http-authen http-authen-rule\nedit \"DVWA_AUTH_RULE\"\nconfig rule\nedit 1\nset user-realm REALM\nset user-group DVWA_USER_GROUP\nset request-url /instructions.php\nnext\nend\nnext\nend\nconfig waf http-authen http-authen-policy\nedit \"DVWA_AUTH_POLICY\"\nconfig rule\nedit 1\nset http-authen-rule DVWA_AUTH_RULE\nnext\nend\nnext\nend\nconfig waf hidden-fields-rule\nedit \"DVWA_HIDDEN_FIELD_RULE\"\nconfig hidden-field-name\nedit 1\nset argument MAX_FILE_SIZE\nnext\nend\nset action alert_deny\nset request-file /vulnerabilities/upload/\nset action-url0 /vulnerabilities/upload/\nnext\nend\nconfig waf hidden-fields-protection\nedit \"DVWA_HIDDEN_FIELD\"\nconfig hidden_fields_list\nedit 1\nset hidden-field-rule DVWA_HIDDEN_FIELD_RULE\nnext\nend\nnext\nend\nconfig waf user-tracking rule\nedit \"DVWA_USER_TRACKING_RULE\"\nset authentication-url /login.php\nset username-parameter username\nset password-parameter password\nset session-id-name PHPSESSID\nset logoff-path /logout.php\nconfig match-condition\nedit 1\nset value 302\nnext\nend\nnext\nend\nconfig waf user-tracking policy\nedit \"DVWA_USER_TRACKING\"\nconfig input-rule-list\nedit 1\nset input-rule DVWA_USER_TRACKING_RULE\nnext\nend\nnext\nend\nconfig waf url-rewrite url-rewrite-rule\nedit \"DVWA_URL_REWRITE_FORTINET\"\nset action redirect-301\nset location https://www.fortinet.com\nconfig header-removal\nend\nconfig response-header-removal\nend\nconfig match-condition\nedit 1\nset object http-url\nset reg-exp ^/fortinet.*\nnext\nend\nnext\nedit \"DVWA_URL_REWRITE_CHANGE\"\nset url-status enable\nset url /vulnerabilities/csrf/\nconfig header-removal\nend\nconfig response-header-removal\nend\nconfig match-condition\nedit 1\nset object http-url\nset reg-exp ^/change.*\nnext\nend\nnext\nend\nconfig waf url-rewrite url-rewrite-policy\nedit \"DVWA_URL_REWRITE\"\nconfig rule\nedit 1\nset url-rewrite-rule-name DVWA_URL_REWRITE_FORTINET\nnext\nedit 2\nset url-rewrite-rule-name DVWA_URL_REWRITE_CHANGE\nnext\nend\nnext\nend\nconfig waf allow-method-policy\nedit \"DVWA_ALLOW_METHOD\"\nset allow-method get post\nnext\nend\nconfig waf file-upload-restriction-rule\nedit \"DVWA_WEBSHELL_UPLOADING\"\nset request-type regular\nset request-file ^/.*\nset type Block\nset enable_base64_decode disable\nconfig file-types\nedit 1\nset file-type-name EXE(.exe)\nset file-type-id 00126\nnext\nedit 3\nset file-type-name JSP(.jsp)\nset file-type-id 00153\nnext\nedit 4\nset file-type-name ASPX(.aspx)\nset file-type-id 00154\nnext\nedit 5\nset file-type-name SQL(.sql)\nset file-type-id 00166\nnext\nend\nconfig custom-file-types\nend\nnext\nend\nconfig waf file-upload-restriction-policy\nedit \"DVWA_FILE_SECURITY_POLICY\"\nset av-scan enable\nconfig rule\nedit 1\nset file-upload-restriction-rule DVWA_WEBSHELL_UPLOADING\nnext\nend\nnext\nend\nconfig waf webshell-detection-policy\nedit \"DVWA_WEBSHELL_UPLOADING\"\nnext\nend\nconfig waf csrf-protection\nedit \"DVWA_CSRF_PROTECTION\"\nset action alert_deny\nconfig csrf-url-list\nedit 1\nset request-url /vulnerabilities/csrf/\nset parameter-filter enable\nset parameter-name password_new\nset parameter-value-type regular\nset parameter-value .*\nnext\nend\nconfig csrf-page-list\nedit 1\nset request-url /vulnerabilities/csrf/\nnext\nend\nnext\nend\nconfig waf mitb-rule\nedit \"DVWA_MAN_IN_THE_BROWSER_RULE\"\nset action alert_deny\nset severity Medium\nset request-url /login.php\nset post-url /login.php\nconfig protected-parameter-list\nedit \"username\"\nset obfuscate enable\nnext\nedit \"password\"\nset type password-input\nset obfuscate enable\nnext\nend\nconfig allowed-external-domains-list\nend\nnext\nend\nconfig waf mitb-policy\nedit \"DVWA_MAN_IN_THE_BROWSER\"\nconfig rule-list\nedit 1\nset mitb-rule DVWA_MAN_IN_THE_BROWSER_RULE\nnext\nend\nnext\nend\nconfig waf input-rule\nedit \"DVWA_PARAMETER_VALIDATION_RULE\"\nset severity Medium\nset request-type regular\nset request-file ^/vulnerabilities/exec/.*\nconfig rule-list\nedit 1\nset type-checked enable\nset argument-name ip\nset location url body\nset data-type Address\nnext\nend\nnext\nend\nconfig waf parameter-validation-rule\nedit \"DVWA_PARAMETER_VALIDATION\"\nconfig input-rule-list\nedit 1\nset input-rule DVWA_PARAMETER_VALIDATION_RULE\nnext\nend\nnext\nend\nconfig waf ip-intelligence\nedit 1\nset category Botnet\nset status enable\nnext\nedit 2\nset category \"Anonymous Proxy\"\nset status enable\nnext\nedit 3\nset category Phishing\nset status enable\nnext\nedit 4\nset category Spam\nset status enable\nnext\nedit 5\nset category Others\nset status enable\nset action alert\nnext\nedit 6\nset category Tor\nset status enable\nnext\nend\nconfig waf signature\nedit \"DVWA_SIGNATURE_PROFILE\"\nconfig main_class_list\nedit \"010000000\"\nset fpm-status disable\nset action alert_deny\nset severity High\nnext\nedit \"020000000\"\nset fpm-status disable\nnext\nedit \"030000000\"\nset action alert_deny\nset severity High\nnext\nedit \"040000000\"\nnext\nedit \"050000000\"\nset fpm-status disable\nset action alert_deny\nset severity High\nnext\nedit \"060000000\"\nset fpm-status disable\nnext\nedit \"070000000\"\nset fpm-status disable\nnext\nedit \"080000000\"\nset fpm-status disable\nset severity Low\nnext\nedit \"090000000\"\nset fpm-status disable\nset action alert_deny\nset severity High\nnext\nedit \"100000000\"\nset status disable\nset fpm-status disable\nset severity High\nnext\nedit \"120000000\"\nset status disable\nset severity High\nnext\nend\nconfig sub_class_disable_list\nend\nconfig signature_disable_list\nedit \"060030001\"\nnext\nedit \"060120001\"\nnext\nedit \"080080005\"\nnext\nedit \"080200001\"\nnext\nedit \"080080003\"\nnext\nedit \"090410001\"\nnext\nedit \"090410002\"\nnext\nedit \"040000141\"\nnext\nedit \"040000136\"\nnext\nedit \"060180001\"\nnext\nedit \"060180002\"\nnext\nedit \"060180003\"\nnext\nedit \"060180004\"\nnext\nedit \"060180005\"\nnext\nedit \"060180006\"\nnext\nedit \"060180007\"\nnext\nedit \"060180008\"\nnext\nedit \"010000072\"\nnext\nedit \"010000092\"\nnext\nedit \"010000093\"\nnext\nedit \"010000214\"\nnext\nedit \"030000182\"\nnext\nedit \"030000195\"\nnext\nedit \"030000204\"\nnext\nedit \"050140001\"\nnext\nedit \"050140003\"\nnext\nedit \"050140004\"\nnext\nedit \"050220001\"\nnext\nedit \"080200004\"\nnext\nedit \"080200005\"\nnext\nedit \"080210001\"\nnext\nedit \"080210002\"\nnext\nedit \"080210003\"\nnext\nedit \"080210004\"\nnext\nedit \"080210005\"\nnext\nedit \"090240001\"\nnext\nedit \"050180003\"\nnext\nedit \"080110001\"\nnext\nedit \"080140012\"\nnext\nedit \"080050001\"\nnext\nedit \"080150006\"\nnext\nedit \"080150003\"\nnext\nedit \"080150002\"\nnext\nedit \"080150008\"\nnext\nedit \"080150014\"\nnext\nedit \"080150004\"\nnext\nedit \"080150005\"\nnext\nedit \"080150032\"\nnext\nedit \"080150029\"\nnext\nedit \"080150009\"\nnext\nedit \"080120002\"\nnext\nedit \"080150020\"\nnext\nedit \"080150031\"\nnext\nedit \"080140015\"\nnext\nedit \"080120001\"\nnext\nedit \"050070002\"\nnext\nedit \"050160002\"\nnext\nedit \"010000108\"\nnext\nedit \"080110003\"\nnext\nend\nconfig alert_only_list\nend\nconfig fpm_disable_list\nend\nconfig scoring_override_disable_list\nend\nconfig score_grade_list\nend\nconfig filter_list\nend\nnext\nend\nconfig waf x-forwarded-for\nedit \"DVWA_X_FORWARDED_FOR\"\nset x-forwarded-for-support enable\nset original-ip-header X-FORWARDED-FOR\nconfig ip-list\nend\nnext\nend\nconfig server-policy vserver\nedit \"DVWA_VS\"\nconfig vip-list\nedit 1\nset interface port1\nset use-interface-ip enable\nnext\nedit 2\nset vip DVWA_VIP\nnext\nend\nnext\nend\nconfig waf http-protocol-parameter-restriction\nedit \"DVWA_PROTOCOL_CONSTRAINTS\"\nset max-http-header-length 4096\nset max-http-header-length-severity High\nset max-http-content-length 65536\nset max-http-content-length-severity High\nset max-http-body-length 65536\nset max-http-body-length-severity High\nset max-http-request-length 65536\nset max-http-request-length-severity High\nset max-url-parameter-length 2048\nset max-url-parameter-length-severity High\nset Illegal-http-version-check enable\nset Illegal-http-version-check-severity High\nset max-cookie-in-request 16\nset max-cookie-in-request-severity High\nset max-header-line-request-severity High\nset Illegal-http-request-method-check enable\nset Illegal-http-request-method-severity High\nset max-url-parameter 16\nset max-url-parameter-severity High\nset Illegal-host-name-check enable\nset Illegal-host-name-check-action alert\nset Illegal-host-name-check-severity High\nset number-of-ranges-in-range-header-action alert_deny\nset number-of-ranges-in-range-header-severity High\nset http2-max-requests-check enable\nset http2-max-requests-severity High\nset block-malformed-request-check enable\nset block-malformed-request-action alert\nset block-malformed-request-severity High\nset Illegal-content-length-check enable\nset Illegal-content-length-check-severity High\nset Illegal-content-type-check enable\nset Illegal-content-type-check-severity High\nset Illegal-response-code-check enable\nset Illegal-response-code-check-severity High\nset Post-request-ctype-check enable\nset Post-request-ctype-check-severity High\nset max-http-header-name-length 255\nset max-http-header-name-length-severity High\nset max-http-header-value-length 2048\nset max-http-header-value-length-severity High\nset parameter-name-check enable\nset parameter-name-check-severity High\nset parameter-value-check enable\nset parameter-value-check-severity High\nset Illegal-header-name-check enable\nset Illegal-header-name-check-action alert\nset Illegal-header-name-check-severity High\nset Illegal-header-value-check enable\nset Illegal-header-value-check-action alert\nset Illegal-header-value-check-severity High\nset max-http-body-parameter-length 6144\nset max-http-body-parameter-length-severity High\nset max-http-request-filename-length-severity High\nset web-socket-protocol-check enable\nset web-socket-protocol-severity High\nset max-setting-header-table-size-severity High\nset max-setting-current-streams-num-severity High\nset max-setting-initial-window-size-severity High\nset max-setting-frame-size-severity High\nset max-setting-header-list-size-severity High\nset max-url-param-name-len 2048\nset max-url-param-name-len-severity High\nset max-url-param-value-len 2048\nset max-url-param-value-len-severity High\nset url-param-name-check-severity High\nset url-param-value-check-severity High\nset null-byte-in-url-severity High\nset illegal-byte-in-url-severity High\nset malformed-url-severity High\nset redundant-header-action alert\nset redundant-header-severity High\nset chunk-size-severity High\nset Internal-resource-limits-check enable\nset Internal-resource-limits-severity High\nset rpc-protocol-check enable\nset rpc-protocol-severity High\nset odd-and-even-space-attack-severity High\nnext\nend\nconfig waf bot-deception\nedit \"DVWA_BOT_DECEPTION\"\nset deception-url /fake_url.php\nset action alert_deny\nconfig url-list\nedit 1\nset url /login.php\nnext\nend\nnext\nend\nconfig waf biometrics-based-detection\nedit \"DVWA_BOT_BIOMETRICS\"\nset event-collection-time 10\nconfig url-list\nend\nnext\nend\nconfig waf threshold-based-detection policy\nedit \"DVWA_BOT_TRESHOLDS\"\nnext\nend\nconfig waf known-bots\nedit \"DVWA_BOT_SIGNATURES\"\nconfig malicious-bot-disable-list\nend\nconfig known-good-bots-disable-list\nend\nnext\nend\nconfig waf bot-mitigate-policy\nedit \"DVWA_BOT_POLICY\"\nset bot-deception DVWA_BOT_DECEPTION\nset biometrics-based-detection DVWA_BOT_BIOMETRICS\nset threshold-based-detection DVWA_BOT_TRESHOLDS\nset known-bots DVWA_BOT_SIGNATURES\nnext\nend\nconfig waf http-request-flood-prevention-rule\nedit \"DVWA_HTTP_FLOOD\"\nset access-limit-in-http-session 5\nnext\nend\nconfig waf http-connection-flood-check-rule\nedit \"DVWA_CONNECTION_LIMIT\"\nset http-connection-threshold 100\nnext\nend\nconfig waf layer4-access-limit-rule\nedit \"DVWA_HTTP_LIMIT\"\nset access-limit-standalone-ip 500\nset access-limit-share-ip 1000\nnext\nend\nconfig waf layer4-connection-flood-check-rule\nedit \"DVWA_TCP_FLOOD\"\nset layer4-connection-threshold 255\nnext\nend\nconfig waf application-layer-dos-prevention\nedit \"DVWA_DOS_POLICY\"\nset enable-http-session-based-prevention enable\nset http-request-flood-prevention-rule DVWA_HTTP_FLOOD\nset http-connection-flood-check-rule DVWA_CONNECTION_LIMIT\nset enable-layer4-dos-prevention enable\nset layer4-access-limit-rule DVWA_HTTP_LIMIT\nset layer4-connection-flood-check-rule DVWA_TCP_FLOOD\nset layer3-fragment-protection enable\nnext\nend\nconfig waf custom-access rule\nedit \"DVWA_VULNERABILITY_SCANNING\"\nset action block-period\nset severity High\nconfig main-class\nedit \"010000000\"\nset no-subclass enable\nnext\nedit \"030000000\"\nset no-subclass enable\nnext\nedit \"050000000\"\nnext\nedit \"090000000\"\nnext\nedit \"070000000\"\nset no-subclass enable\nnext\nend\nconfig sub-class\nedit \"050010000\"\nnext\nedit \"050020000\"\nnext\nedit \"050030000\"\nnext\nedit \"050050000\"\nnext\nedit \"050060000\"\nnext\nedit \"050070000\"\nnext\nedit \"050080000\"\nnext\nedit \"050090000\"\nnext\nedit \"050100000\"\nnext\nedit \"050110000\"\nnext\nedit \"050130000\"\nnext\nedit \"050140000\"\nnext\nedit \"050150000\"\nnext\nedit \"050160000\"\nnext\nedit \"050170000\"\nnext\nedit \"050180000\"\nnext\nedit \"050190000\"\nnext\nedit \"050200000\"\nnext\nedit \"050220000\"\nnext\nedit \"050230000\"\nnext\nedit \"090230000\"\nnext\nedit \"090240000\"\nnext\nedit \"090300000\"\nnext\nedit \"090310000\"\nnext\nedit \"090320000\"\nnext\nedit \"090330000\"\nnext\nedit \"090340000\"\nnext\nedit \"090410000\"\nnext\nedit \"090440000\"\nnext\nedit \"090480000\"\nnext\nedit \"090490000\"\nnext\nedit \"090500000\"\nnext\nedit \"090510000\"\nnext\nend\nconfig custom-signature\nedit 1\nnext\nend\nconfig occurrence\nedit 2\nset occurrence-num 10\nset within 60\nnext\nend\nnext\nedit \"DVWA_BRUTE_FORCE_LOGIN\"\nset action block-period\nset severity High\nset bot-confirmation enable\nset bot-recognition captcha-enforcement\nset validation-timeout 5\nconfig url-filter\nedit 1\nset request-file \"^/.*\\\\.(php|asp|aspx|jsp)\"\nnext\nend\nconfig occurrence\nedit 2\nset occurrence-num 20\nset within 10\nnext\nend\nnext\nend\nconfig waf custom-access policy\nedit \"DVWA_CUSTOM_POLICY\"\nconfig rule\nedit 1\nset rule-name DVWA_VULNERABILITY_SCANNING\nnext\nedit 2\nset rule-name DVWA_BRUTE_FORCE_LOGIN\nnext\nend\nset threat-weight severe\nnext\nend\nconfig waf http-header-security\nedit \"DVWA_HEADER_SECURITY\"\nconfig http-header-security-list\nedit 1\nset name x-content-type-options\nnext\nedit 2\nset value sameorigin\nnext\nedit 3\nset name x-xss-protection\nset value sanitizing-mode\nnext\nend\nnext\nend\nconfig waf cookie-security\nedit \"DVWA_COOKIE_SECURITY\"\nconfig cookie-security-exception-list\nedit 1\nset cookie-name APSCOOKIE*\nset wildcard enable\nnext\nedit 2\nset cookie-name shortscc\nnext\nend\nset security-mode signed\nset action alert_deny\nset severity Medium\nset secure-cookie enable\nset allow-suspicious-cookies Never\nnext\nend\nconfig waf web-protection-profile inline-protection\nedit \"DVWA_PROTECTION_PROFILE\"\nset url-access-policy DVWA_URL_ACCESS_POLICY\nset signature-rule DVWA_SIGNATURE_PROFILE\nset x-forwarded-for-rule DVWA_X_FORWARDED_FOR\nset parameter-validation-rule DVWA_PARAMETER_VALIDATION\nset hidden-fields-protection DVWA_HIDDEN_FIELD\nset allow-method-policy DVWA_ALLOW_METHOD\nset url-rewrite-policy DVWA_URL_REWRITE\nset http-authen-policy DVWA_AUTH_POLICY\nset file-upload-policy DVWA_FILE_SECURITY_POLICY\nset webshell-detection-policy DVWA_WEBSHELL_UPLOADING\nset http-protocol-parameter-restriction DVWA_PROTOCOL_CONSTRAINTS\nset ip-list-policy DVWA_IP_LIST\nset application-layer-dos-prevention DVWA_DOS_POLICY\nset geo-block-list-policy DVWA_GEO_PROTECTION\nset custom-access-policy DVWA_CUSTOM_POLICY\nset ip-intelligence enable\nset cookie-security-policy DVWA_COOKIE_SECURITY\nset profile-id 2579818973326303562\nset fortigate-quarantined-ips enable\nset csrf-protection DVWA_CSRF_PROTECTION\nset user-tracking-policy DVWA_USER_TRACKING\nset http-header-security DVWA_HEADER_SECURITY\nset bot-mitigate-policy DVWA_BOT_POLICY\nnext\nend\nconfig server-policy policy\nedit \"DVWA_POLICY\"\nset ssl enable\nset vserver DVWA_VS\nset service HTTP\nset web-protection-profile DVWA_PROTECTION_PROFILE\nset replacemsg Predefined\nset server-pool DVWA_POOL\nset https-service HTTPS\nset http-to-https enable\nset syncookie enable\nset policy-id 15841312090804693283\nset tlog enable\nnext\nend\n</code></pre>"},{"location":"download-pdf/","title":"Download this HoL in PDF format","text":"<p> Download</p>"},{"location":"hol-fwb-lab-2/","title":"Protecting Web Application Using FortiWeb","text":"<p>To begin, we will connect to the DVWA Web Application through FortiWeb.</p> Connecting to DVWA <p>This Hands-on Lab allows us to demonstrate 25+ FortiWeb protections. Let's take a closer look at FortiWeb's sequence of scans.</p> Sequence of Scans <p>The WAF policy DVWA_PROTECTION_PROFILE is already populated with protections that we will demonstrate in the next sections.</p> FortiWeb Policy <p>Throughout the Hands-On Lab, we will utilize the Attack Logs as well as FortiView to gain a comprehensive view of the activity.</p> Security Monitoring with FortiView <p>This page provides you with instructions for demonstrating various FortiWeb protections using the DVWA Application.</p> <p>Given that we have limited time for the workshops, we suggest focusing first on the protections that seem most important to us. If you have extra time, you can choose to test other features.</p> <p>Each section of this lab is independent of the others, so have fun!</p> Signatures (Known Attacks) Machine Learning Client Management X-Forwarded-For Cookie Security CSRF Protection Hidden Fields Protection File Security Web Shell Detection Let\u2019s Encrypt Certificates Allow Method Bot Mitigation Policy DoS Protection Policy URL Rewriting User Tracking <p>The remaining labs are optional and can be explored if you have extra time.</p> Custom Policy HTTP Protocol Constraints HTTP Header Security Parameter Validation Man in the Browser (MiTB) Protection URL Access HTTP Authentication IP List FortiGate Quarantined IPs GEO IP Vulnerability Scanner"},{"location":"hol-fwb-lab-2/#connecting-to-dvwa","title":"Connecting to DVWA","text":"<p>Connect to https://@PREFIX.@REGION.cloudapp.azure.com and authenticate with one of these accounts:</p> Username Password admin password gordonb abc123 1337 charley pablo letmein smithy password Troubleshooting - If you encounter any authentication issues <ul> <li> <p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/setup.php</p> </li> <li> <p>Click on Create / Reset Database</p> </li> </ul> <p></p>"},{"location":"hol-fwb-lab-2/#sequence-of-scans","title":"Sequence of Scans","text":"<p>FortiWeb applies protection rules and performs protection profile scans in the order of execution according to the following list. The second tab highlights the security features that will be demonstrated in this Hands-On Lab.</p> ProtectionsHighlights <ol> <li>TCP Connection Number Limit\u00a0(TCP Flood Prevention)</li> <li>Add X-Forwarded-For</li> <li>Client Management</li> <li>IP List</li> <li>IP Reputation</li> <li>Quarantined source IP addresses</li> <li>Known Bots</li> <li>Geo IP</li> <li>WebSocket protocol</li> <li>Add HSTS Header</li> <li>Protected Server Check</li> <li>Allow Method</li> <li>Mobile Application Identification</li> <li>HTTP Request Limit/sec\u00a0(HTTP Flood Prevention)</li> <li>TCP Connection Number Limit\u00a0(Malicious IP)</li> <li>HTTP Request Limit/sec (Shared IP)\u00a0(HTTP Access Limit)</li> <li>HTTP Authentication</li> <li>Global Object\u00a0Allow\u00a0List</li> <li>ADFS Proxy</li> <li>URL Access</li> <li>Mobile API Protection</li> <li>Padding Oracle Protection</li> <li>HTTP Protocol Constraints</li> <li>File Parse</li> <li>File Security</li> <li>Web Shell Protection</li> <li>Parameter Validation</li> <li>Bot Deception</li> <li>ML based Bot Detection</li> <li>Cross-site request forgery (CSRF)\u00a0attacks</li> <li>Protection for Man-in-the-Browser (MiTB) attacks</li> <li>Biometrics Based Detection</li> <li>XML Protection</li> <li>JSON Protection</li> <li>Signatures</li> <li>SQL/XSS Syntax Based Detection</li> <li>Site Publish</li> <li>Hidden Fields Protection</li> <li>Custom Policy</li> <li>Threshold Based Detection</li> <li>User Tracking</li> <li>API Gateway</li> <li>OpenAPI Validation</li> <li>CORS Protection</li> <li>URL Rewriting\u00a0(rewriting &amp; redirection)</li> <li>ML based API Protection</li> <li>File Compress</li> <li>Cookie Security Policy</li> <li>ML based Anomaly Detection</li> </ol> <ol> <li>TCP Connection Number Limit\u00a0(TCP Flood Prevention)</li> <li>Add X-Forwarded-For</li> <li>Client Management</li> <li>IP List</li> <li>IP Reputation</li> <li>Quarantined source IP addresses</li> <li>Known Bots</li> <li>Geo IP</li> <li>WebSocket protocol</li> <li>Add HSTS Header</li> <li>Protected Server Check</li> <li>Allow Method</li> <li>Mobile Application Identification</li> <li>HTTP Request Limit/sec\u00a0(HTTP Flood Prevention)</li> <li>TCP Connection Number Limit\u00a0(Malicious IP)</li> <li>HTTP Request Limit/sec (Shared IP)\u00a0(HTTP Access Limit)</li> <li>HTTP Authentication</li> <li>Global Object\u00a0Allow\u00a0List</li> <li>ADFS Proxy</li> <li>URL Access</li> <li>Mobile API Protection</li> <li>Padding Oracle Protection</li> <li>HTTP Protocol Constraints</li> <li>File Parse</li> <li>File Security</li> <li>Web Shell Protection</li> <li>Parameter Validation</li> <li>Bot Deception</li> <li>ML based Bot Detection</li> <li>Cross-site request forgery (CSRF)\u00a0attacks</li> <li>Protection for Man-in-the-Browser (MiTB) attacks</li> <li>Biometrics Based Detection</li> <li>XML Protection</li> <li>JSON Protection</li> <li>Signatures</li> <li>SQL/XSS Syntax Based Detection</li> <li>Site Publish</li> <li>Hidden Fields Protection</li> <li>Custom Policy</li> <li>Threshold Based Detection</li> <li>User Tracking</li> <li>API Gateway</li> <li>OpenAPI Validation</li> <li>CORS Protection</li> <li>URL Rewriting\u00a0(rewriting &amp; redirection)</li> <li>ML based API Protection</li> <li>File Compress</li> <li>Cookie Security Policy</li> <li>ML based Anomaly Detection</li> </ol>"},{"location":"hol-fwb-lab-2/#fortiweb-policy","title":"FortiWeb Policy","text":"<p>Log in to the FortiWeb GUI https://@PREFIX.@REGION.cloudapp.azure.com:40030.</p> <p>Browse to <code>Policy &gt; Web Protection Profile</code> and open DVWA_PROTECTION_PROFILE.</p> <p></p>"},{"location":"hol-fwb-lab-2/#security-monitoring-with-fortiview","title":"Security Monitoring with FortiView","text":"<p>These are the most common views to monitor your device, traffic, and security posture.</p> <p><code>Dashboard &gt; FortiView topology</code></p> <p></p> <p><code>Dashboard &gt; FortiView Countries</code></p> <p>You can drill down each Country.</p> <p></p> <p><code>Dashboard &gt; FortiView Threats</code></p> <p>You can drill down each Threat.</p> <p></p> <p><code>Dashboard &gt; FortiView Countries</code></p> <p>You can drill down each Source IP.</p> <p></p> <p>And you can ban specific IPs.</p> <p></p> <p><code>Dashboard &gt; Blocked IPs</code></p> <p>Monitoring &amp; Releasing Ban IPs.</p> <p></p> <p><code>Dashboard &gt; Status</code> (Throughput &amp; Attack Event History)</p> <p>You can drill down each Threat Level.</p> <p></p> <p>You can also add your own monitor view. We will use them later in this document.</p> <p></p>"},{"location":"hol-fwb-lab-2/#signatures","title":"Signatures","text":"<p>FortiWeb uses signatures to detect a wide range of attacks and data leaks, covering vulnerabilities listed in the OWASP Top 10 and beyond. These include cross-site scripting, SQL injection, remote and local file inclusion, OS commands, trojans/viruses, exploits, and leaks of sensitive server information and personal data.</p>"},{"location":"hol-fwb-lab-2/#configuration","title":"Configuration","text":"<p><code>Web Protection &gt; Known Attacks &gt; Signatures</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#signature-update-management","title":"Signature Update Management","text":"<p>Make sure to approve the latest signatures.</p> <p>Browse to <code>System &gt; Config &gt; FortiGuard &gt; Signature Update Management</code> and approve all new signatures.</p> <p>Use the Shift key to select everything and approve all at once.</p> <p></p>"},{"location":"hol-fwb-lab-2/#performing-command-injection","title":"Performing Command Injection","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/ and try one of these Command Injection attacks.</p> <p><pre><code>;ls -la\n</code></pre> <pre><code>;more /etc/passwd\n</code></pre> <pre><code>;ps -aux\n</code></pre></p> <p></p> <p>Command Injection will be blocked.</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs","title":"Attack Logs","text":"<p><code>Log&amp;Report &gt; Log Access &gt; Attack</code></p> <p>Double click on the last entry.</p> <p></p>"},{"location":"hol-fwb-lab-2/#performing-sql-injection","title":"Performing SQL Injection","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/sqli/ and try this SQL Injection attack.</p> <pre><code>' OR 1=1#\n</code></pre> <p></p> <p>SQL Injection will be blocked.</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_1","title":"Attack Logs","text":"<p><code>Log&amp;Report &gt; Log Access &gt; Attack</code></p> <p>Refresh Logs and double click on the new entry.</p> <p></p> <p></p>"},{"location":"hol-fwb-lab-2/#machine-learning","title":"Machine Learning","text":"<p>The anomaly detection model of machine learning feature observes the URLs, parameters, and HTTP Method of HTTP and/or HTTPS sessions passing to your web servers. It builds mathematical models to detect abnormal traffic.</p>"},{"location":"hol-fwb-lab-2/#configuring-machine-learning","title":"Configuring Machine Learning","text":"<p>browse to <code>Policy &gt; Server Policy</code>, open <code>DVWA_POLICY</code>, go at the bottom page, and create your Machine Learning policy.</p> <p></p> <p>Enter the domain name of your application. We will be using a wildcard domain. Click OK.</p> <pre><code>*.cloudapp.azure.com\n</code></pre> <p></p> <p>Get the Machine Learning Model File and import it.</p> <p></p> <p>Browse to <code>Web Protection &gt; ML Based Anomaly Detection</code>, open the policy, and click on the domain.</p> <p></p> <p>Click on the Parameter View tab and select the ip parameter.</p> <p></p> <p>The Parameter View provides statistics associated with various parameters, including HMM learning stages, boxplots, and the distribution of anomalies. It also allows you to rebuild parameters or adjust the strictness level for anomaly detection.</p> <p>The diagram illustrates the Distribution of Anomalies. The system determines the legitimacy of a request based on its probability score and the length of the parameter value.</p> <p>Click on Test Sample.</p> These are few samples you can test Samples Examine the Probability Score and Detection Result A real IP <code>1.1.1.1</code> A typo <code>1.1.1..1</code> Another typo <code>1.1.1.1&amp;</code> An email address <code>abc@real.com</code> SQL Injection <code>'OR 1=1#</code> Zero Day <code>A 'DIV' B - A 'DIV B</code> Why FortiWeb employs two layers of machine learning? <p>FortiWeb employs a dual-layer machine learning approach to identify malicious attacks. The first layer utilizes the Hidden Markov Model (HMM) to monitor application access and collect data, which is used to build a mathematical model for each parameter and HTTP method. Once this model is established, FortiWeb assesses each incoming request against it to determine whether it is anomalous.</p> <p>If the first machine learning layer flags a request as anomalous, FortiWeb engages its second layer to further scrutinize whether it constitutes a genuine attack or is merely a benign anomaly that can be disregarded. To accomplish this, FortiWeb incorporates pre-trained threat models that utilize Support Vector Machine (SVM) technology, each representing a specific type of attack, such as SQL Injection or Cross-site Scripting. These models have been trained using data from thousands of attack samples and are consistently updated by the FortiWeb Security Service. When new types of attacks emerge, the FortiGuard team analyzes them and updates the relevant threat models. These updated models are then distributed to all customer installations, similar to how signature updates are carried out.</p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-machine-learning","title":"Testing Machine Learning","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/ and perform those 2 SQL Injections.</p> <p><pre><code>'OR 1=1#\n</code></pre> <pre><code>A 'DIV' B - A 'DIV B\n</code></pre></p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_2","title":"Attack Logs","text":"<p>The first pattern is detected by Signatures Detection and the second one by Machine Learning.</p> <p></p> <p></p> Why is the first attack blocked by signature-based protection, while the second is blocked through machine learning?\" <p>FortiWeb applies protection rules and performs profile scans in a specific order of execution as documented in FortiWeb 7.4.0 Administration Guide - Sequence of Scans. If an HTTP request matches a known signature, it will be blocked immediately without ever reaching the machine learning engine. On the other hand, for zero-day attacks where no signature is effective, the machine learning engine takes over to detect and block the attack.</p>"},{"location":"hol-fwb-lab-2/#client-management","title":"Client Management","text":"<p>Tracking a client by either the recognized cookie or the source IP, FortiWeb's client management feature identifies suspected attacks based on the clients. When a client triggers a threat, FortiWeb accumulates the threat score based on the configured threat weight value. When the client's threat score reaches a certain threshold, a corresponding blocking action is performed. To identify a visiting client, FortiWeb generates a unique client ID according to the cookie value or source IP.</p>"},{"location":"hol-fwb-lab-2/#configuration_1","title":"Configuration","text":"<p><code>Policy &gt; Client Management</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#monitoring-clients-activities","title":"Monitoring Clients\u2019 activities","text":"<p><code>Dashboard &gt; +</code></p> <p></p> <p><code>Dashboard &gt; Client Management</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#x-forwarded-for","title":"X-Forwarded-For","text":"<p>In some topologies, you must configure FortiWeb to add X-headers such as:</p> <ul> <li>X-Forwarded-For</li> <li>X-Real-IP</li> <li>True-Client-IP</li> </ul> <p>The X-Forwarded-For (XFF) HTTP header field is a common method for identifying the originating IP address of a client connecting to a web server through an HTTP proxy or load balancer.</p>"},{"location":"hol-fwb-lab-2/#configuration_2","title":"Configuration","text":"<p>Server Objects &gt; X-Forwarded-For</p> <p></p>"},{"location":"hol-fwb-lab-2/#checking-http-header-informations","title":"Checking HTTP header information\u2019s","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/phpinfo.php and check if you can see your client public IP.</p> <p></p>"},{"location":"hol-fwb-lab-2/#cookie-security","title":"Cookie Security","text":"<p>This protection prevents cookie-based attacks. A Cookie Security policy can:</p> <ul> <li>detect cookie poisoning</li> <li>encrypt or sign the cookies issued by the back-end servers</li> <li>add security attributes to cookies</li> </ul>"},{"location":"hol-fwb-lab-2/#configuration_3","title":"Configuration","text":"<p>On FortiWeb browse to <code>Web Protection &gt; Cookie Security</code> and open DVWA_COOKIE_SECURITY.</p> <p></p>"},{"location":"hol-fwb-lab-2/#preventing-cookie-poisoning-by-tracking-the-cookie-value","title":"Preventing cookie poisoning by tracking the cookie value","text":"<p>Browse to  https://@PREFIX.@REGION.cloudapp.azure.com/security.php</p> <p>Right click the page and select Inspect, go to Storage (Firefox) or Application (Chrome, Edge) and select Cookies.</p> <p></p> <p>The security level of the DVWA application (Impossible, High, Medium, Low) is stored in a cookie.</p> <p>First, we'll change the security level using the legitimate method. From the web page, select Medium and click Submit. You'll notice that your security level has changed.</p> <p></p> <p>Now, let's explore how to change our security level by manipulating the cookie named security. From the Inspect view, change its value to high and reload the page.</p> <p> </p>"},{"location":"hol-fwb-lab-2/#attack-logs_3","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#preventing-cookie-poisoning-with-cookie-encryption","title":"Preventing cookie poisoning with cookie encryption","text":"<p>We just employed the Signed Security Mode to prevent tampering by tracking the cookie value. </p> <p>We are now transitioning to the Encrypted Security Mode. This feature encrypts the cookie values sent by the back-end web server to clients, ensuring that clients only see encrypted cookies. FortiWeb automatically decrypts cookies submitted by clients before forwarding them to the back-end server, eliminating the need for any back-end server configuration changes.</p> <p>On FortiWeb , browse to <code>Web Protection &gt; Cookie Security</code> and open DVWA_COOKIE_SECURITY.</p> <p>Change the Security Mode to Encrypted and click OK.</p> <p></p> <p>Delete those 3 cookies:</p> <ul> <li>cookiesession1</li> <li>PHPSESSID</li> <li>security</li> </ul> <p></p> <p>Reload DVWA page.</p> <p>The cookies are now encrypted. You can try again to change the security cookie value and reload the page. What's happening? Check the Attack Logs.</p> <p></p>"},{"location":"hol-fwb-lab-2/#preventing-client-side-scripts-from-accessing-the-cookie","title":"Preventing client-side scripts from accessing the cookie","text":"<p>DVWA's cookies (PHPSESSID and security) are set to Secure and HTTPOnly. The other cookies are not because they belong to FortiWeb which is not part of the policy.</p> <p></p> <p>A Secure cookie is a cookie that is only transmitted over HTTPS (Secure HTTP) connections. When a cookie is marked as \"secure,\" it tells the browser that the cookie should only be sent with requests to HTTPS URLs, thereby reducing the risk of exposing sensitive data in clear text over an insecure network. This attribute is particularly important for cookies that store sensitive information like authentication tokens or session identifiers.</p> <p>An HTTP Only cookie is a type of web cookie that is only accessible by the server and not by client-side scripts. This attribute is set by the server when sending the cookie to the client, and it helps to mitigate the risk of cross-site scripting (XSS) attacks. When a cookie has the HttpOnly flag set, it means that the cookie cannot be accessed through client-side languages like JavaScript, making it more secure against certain types of web vulnerabilities.</p> <p>Go to the Browser Console and type <code>document.cookie</code>.</p> <p></p> <p>The output displays only those cookies that have the HTTP Only attribute set to false. Client-side scripts cannot access cookies that are marked as HTTP Only.</p> <p>On FortiWeb browse to <code>Web Protection &gt; Cookie Security</code>, open DVWA_COOKIE_SECURITY and disable HTTP Only.</p> <p></p> <p>Clear your browser's cache (or remove cookies from the browser's Inspect Element window).</p> <p>Browse to  https://@PREFIX.@REGION.cloudapp.azure.com.</p> <p>Check that PHPSESSID and security have HTTP Only disabled.</p> <p></p> <p>Go to the Browser Console and type <code>document.cookie</code>.</p> <p></p> <p>You are now able to execute a script that shows cookies. There is no FortiWeb\u2019s log since this is a Browser Cookie Security enforcement.</p>"},{"location":"hol-fwb-lab-2/#csrf-protection","title":"CSRF Protection","text":"<p>Cross-Site Request Forgery (CSRF) is a type of security vulnerability that dupes a web browser into executing an undesired action within an authenticated application.</p> <p>The attack usually involves deceptive social engineering tactics, such as sending a misleading email or link to the victim. Because the user is already authenticated within the application when the attack occurs, it becomes challenging to differentiate between legitimate and fraudulent requests.</p>"},{"location":"hol-fwb-lab-2/#configuration_4","title":"Configuration","text":"<p><code>Web Protection &gt; Advanced Protection &gt; CSRF Protection</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#preventing-cross-site-request-forgery","title":"Preventing cross-site request forgery","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/csrf/ and change the admin password.</p> <p>You should see a token (tknfv) in the URL that has been added by FortiWeb, meaning that the request is protected and allowed.</p> <p></p> <p>You can log out and then log in again with your new password.</p> <p>Make sure you are authenticated to DVWA and browse to this demo page to generate the attack.</p> <p>The aforementioned page employs Cross-Site Request Forgery to exploit your authenticated session in order to initiate a password change.</p> <p></p> <p>Right-click and choose Inspect on the web page to reveal the hidden link.</p> <p>You can log out and then log in again: your password has not been changed.</p>"},{"location":"hol-fwb-lab-2/#attack-logs_4","title":"Attack Logs","text":"<p>The password change has been blocked by FortiWeb.</p> <p></p> Reseting the database for the next Labs <ul> <li>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/setup.php</li> <li>Click on Create / Reset Database</li> <li>You can now login with the original password</li> </ul> <p></p>"},{"location":"hol-fwb-lab-2/#hidden-fields-protection","title":"Hidden Fields Protection","text":"<p>Hidden form inputs are often written into an HTML page by the web server when it serves that page to the client and are not visible on the rendered web page. Because HTTP is essentially stateless, like cookies, hidden form inputs are one way that web applications can use to remember session data from one page request to the next (called \u201cpersistence\u201d).</p> <p>Since they are not rendered visible, hidden inputs are sometimes erroneously perceived as safe. But like session cookies, hidden form inputs store the software\u2019s state information client-side, instead of server-side. This makes it vulnerable.</p>"},{"location":"hol-fwb-lab-2/#configuration_5","title":"Configuration","text":"<p><code>Web Protection &gt; Input Validation &gt; Hidden Fields</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-hidden-field-protection","title":"Testing hidden field protection","text":"<p>Download those small and large images to your computer:</p> <ul> <li>Small file (14 Ko)</li> <li>Large file (433 Ko)</li> </ul> <p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload and upload both images.</p> <p>You may upload images smaller than 100 KB, but uploading images larger than 100 KB is not allowed.</p> <p></p> <p>Uploading images larger than 100 KB is not allowed.</p> <p>Right click the page, select Inspect, go to Inspector tab (Firefox) or Element tab (Chrome, Edge) and find the MAX_FILE_SIZE hidden form.</p> <p></p> <p>Change the value to 500,000 and try to upload the large image again. The request is blocked.</p>"},{"location":"hol-fwb-lab-2/#attack-logs_5","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#file-security","title":"File Security","text":"<p>You can configure FortiWeb to perform the following tasks:</p> <ul> <li>Restrict file uploads based upon file type and size</li> <li>Scan uploaded files for viruses</li> <li>Submit uploaded files to FortiSandbox or FortiNDR</li> </ul>"},{"location":"hol-fwb-lab-2/#configuration_6","title":"Configuration","text":"<p><code>Web Protection &gt; Input Validation &gt; File Security</code></p> <p></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-file-security","title":"Testing file security","text":"<p>Download https://secure.eicar.org/eicar_com.zip on your computer.</p> <p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/ and upload eicar_com.zip.</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_6","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#web-shell-detection","title":"Web Shell Detection","text":"<p>Attackers may attempt to upload Trojan horse code (written in scripting languages such as PHP and ASP) to the back-end web servers. The Trojan then infects clients who access an infected web page.</p>"},{"location":"hol-fwb-lab-2/#configuration_7","title":"Configuration","text":"<p><code>Web Protection &gt; Input Validation &gt; Web Shell Detection</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-web-shell-detection","title":"Testing Web Shell detection","text":"<p>First you need to disable Antivirus Scan as this may overlap Web Shell detection.</p> <p>Browse to <code>Web Protection &gt; Input Validation &gt; File Security</code>, open DVWA_FILE_SECURITY_POLICY and disable Antivirus Scan.</p> <p></p> <p>Download a Webshell on Github: https://raw.githubusercontent.com/tennc/webshell/master/php/wso/wso.php</p> <p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/ and upload wso.php.</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_7","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#lets-encrypt-certificates","title":"Let\u2019s Encrypt Certificates","text":"<p>Let's Encrypt certificates are free and valid for 90 days, during which renewal can take place at any time. This is handled by an automated process designed to overcome manual creation, validation, signing, installation, and renewal of certificates for secure websites.</p>"},{"location":"hol-fwb-lab-2/#configuration_8","title":"Configuration","text":"<p><code>Server Objects &gt; Certificates &gt; Let's Encrypt</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#generating-a-new-lets-encrypt-certificate","title":"Generating a new Let\u2019s Encrypt certificate","text":"<p>Until now we have connected to the application with the default certificate.</p> <p></p> <p></p> <p>Let\u2019s configure FortiWeb to automatically obtain (and renew) a certificate from Let's encrypt.</p> <p>For this lab, we need to temporarily shutdown FWB-B. It's crucial that the Primary member, FWB-A, which manages the configuration, is also the one handling the traffic. This is because the Let's Encrypt procedure relies on a challenge mechanism. If FWB-A sets up a challenge, but Let's Encrypt connects to FWB-B to verify it, the certificate generation will fail.</p> <p>You can turn FWB-B back on after completing this lab.</p> <p>Browse to <code>Server Objects &gt; Certificates &gt; Let's Encrypt</code> and check that the domain is correct.</p> <p></p> <p>Browse to <code>Policy &gt; Server Policy</code>, open DVWA_POLICY, choose Let's Encrypt option and select DVWA_LE_CERTIFICATE.</p> <p></p> <p>Go back to <code>Server Objects &gt; Certificates &gt; Let's Encrypt</code> and click on Issue (1).</p> <p>Be patient and avoid clicking on Issue multiple times. Refresh the page to check for status updates. You can also view the Event Logs to monitor the progress of the process.</p> <p>After an average of 30 seconds, the Status (2) should be green.</p> <p></p> <p>Close and open your browser.</p> <p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com.</p> <p>Now you should have a valid certificate.</p> <p></p>"},{"location":"hol-fwb-lab-2/#event-logs","title":"Event Logs","text":"<p>Check the Event Logs.</p> <p></p>"},{"location":"hol-fwb-lab-2/#allow-method","title":"Allow Method","text":"<p>You can configure policies that allow only specific HTTP request methods. This can be useful for preventing attacks, such as those exploiting the HTTP method TRACE.</p> <p>Many web applications only require GET and POST. Disabling all unused methods reduces the potential attack surface area for attackers.</p>"},{"location":"hol-fwb-lab-2/#configuration_9","title":"Configuration","text":"<p><code>Web Protection &gt; Access &gt; Allow Method</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-allow-method","title":"Testing Allow Method","text":"<p>This lab is only compatible with Firefox.</p> <ul> <li> <p>Open Firefox and Browse to https://@PREFIX.@REGION.cloudapp.azure.com</p> </li> <li> <p>Right-click anywhere on the page and select \"Inspect\" or press F12</p> </li> <li> <p>Click on the Network tab (1).</p> </li> <li> <p>Reload the page by pressing F5 or clicking the reload icon (2) in the toolbar.</p> </li> <li> <p>Choose any request, right-click on it, and select Edit and Resend (3).</p> </li> <li> <p>In the new panel on the left, there is a dropdown menu for selecting the HTTP method (4). Click the dropdown arrow and select HEAD as the HTTP method you want to use for this request.</p> </li> <li> <p>Click the Send button (5) to resend the request with the modified HTTP method.</p> </li> </ul> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_8","title":"Attack logs","text":""},{"location":"hol-fwb-lab-2/#bot-mitigation-policy","title":"Bot Mitigation Policy","text":"<p>To quickly protect websites, mobile apps and APIs from automated threats, you can configure the bot mitigation feature to check more specific signatures such as client events, and occurrence of suspicious behaviors, etc. of regular clients.</p>"},{"location":"hol-fwb-lab-2/#configuration_10","title":"Configuration","text":"<p><code>Bot Mitigation &gt; Bot Mitigation Policy</code></p> <p>Bot Mitigation Policy protects from automated threats with different methods:</p> <p></p> Detection Method Description Bot Deception Inserts invisible links in HTML responses to distinguish between regular clients and malicious bots like web crawlers. Biometrics-based Detection Uses client events like mouse movement and keyboard activity to determine whether a request is coming from a human or a bot. Threshold-based Detection Sets rules based on occurrence, time period, and severity of suspicious behavior to assess whether a request is human or bot-generated. Known Bots Protects against malicious bots like DoS and spam, while allowing known good bots like search engines."},{"location":"hol-fwb-lab-2/#testing-bot-deception","title":"Testing Bot Deception","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/login.php, right click and select \u201cView Page Source\u201d.</p> <p></p> <p>There\u2019s a hidden link. Malicious bots like web crawler may request the link\u2026</p> <p>Click on it or Browse to https://@PREFIX.@REGION.cloudapp.azure.com/fake_url.php.</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_9","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#dos-protection-policy","title":"DoS Protection Policy","text":"<p>You can protect your web assets from a wide variety of denial of service (DoS) attacks.</p> <p>DoS features are organized by which open system interconnections (OSI) model layer they use primarily to apply the rate limit:</p> <ul> <li>Application layer (HTTP or HTTPS)</li> <li>Network and transport layer (TCP/IP)</li> </ul>"},{"location":"hol-fwb-lab-2/#configuration_11","title":"Configuration","text":"<p><code>DoS Protection &gt; DoS Protection Policy</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-dos-http-flood","title":"Testing DoS HTTP Flood","text":"<p>For this test, HTTP request limit / sec is set very low (5 instead of default 500).</p> <p>Go to any page and refresh very quickly with F5. Alternatively, hold down SHIFT button and click the Reload button several times.</p> <p>Go to Attack Logs.</p>"},{"location":"hol-fwb-lab-2/#attack-logs_10","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#url-rewriting","title":"URL Rewriting","text":"<p>URL rewriting can prevent the disclosure of underlying technology or website structures to HTTP clients.</p> <p>Aside from security reasons, rewriting and redirects can be for aesthetic or business purposes, too.</p>"},{"location":"hol-fwb-lab-2/#configuration_12","title":"Configuration","text":"<p><code>Application Delivery &gt; URL Rewriting</code></p> <p></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-url-rewrite-301-redirect","title":"Testing URL Rewrite (301 Redirect)","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/fortinet</p> <p>You will be redirected to www.fortinet.com.</p>"},{"location":"hol-fwb-lab-2/#testing-url-rewrite-rewrite-http-header","title":"Testing URL Rewrite (Rewrite HTTP Header)","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com and authenticate.</p> <p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/change.</p> <p>You will be redirected to /vulnerabilities/csrf/ page.</p> <p></p>"},{"location":"hol-fwb-lab-2/#traffic-logs","title":"Traffic logs","text":""},{"location":"hol-fwb-lab-2/#user-tracking","title":"User Tracking","text":"<p>The user tracking feature allows you to track sessions by user and capture a username for reference in traffic and attack log messages.</p>"},{"location":"hol-fwb-lab-2/#configuration_13","title":"Configuration","text":"<p><code>Tracking &gt; User Tracking</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-user-tracking","title":"Testing User Tracking","text":"<p>Login to DVWA with any username...</p> Username Password admin password gordonb abc123 1337 charley pablo letmein smithy password <p>...and perform any attack in the list:</p> URL Attack pattern /vulnerabilities/exec/ <code>;ls</code> /vulnerabilities/sqli/ <code>\u2018OR 1=1#</code> CSRF The page will exploit CSRF attack /vulnerabilities/upload/ Change the hidden field MAX_FILE_SIZE and reload the page (F5) /security.php Change security cookie value to medium and reload the page (F5) /vulnerabilities/upload/ Upload eicar.zip"},{"location":"hol-fwb-lab-2/#attack-logs_11","title":"Attack Logs","text":"<p>Browse to Attack Logs and right click a column heading to select the columns to display. Choose Username and Apply.</p> <p></p> <p>The Username will be the last column, but you can move it to the left.</p> <p></p>"},{"location":"hol-fwb-lab-2/#custom-policy","title":"Custom Policy","text":"<p>Custom rules provide a degree of flexibility for complex conditions. You can combine any or all of these criteria:</p> <p></p>"},{"location":"hol-fwb-lab-2/#configuration_14","title":"Configuration","text":"<p>Example #1 \u2013 Detecting Vulnerability Scanning</p> <p></p> <p>Example #2 \u2013 Detecting Brute Force Login</p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-vulnerability-scanning","title":"Testing Vulnerability Scanning","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/sqli/ and submit <code>\u2018or 1=1#</code> 11 times.</p> <p></p> <p>FortiWeb blocks SQL injection for the first 10 requests and quarantine the IP at the 11<sup>th</sup> request.</p> <p></p> <p>Check the blocked IPs and release it for the next test.</p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-brute-force-attack","title":"Testing brute force attack","text":"<p>Try to login 20 times very quickly with user \u201cp\u201d and no password. You can also reduce the configuration to 3 occurrences for testing purpose. Don\u2019t forget to configure it back to 20 after your test.</p> <p>After few requests, FortiWeb enforces a CAPTCHA to check if this is a bot or not. You can put a wrong answer to simulate a bot activity.</p> <p></p> <p></p> <p>Check the blocked IPs and release it for the next test.</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_12","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#http-protocol-constraints","title":"HTTP Protocol Constraints","text":"<p>Protocol constraints govern features such as the HTTP header fields in the protocol itself, as well as the length of the HTML, XML, or other documents or encapsulated protocols carried in the HTTP body payload.</p> <p>Use protocol constraints to prevent attacks such as buffer overflows. Buffer overflows can occur in web servers and applications that do not restrict elements of the HTTP protocol to acceptable lengths, or that mishandle malformed requests. Such errors can lead to security vulnerabilities.</p>"},{"location":"hol-fwb-lab-2/#configuration_15","title":"Configuration","text":"<p><code>Web Protection &gt; Protocol &gt; HTTP</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#performing-duplicate-name-attack","title":"Performing duplicate name attack","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/brute/?username=admin&amp;username=admin&amp;password=password&amp;Login=Login#</p>"},{"location":"hol-fwb-lab-2/#attack-logs_13","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#http-header-security","title":"HTTP Header Security","text":"<p>HTTP response security headers are a set of standard HTTP response headers proposed to prevent or mitigate known XSS, clickjacking, and MIME sniffing security vulnerabilities. These response headers define security policies to client browsers so that the browsers avoid exposure to known vulnerabilities when handling requests.</p> <p>When FortiWeb's HTTP Security Headers feature is enabled, headers with specified values are inserted into HTTP responses coming from the backend web servers. This is a quick and simple solution to address the security vulnerabilities on your website without code and configuration changes. The following includes the security headers that FortiWeb can insert into responses:</p> <pre><code>X-Frame-Options: DENY\nX-Frame-Options: SAMEORIGIN\nX-Frame-Options: ALLOW-FROM\nX-Content-Type-Options: nosniff\nX-XSS-Protection: 1\nX-XSS-Protection: 1; mode=block\nContent-Security-Policy: default-src 'self'\nFeature-Policy: microphone 'none'; geolocation 'none'\nReferrer-Policy: no-referrer\nReferrer-Policy: no-referrer-when-downgrade\nReferrer-Policy: same-origin\nReferrer-Policy: origin\nReferrer-Policy: strict-origin\nReferrer-Policy: origin-when-cross-origin\nReferrer-Policy: strict-origin-when-cross-origin\nReferrer-Policy: unsafe-url\n</code></pre>"},{"location":"hol-fwb-lab-2/#configuration_16","title":"Configuration","text":"<p>Web Protection &gt; Advanced Protection &gt; HTTP Header Security</p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-http-header-security","title":"Testing HTTP Header Security","text":"<p>Right click on the Web page, select Inspect, select Network tab, browse to https://@PREFIX.@REGION.cloudapp.azure.com, reload the page, select the first entry, search for Response Header and find the 3 X-Headers.</p> <p></p>"},{"location":"hol-fwb-lab-2/#parameter-validation","title":"Parameter Validation","text":"<p>You can configure rules to validate parameters (input) of your web applications.</p> <p>For example, one web page might have an HTML form with multiple inputs, including:</p> <ul> <li>A username</li> <li>A password</li> <li>A preference for whether or not to remember the login</li> </ul> <p>Within the input rule for that web page, you can define separate rules for each parameter in the request: one rule for the username parameter, one rule for the password parameter, and one rule for the preference parameter. You can use the password rule to enforce password complexity by requiring it to match a\u00a0Level 2 Password\u00a0data type.</p>"},{"location":"hol-fwb-lab-2/#configuration_17","title":"Configuration","text":"<p><code>Web Protection &gt; Input Validation &gt; Parameter Validation</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-parameter-validation","title":"Testing parameter validation","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/. In the <code>Enter an IP address</code> form enter a random string that is not an IP.</p> <p>You\u2019re not blocked because the rule action is Alert.</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_14","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#man-in-the-browser-mitb-protection","title":"Man in the Browser (MiTB) Protection","text":"<p>The Man-in-the-Browser (MiTB) attack uses Trojan Horse to intercept and manipulate calls between the browser and its security mechanisms or libraries on-the-fly. The Trojan Horse sniffs or modifies transactions as they are formed on the browser, but still displays back the user's intended transaction. The most common objective of this attack is to cause financial fraud by manipulating transactions of Internet Banking systems, even when other authentication factors are in use.</p> <p>To protect the user inputs from being attacked by MiTB, FortiWeb implements security rules including obfuscation, encryption, anti-keylogger, and Ajax request allow list.</p>"},{"location":"hol-fwb-lab-2/#configuration_18","title":"Configuration","text":"<p><code>Web Protection &gt; Advanced Protection &gt; Man in the Browser Protection</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-mitb","title":"Testing MitB","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/brute/</p> <p>Right click the page, select Inspect, go to Inspector tab (Firefox) or Element tab (Chrome, Edge) and find the username / password form.</p> <p></p> <p>Now go to the web protection profile configuration.</p> <p><code>Policy &gt; Web Protection Profile &gt; DVWA_PROTECTION_PROFILE</code></p> <p>The \u201cMan in the Browser Protection\u201d setting should be empty. Select DVWA_PROTECTION_PROFILE and click OK.</p> <p></p> <p>Refresh your browser. The form is now protected with MitB.</p> <p></p>"},{"location":"hol-fwb-lab-2/#url-access","title":"URL Access","text":"<p>URL access rules define which HTTP requests FortiWeb accepts or denies based on:</p> <ul> <li>Host name</li> <li>URL</li> <li>Origin of the request.</li> </ul>"},{"location":"hol-fwb-lab-2/#configuration_19","title":"Configuration","text":"<p>Web Protection &gt; Access &gt; URL Access</p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-url-access","title":"Testing URL Access","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/about.php</p> <p></p>"},{"location":"hol-fwb-lab-2/#attack-logs_15","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#http-authentication","title":"HTTP Authentication","text":"<p>FortiWeb can authenticate browsers before they are permitted to access a web page.</p>"},{"location":"hol-fwb-lab-2/#configuration_20","title":"Configuration","text":"<p><code>User &gt; Local User</code></p> <p></p> <p><code>User &gt; User Group &gt; User Group</code></p> <p></p> <p><code>Application Delivery &gt; Authentication</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-authentication","title":"Testing authentication","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/instructions.php.</p> <p>Authenticate with username <code>demo</code>, password <code>demo</code>.</p> <p></p>"},{"location":"hol-fwb-lab-2/#ip-list","title":"IP List","text":"<p>You can define which source IP addresses are trusted clients, undetermined, or distrusted.</p>"},{"location":"hol-fwb-lab-2/#configuration_21","title":"Configuration","text":"<p><code>IP Protection &gt; IP List</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-ip-list","title":"Testing IP List","text":"<p>Browse to https://@PREFIX.@REGION.cloudapp.azure.com/phpinfo.php.</p> <p>Copy your public IP located in <code>HTTP Headers Information &gt; X-Forwarded-For</code></p> <p></p> <p>On FortiWeb, Browse to <code>IP Protection &gt; IP List</code> and add your public IP in the Block IP List.</p> <p></p> <p>Refresh your page on DVWA. You should be blocked.</p> <p></p> <p>Warning</p> <p>Remove your IP from the list!</p>"},{"location":"hol-fwb-lab-2/#attack-logs_16","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#fortigate-quarantined-ips","title":"FortiGate Quarantined IPs","text":"<p>FortiGate can maintain a list of source IPs that it prevents from interacting with the network and protected systems. You can configure FortiWeb to receive this list of IP addresses at intervals you specify. You can then configure an inline protection profile to detect the IP addresses in the list and take an appropriate action.</p>"},{"location":"hol-fwb-lab-2/#configuration_22","title":"Configuration","text":"<p><code>System &gt; Config &gt; FortiGate Integration</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-fortigate-integration","title":"Testing FortiGate integration","text":"<p>On FortiWeb browse to <code>System &gt; Config &gt; FortiGate Integration</code> and change the admin credentials with yours.</p> <p>On FortiGate browse to <code>Dashboard &gt; Quarantine Monitor</code> and manually add a Ban IP.</p> <p></p> <p></p> <p>On FortiWeb browse to <code>Dashboard &gt; Blocked IPs</code>. You should see the new IP received from FortiGate.</p>"},{"location":"hol-fwb-lab-2/#geo-ip","title":"GEO IP","text":"<p>While numerous websites have a global reach, some are region-specific. For instance, government web applications often cater exclusively to their own residents.</p>"},{"location":"hol-fwb-lab-2/#configuration_23","title":"Configuration","text":"<p><code>IP Protection &gt; Geo IP</code></p> <p></p>"},{"location":"hol-fwb-lab-2/#testing-geo-ip","title":"Testing Geo IP","text":"<p>browse to <code>IP Protection &gt; Geo IP</code> and add Canada as new Country to block.</p> <p></p> <p>Now try to go on DVWA; you should be blocked.</p> <p></p> <p>Warning</p> <p>Remove Canada from the list!</p>"},{"location":"hol-fwb-lab-2/#attack-logs_17","title":"Attack Logs","text":""},{"location":"hol-fwb-lab-2/#vulnerability-scanner","title":"Vulnerability Scanner","text":"<p>You can scan your web servers for known vulnerabilities, which helps you design protection profiles.</p>"},{"location":"hol-fwb-lab-2/#configuration_24","title":"Configuration","text":"<p>Web Vulnerability Scan &gt; Scan Profile</p> <p></p>"},{"location":"hol-fwb-lab-2/#performing-a-scan","title":"Performing a scan","text":"<p>Open a browser to DVWA, authenticate and copy the PHPSESSID cookie value.</p> <p></p> <p>On FortiWeb browse to <code>Web Vulnerability Scan &gt; Scan Profile</code> and configure the Customer Headers as follow with your <code>PHPSESSID</code> value.</p> <pre><code>Cookie: security=low; PHPSESSID=evgihu3t04ht0tj5agcin4vec1\n</code></pre> <p></p> <p>Click OK.</p> <p>browse to <code>Web Vulnerability Scan &gt; Web Vulnerability Scan Policy</code> and run the scan.</p> <p></p> <p>Check the logs.</p> <p></p> <p>browse to <code>Scan History</code>, select a line and click on Download.</p> <p></p> <p>Download the XML report.</p> <p></p> <p>browse to <code>Scanner Integration</code> and import the XML report.</p> <p></p> <p>You can choose to mitigate a found vulnerability.</p> <p></p>"},{"location":"hol-nsg-fgt-lab-1/","title":"Protecting Web Application Using Azure Network Security Groups and FortiGate","text":""},{"location":"hol-nsg-fgt-lab-1/#accessing-dvwa-via-nsgs","title":"Accessing DVWA via NSG's","text":"<p>The first step in this exercise will be to create a Network Security Group and associate it to the subnet where the DVWA instance is deployed.</p> <p>Tip</p> <p>Click on the images to view them in a larger format.</p> Creating a Network Security Group <p>In the search bar type Network Security Groups, and select the non-classic option.</p> <p></p> <p>Create a new Security Group.</p> <p></p> <p>Select the Resource Group @RESOURCE_GROUP_NAME and give the Network Security Group a unique name.</p> <p>Review +Create the Resource.</p> <p></p> <p>Once created, Click on Go to Resource to be redirected to your newly created NSG.</p> <p></p> <p>Navigate to the Inbound Security Rules menu Item.</p> <p></p> <p>Create new entries to allow HTTP, HTTPS, SSH services from any sources.</p> AllowAnyHTTPInbound AllowAnyHTTPSInbound AllowAnySSHInbound Source = Any  Source Port = Any  Destination = Any  Service = HTTP  Action = Allow Source = Any  Source Port = Any  Destination = Any  Service = HTTPS  Action = Allow Source = Any  Source Port = Any  Destination = Any  Service = SSH  Action = Allow <p></p> <p>Once you've created the corresponding rules, you'll see your rules, in addition to the rules Azure had implicitely configured:</p> <p></p> <p>Navigate to the Subnets menu and Associate the Network security group to the DMZProtectedA  Subnet.</p> <p></p> <p></p> Testing your Network Security Group <p>In Azure CLI, print your deployment Outputs and click on http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com</p> <pre><code>az deployment group show -g @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n</code></pre> <p></p> <p>Log in to DVWA using the credentials admin and password.</p> <p></p> <p>Navigate to the SQL Injection menu item and type:</p> <pre><code>' OR 1=1#\n</code></pre> <p></p> <p>Notice the attack was not prevented.</p> <p></p> <p>Why? After the NSG permitted access to the DVWA Workload on Port 80 (HTTP) no subsequent inspection occured.</p>"},{"location":"hol-nsg-fgt-lab-1/#accessing-dvwa-via-fortigate","title":"Accessing DVWA via FortiGate","text":"<p>Now, we will execute the same attack, but this time, we will secure the DVWA Workload behind the FortiGate Firewall.</p> Testing SQL Injection Attack <p>Log in to the Primary FortiGate using the credentials you established during deployment.</p> <pre><code>az deployment group show -g  @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n</code></pre> <p></p> <p>Once logged in to the FortiGate, edit the firewall policy named DVWA-HTTP-Inbound_Access. Enable all the security profiles with their default settings.</p> <p></p> <p>Click OK to apply the changes.</p> <p>Browse again to http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/sqli/ and enter this SQL injection attack into the form.</p> <pre><code>' OR 1=1#\n</code></pre> <p></p> <p>Notice that the page is hung.</p> <p>Let's dive deeper and look at the FortiGate's Log. Open the Security Events, select the Logs tab and use the Intrusion Prevention filter.</p> <p></p> <p>Why was this attack dropped? The attack triggered a signature set to block within the FortiGate's IPS Security Profile.</p> Testing Command Injection Attack <p>Now lets try a Command Injection attack.</p> <p>Browse to http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/exec/ and enter this Command injection attack into the form.</p> <pre><code>;ps aux\n</code></pre> <p></p> <p>Why was the attack let through? The attack did not match a known IPS signature. Let's enhance the capabilities of the FortiGate by activating the Web Application Firewall security profile.</p> Enable WAF on FortiGate <p>Enable the Web Application Firewall Security Profile from <code>System -&gt; Feature Visibility</code></p> <p></p> <p>Once enabled, go back to the Firewall Policy and edit the DVWA-HTTP-Inbound_Access Firewall Policy.</p> <p>Toggle the Inspection Mode to Proxy-Based and enable the default Web Application Firewall Security Profile.</p> <p></p> <p>Browse to http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/exec/ and enter the Command injection attack again.</p> <pre><code>;ps aux\n</code></pre> <p>The Command Injection should now be prevented.</p> <p></p> <p>The attack is blocked because WAF signatures have been activated.</p> Conclusion <p>Did you notice that all of the attacks stopped by the FortiGate were all stopped based on existing signatures?</p>"},{"location":"hol-nsg-fgt-lab-1/#demonstrating-non-signature-based-attacks-via-fortigate","title":"Demonstrating non-signature based attacks via FortiGate","text":"<p>In this section, we will demonstrate various web application attacks to showcase and highlight the significance of the protections the Fortiweb will bring when compared to it's Next Generation Firewall counterpart.</p>"},{"location":"hol-nsg-fgt-lab-1/#csrf-attack-via-fortigate","title":"CSRF Attack via FortiGate","text":"What is Cross site request forgery (CSRF) attack? <p>Cross-Site Request Forgery (CSRF) is a type of security vulnerability that dupes a web browser into executing an undesired action within an authenticated application.</p> <p>The attack usually involves deceptive social engineering tactics, such as sending a misleading email or link to the victim. Because the user is already authenticated within the application when the attack occurs, it becomes challenging to differentiate between legitimate and fraudulent requests.</p> <p></p> Authenticating to the Web Application <p>To successfully run the CSRF Attack, you must first authenticate yourself within the application.</p> <p>Browse to http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com and log in using the username admin and password password.</p> Troubleshooting - If you encounter any authentication issues <ul> <li> <p>Browse to http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/setup.php</p> </li> <li> <p>Click on Create / Reset Database</p> </li> </ul> <p></p> Executing CSRF Attack <p>Once authenticated to DVWA, click on the LINK bellow to generate the attack.</p> Dear user,  All Hotmail customers have been upgraded to Outlook.com. Your Hotmail Account services has expired.  Due to our new system upgrade to Outlook. In order for it to remain active  follow the LINK Sign in Re-activate your account to Outlook.  Thanks,  The Microsoft account team <p>The link employs Cross-Site Request Forgery to exploit your authenticated session in order to initiate a password change.</p> <p></p> <p>Your password has been changed without your knowledge.</p> <p>Logout of DVWA and Log back in using <code>admin:pwned</code></p> Reseting the database for the next Lab <ul> <li>Browse to http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/setup.php</li> <li>Click on Create / Reset Database</li> <li>You can now login with the original password</li> </ul> <p></p> Conclusion <p>We have observed that FortiGate provides an additional layer of protection compared to NSGs, thanks to its WAF signatures. However, we can see that more advanced attacks like CSRF are not addressed by FortiGate.</p>"},{"location":"hol-nsg-fgt-lab-1/#cookie-poisoning-via-fortigate","title":"Cookie Poisoning via FortiGate","text":"What is Cookie Poisoning? <p>In this lab, we will delve into the world of cookies - data stored in a user's browser that is specific to a website and session. These cookies serve a variety of purposes, from tracking user behavior to personalizing the online experience. However, they are also susceptible to cookie poisoning, a form of unauthorized manipulation by attackers aiming to gain access to sensitive information or services. This is particularly concerning because cookies often contain authentication data and other sensitive details, making them a prime target for hackers. </p> Changing Security Level Through Legitimate Web App Interactions <p>Browse to @PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/security.php</p> <p>Right click the page and select Inspect, go to Storage (Firefox) or Application (Chrome, Edge) and select Cookies.</p> <p></p> <p>The security level granted to the user is stored in the cookie.</p> <p>From the Web page, select Medium and click submit. This is a legitimate action, and your security level has changed.</p> <p></p> Overriding Security Level with Malicious Cookie Manipulation <p>Instead, now change the security cookie value manually to low and reload the page.</p> <p></p> <p>Notice we were able change the DVWA's security setting by tampering with the value of the security cookie.</p>"},{"location":"hol-nsg-fgt-lab-1/#hidden-fields-manipulation-via-fortigate","title":"Hidden Fields Manipulation via FortiGate","text":"What is Hidden Fields <p>Hidden form inputs are often written into an HTML page by the web server when it serves that page to the client and are not visible on the rendered web page. Because HTTP is essentially stateless, like cookies, hidden form inputs are one way that web applications can use to remember session data from one page request to the next (called \u201cpersistence\u201d).</p> <p>Since they are not rendered visible, hidden inputs are sometimes erroneously perceived as safe. But like session cookies, hidden form inputs store the software\u2019s state information client-side, instead of server-side. This makes it vulnerable.</p> Enforcing File Size Limitations \u2013 Successfully Blocking a Large File Upload <p>Download those 2 images to your computer:</p> <ul> <li>Small Image (14Ko)</li> <li>Large Image (433Ko)</li> </ul> <p>Go to @PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/upload and upload the two images one at a time.</p> <p></p> <p>The website enforces a policy that prohibits the uploading of images larger than 100 KB. Let's see how we can bypass the policy restrictions.</p> Bypassing Policy Restrictions to Upload a Large File <p>Right click the page, select Inspect, go to Inspector tab (Firefox) or Element tab (Chrome, Edge) and find the MAX_FILE_SIZE hidden form.</p> <p></p> <p>Change the value to 500,000 and try to upload the large image again. Notice you were now able to successfully upload the larger file.</p> Conclusion <p>In summary, though the FortiGate is not inherently bound to the use of signatures, many functionalities revolving around Web Applications, IPS and AV are. This means, for attacks that do not have a corresponding signature, the FortiGate will be vulnerable to many unknown attacks.</p> <p>In the next lab, we will evaluate FortiWeb and explore how to comprehensively protect a web application.</p> <p>Info</p> <p>To view the WAF Feature Comparison between FortiWeb and FortiGate, navigate to the Reference Architecture section.</p>"},{"location":"role-play/","title":"Cloud Role Play","text":""},{"location":"role-play/#the-standard-opener","title":"The Standard Opener","text":"<p> Download Cloud Role Play #1</p>"},{"location":"role-play/#stop-me-if-youve-heard-this-one-or-what-a-hot-mesh","title":"Stop Me If You\u2019ve Heard This One\u2026\u201d OR \u201dWhat a hot mesh","text":"<p> Download Cloud Role Play #2</p>"},{"location":"start-azure-account/","title":"Accessing your Azure Account","text":"<p>This Hands-on-Lab is configured to allow each student to have their own training lab environment using pre-created Azure resource groups, all in one shared Azure Subscription.</p> Accessing the Azure Portal: Login Instructions Changing Your Password Switching Language Settings Verifying Resource Groups Launching CLI &amp; Setting Up Storage Account (mandatory)"},{"location":"start-azure-account/#accessing-the-azure-portal","title":"Accessing the Azure Portal","text":"<p>Browse to https://portal.azure.com</p> <p>Use the credentials provided to you by your instructors.</p> <p>If you can't find them, check your junk mail folder. Look for an email with the subject line: MIS - Xperts Summit - Public Cloud Track - AZURE LAB Credentials.</p> <p>Username: xpacaXX@azurestorefortinet.onmicrosoft.com</p> <p></p> <p>Password: &lt;password provided by email&gt;</p> <p></p> <p>Click to log in, and optionally select \"Yes\" to stay signed in.</p> <p></p> <p>When the Welcome to Microsoft Azure window appears, skip the tour.</p> <p></p> <p>Now that you've signed in, you are on the Azure Portal Dashboard.</p> <p>Notice your username in the top right corner.</p>"},{"location":"start-azure-account/#changing-your-password","title":"Changing Your Password","text":"<p>Click on your username located in the top-right corner of the screen.</p> <p></p> <p>Select View Account. This action will automatically open a new tab.</p> <p></p> <p>You can skip the Microsoft feedback in this new tab.</p> <p></p> <p>Scroll down, if needed, and click on Change Password.</p> <p></p> <p>Fill in the required fields to change your password and click Submit.</p> <p></p> <p>Once you see the confirmation screen, you can close this tab. Your password has been successfully changed.</p> <p></p>"},{"location":"start-azure-account/#switching-language-settings","title":"Switching Language Settings","text":"<p>If you wish to change the language of your Azure dashboard, follow these steps.</p> <p>After logging into your Azure account, click on the gear icon in the upper-right corner.</p> <p></p> <p>Next, select Language + Regional Format.</p> <p></p> <p>Choose your preferred language and regional format.</p> <p>For example, if you select \u201cEnglish (Canada),\" it will change the Dashboard language to Canadian English.</p> <p></p> <p>Click Apply. A message will appear asking for confirmation. Click OK to confirm the language change.</p> <p></p>"},{"location":"start-azure-account/#verifying-resource-groups","title":"Verifying Resource Groups","text":"<p>In a new Azure subscription account, only two resource groups will be pre-existing. These will be used in this lab for security customization.</p> <p>Navigate to Resource Groups on the main page.</p> <p></p> <p>Make sure two resource groups are displayed, prefixed with your student number.</p> <p></p>"},{"location":"start-azure-account/#launching-cli-setting-up-storage-account","title":"Launching CLI &amp; Setting Up Storage Account","text":"<p>We'll next connect to the Azure CLI, which plays a key role in facilitating automated deployments. To do this, you'll need to have a storage account configured.</p> <p>Click on the CLI Icon, found in the top-right corner.</p> <p></p> <p>This will open the CLI Shell at the bottom of the screen. Select Bash Shell.</p> <p></p> <p>Select your FTNT-Training subscription and click on Show Advanced Settings.</p> <p></p> <p>These advanced settings allow you to select existing resources. Note that the default settings may not align with where our Resource Groups are located.</p> <p>Adjust your settings to match the example below. Note: Your student number may differ.</p> <p></p> <p>You are now welcomed to the Azure Cloud Shell.</p> <p></p> <p>Congratulation! You are all set to proceed with the lab activities.</p>"},{"location":"start-deploy/","title":"Your Lab Environment","text":"<p>The accounts provided as a part of Fortinet XPERTS Academy have adjusted resource quotas to reflect the demands of this Hands on Lab. The subcription has also accepted the terms of the required marketplace offers.</p>"},{"location":"start-deploy/#deploying-your-lab-environment-in-azure","title":"Deploying your Lab Environment in Azure","text":"<p>This section will guide you through the essential steps to deploy your Lab Environment in Azure with the Fortinet Reference Architecture for Azure.</p> <p>Tip</p> <p>Click on the images to view them in a larger format.</p> Define your Prefix, Region and Ressource Groupe Name <p>Before you proceed, complete the form below to personalize your Hands-on Lab experience by setting your Prefix, Region, and Resource Group Name.</p> <p> Prefix: <p>This prefix will be applied to all resources created during this lab for easier management and identification. Your prefix will be xpacaXX where XX is your student number.</p> Region: <p>You need to choose the eastus region (Richmond, Virginia) because this is where our Lab Quota is available. Outside of this HOL session, you could select any region in Canada such as canadacentral (Toronto, Ontario) or canadaeast (Quebec City, Quebec).</p> Resource Group Name: <p>This will be the name of the Azure Resource Group where all your lab resources will be contained. Your Azure Resource Group will be xpacaXX-blueprint where XX is your student number.</p> </p> Deploy the Lab Environment with Bicep <ul> <li>Access the Azure Cloud Shell either through the Azure Portal or directly via https://shell.azure.com.</li> <li>Log into the Azure Cloud Shell.</li> <li>Run the following commands in the Azure Cloud:</li> </ul> <pre><code>az bicep upgrade\ngit clone -b xPerts-HoL https://github.com/AJLab-GH/fortinetCloudBlueprint.git\ncd fortinetCloudBlueprint\n</code></pre> <p></p> <ul> <li>Deploy the template</li> </ul> <pre><code>az deployment group create --name fortinetCloudBlueprint --resource-group @RESOURCE_GROUP_NAME --template-file 000-main.bicep\n</code></pre> <ul> <li>When you execute the script, it will prompt you with a few questions to configure the necessary settings for deployment. You'll need to provide answers for these specific settings.</li> </ul> Parameter Description Requirements USERNAME The username you provide will grant you access to the FortiGate / FortiWeb GUI and SSH management interface. This username can differ from your Azure account username. Username admin is not allowed. PASSWORD The password that will be used to log in to the FortiGate / FortiWeb GUI and SSH management interface. It's crucial to use a unique password that hasn't been used elsewhere, as it will appear in plaintext in the bootstrap process. At least 12 characters long and must include characters from at least three of the following categories: uppercase, lowercase, numbers, special characters (excluding '\\' and '-'). PREFIX Enter @PREFIX. It will be applied to all the resources created to make them easier to manage, use, and identify. Needs to be unique. <ul> <li>To proceed, please enter the necessary variables when prompted.</li> </ul> <p></p> <ul> <li> <p>Deployment can take up to 15 minutes. Time for a coffee break, maybe even two.</p> </li> <li> <p>While the template is deploying, you can monitor its progress by navigating to the resource group @PREFIX-blueprint and selecting the Deployments menu.</p> </li> </ul> <p></p> <ul> <li>After deployment, you can output essential information such as public IP addresses that you will need to connect to your deployment:</li> </ul> <pre><code>az deployment group show -g @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n</code></pre> <p></p> Connect to FortiWeb <p>Once the deployment is complete, use the following URLs and ports to connect to your instances:</p> Instance HTTPS Ports SSH Ports FWB-A https://@PREFIX.@REGION.cloudapp.azure.com:40030 50030 FWB-B https://@PREFIX.@REGION.cloudapp.azure.com:40031 50031 DVWA https://@PREFIX.@REGION.cloudapp.azure.com:443 N/A <p>FAQ</p> <p>Why is it hard to predict which FortiWeb unit will handle my traffic?</p> <p>Traffic is distributed across both FortiWeb units, FWB-A and FWB-B. Due to this load-balancing mechanism, it's unpredictable to determine in advance which unit will manage a particular flow of traffic. That is said, we have enabled connection persistence on the external Azure Load Balancer. This ensures that once you've identified the correct FortiWeb unit, your traffic should consistently be managed by that unit.</p> <p>What should I do if I find the traffic log empty?</p> <p>If the traffic log is empty on one of the FortiWeb units, you'll need to log in to the other unit to see if the traffic is being managed there.</p> <p>Why do I get logged out of one GUI when logging into the other?</p> <p>Both FortiWeb units share the same domain and, consequently, the same cookies. Logging in to one GUI will overwrite the cookie for the other, automatically logging you out.</p> <p>How can I stay logged into both GUIs simultaneously?</p> <p>If you wish to keep both GUIs open at the same time, you will need to use two different web browsers. This will allow you to maintain separate sessions for each FortiWeb unit.</p> <p>You can use the az deployment group show command to display all resources along with their URLs and ports.</p> <pre><code>az deployment group show -g @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n</code></pre> <p></p> <p>When connecting to FortiWeb GUI, use the username and password that you provided when deploying the template. You should then be logged in to the main Dashboard.</p> <p></p> <p>You can double check your DNS configuration in the Azure Public IP settings.</p> <p>In the Azure portal, search for FWBAPClusterPublicIP.</p> <p></p> <p>You will find the DNS configuration under the configuration menu.</p> <p></p> Ensure that your environment is operational <p>Ensure your environment is set up correctly by following this three-step checklist.</p> <p>1 - You should be able to navigate to the DVWA application: https://@PREFIX.@REGION.cloudapp.azure.com</p> <p>If you encounter a FortiWeb block page, clear your browser cache and try again.</p> <p></p> <p>2 - Verify the presence of the two FortiWeb instances on the main dashboard by navigating to <code>Dashboard &gt; Status</code>. Additionally, check the status of your license. Note: we are using PAYG License model for this Lab.</p> <p></p> <p>3 - Verify the topology by going to the menu <code>Dashboard &gt; FortiView Topology</code></p> <p></p> <p>If you encounter any issues, refer to the following troubleshooting sections or consult your instructor.</p> Troubleshooting - What to do if the cluster is not operational? <p>During the initial startup, there's a possibility that ARP on port2 may malfunction, which could render the cluster inoperative, as port2 is deemed faulty. In such cases, you'll need to restart both FortiWeb VMs via the Azure console.</p> <p>Note that restarting the FortiWebs from the GUI will not resolve the ARP issue; only a restart from the Azure portal will fix it.</p> <p>Navigate to the Virtual Machines menu in the Azure portal. Select the two FortiWeb VMs and click on Restart.</p> <p></p> Troubleshooting - What to do if there is no policy in place, or if DVWA is not accessible? <p>The FortiWeb configuration, including the WAF policy, is automatically loaded when the VM is created. We achieve this by using the Azure cloud-init feature. Cloud-init is a widely used method for customizing a VM as it boots for the first time. However, there may be circumstances where the configuration doesn't load correctly. If this happens to you, you can simply manually import our configuration file.</p> <p>1 - Navigate to the bootstrap page</p> <p>2 - Copy Part 2 of the configuration to your clipboard</p> <p></p> <p>3 - Connect to your FortiWeb instance, and open the CLI console located in the upper left corner</p> <p>4 - Paste the copied configuration into the console</p> <p></p> <p>5 - Navigate to <code>Dashboard &gt; FortiView Topology</code> and verify that the policy is now displayed</p> <p></p> <p>6 - You should be able to navigate to the DVWA application: https://@PREFIX.@REGION.cloudapp.azure.com</p> <p></p> Troubleshooting - Delete and rebuild your Lab Environment <p>Here's the process to follow if you need to delete and rebuild your Lab environment:</p> <p>Do not delete the resource group itself, as you won't be able to recreate it.</p> <ul> <li>Navigate to the Azure portal</li> <li>Choose your resource group, identified as @RESOURCE_GROUP_NAME</li> <li>Select all the resources within the group</li> <li>Click on Delete</li> </ul> <p></p> <ul> <li>Opt for Apply force delete for selected Virtual machines and Virtual machine scale sets</li> <li>Type delete to confirm deletion</li> <li>Click on Delete</li> </ul> <p></p> <ul> <li>Wait for the deletion process to complete</li> </ul> <p></p> <ul> <li>Navigate to Azure Cloud Shell and make sure you are in the fortinetCloudBlueprint folder</li> </ul> <pre><code>cd fortinetCloudBlueprint\n</code></pre> <ul> <li>Redeploy the template using the following command</li> </ul> <pre><code>az deployment group create --name fortinetCloudBlueprint --resource-group @RESOURCE_GROUP_NAME --template-file 000-main.bicep\n</code></pre> Check your System Configuration (optional) <p>Once you have access to the FortiWeb GUI, those are the main menu to check your system configuration.</p> Configuration Menu FortiWeb Network Access <code>Network &gt; Interface</code> Routing <code>Network &gt; Static Route</code> DNS Configuration <code>Network &gt; DNS</code> VM License <code>Dashboard &gt; Status &gt; Licenses &gt; Update VM License</code> FortiGuard Status and Updates <code>System &gt; Config &gt; FortiGuard</code> Time Zone Setting <code>System &gt; Maintenance &gt; System Time</code> Timeout Setting <code>System &gt; Admin &gt; Settings &gt; Idle Timeout</code> Firmware Version <code>System &gt; Maintenance &gt; Firmware</code> Check your Application Policy (optional) <p>During the Bicep deployment, we imported this bootstrap. Those are the main menus to check your Application Policy:</p> Configuration Menu Virtual IP <code>Network &gt; Virtual IP</code> Virtual Server <code>Server Objects &gt; Virtual Server</code> Server Pool <code>Server Objects &gt; Server Pool</code> Signature <code>Web Protection &gt; Known Attacks &gt; Signatures</code> Web Protection Profile <code>Policy &gt; Web Protection Profile</code> Policy <code>Policy &gt; Server Policy</code>"},{"location":"start-deploy/#initializing-dvwa","title":"Initializing DVWA","text":"Initialize DVWA database and authenticate <p>Connect to https://@PREFIX.@REGION.cloudapp.azure.com/setup.php</p> <p>Click Create / Reset Database</p> <p></p> <p>Click Login and authenticate with any of these accounts:</p> Username Password admin password gordonb abc123 1337 charley pablo letmein smithy password <p>You should be directed to the welcome page.</p> <p></p> How to install DVWA in another Lab Environement? <p>If you are not using the  Azure Fortinet Cloud Blueprint, you can install your own DVWA instance.</p> <p>The most straightforward way to install DVWA is by utilizing Docker. Install any Linux distribution with Docker and run those 2 commands:</p> <pre><code>sudo docker pull vulnerables/web-dvwa\nsudo docker run -d --restart unless-stopped -p 80:80 vulnerables/web-dvwa\n</code></pre> <p>You can explore additional deployment options on the official  DVWA GitHub.</p>"}]}