{"config":{"lang":["en"],"separator":"[\\s\\u200b\\-_,:!=\\[\\]()\"`/]+|\\.(?!\\d)|&[lg]t;|(?!\\b)(?=[A-Z][a-z])","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Hands-On Lab: Fortinet Azure Blueprint","text":""},{"location":"#comparative-analysis-of-azure-nsg-fortigate-and-fortiweb-for-web-application-security","title":"Comparative Analysis of Azure NSG, FortiGate, and FortiWeb for Web Application Security","text":""},{"location":"#introduction","title":"Introduction","text":"<p>Welcome to this hands-on lab experience, designed to give you practical insights into protecting your Damn Vulnerable Web Application (DVWA). This exercise is divided into two distinct labs, each exploring different security solutions.</p>"},{"location":"#lab-1-exploring-network-security-with-azure-nsg-and-fortigate","title":"Lab 1: Exploring Network Security with Azure NSG and FortiGate","text":"<p>In the first lab, we will explore Azure Network Security Groups (NSG) and FortiGate functionalities to establish a secure environment for your DVWA application. The aim of this section is not only to demonstrate how these tools operate and can be fine-tuned for application security, but also to highlight their limitations. By examining the differences between NSG and FortiGate, we set the stage for the second lab focused on FortiWeb, which provides a more comprehensive security solution.</p>"},{"location":"#components","title":"Components","text":"<ul> <li>Azure Network Security Groups (NSG)</li> <li>FortiGate Firewall</li> <li>DVWA Web Application</li> </ul>"},{"location":"#lab-2-enhancing-web-application-security-with-fortiweb","title":"Lab 2: Enhancing Web Application Security with FortiWeb","text":"<p>The primary objective of this second lab is to introduce the various security measures available for protecting web applications. You will gain firsthand experience in implementing these tools and will have the opportunity to compare their effectiveness, with a focus on demonstrating FortiWeb's superior protection capabilities compared to previous solutions.</p>"},{"location":"#components_1","title":"Components","text":"<ul> <li>FortiWeb Web Application Firewall</li> <li>DVWA Web Application</li> </ul>"},{"location":"#network-topology","title":"Network topology","text":"<p>There are multiple ways to install FortiGate, FortiWeb and DVWA. In this document, we will utilize a predefined template available for Azure:</p> <p>:simple-github: The Fortinet Reference Architecture for Azure</p> <p>This template automatically deploys a FortiGate cluster, a FortiWeb cluster, and a DVWA instance, along with a predefined policy, enabling you to begin the demo immediately.</p> <p>??? question \"What is Fortinet Reference Architecture for Azure?\"     This architecture provides users with templates that deploy and preconfigure a perimeter solution to address dynamic security needs.</p> <pre><code>It features a **FortiGate** Next Generation Firewall, **FortiWeb WAF**, and **DVWA** Endpoint.\n\n![](img/fwb-bicep-fortinet.png)\n\nThe WAF secures web servers against inbound attacks over HTTP/HTTPS, while the Next Generation Firewall supports various protocols, enabling connectivity, multi-protocol security, and serving as the primary egress mechanism. The FortiGate and FortiWeb solutions complement each other, with FortiWeb offering advanced features for HTTP/HTTPS traffic and FortiGate providing extensive capabilities for other protocols, routing, VPN termination, and SD-WAN.\n</code></pre> <p>??? note \"Network Topology\"     This Azure BICEP template deploys a secure environment featuring FortiGate and FortiWeb for traffic inspection. The FortiGate setup receives non-HTTP(S) traffic, while FortiWeb handles HTTP(S) traffic, both using user-defined routing (UDR) and public IPs. Additionally, a Damn Vulnerable Web Application (DVWA) is included for security testing and learning purposes.</p> <pre><code>The environment includes:\n\n- 2 x **FortiGate** Firewalls in an active/passive deployment\n- 2 x **FortiWeb** WAFs in an active/active deployment\n- 2 x Public Azure Standard **Load Balancers** for internet communication (1 x per cluster)\n- 2 x Internal Azure Standard **Load Balancers** for forwarding traffic to Azure Gateways connected to ExpressRoute or Azure VPNs\n- 1 x **VNET** with 1 protected subnet\n- 4 x **Public IPs** for services and FortiGate/FortiWeb management\n- **User Defined Routes** (UDR) for end-to-end communication via the FortiGate/FortiWeb deployment\n\nVMs can be installed in different **Availability Zones** or **Availability Sets** for enhanced availability.\n\nThese templates can also be **extended** or **customized** based on your requirements, such as adding additional subnets and routing tables.\n\n&lt;span style=\"color:red;\"&gt;Click on the image if you want to enlarge it.&lt;/span&gt;\n\n![](img/fwb-bicep-templates.png)\n</code></pre> <p>??? note \"FortiWeb Deployment\"     FortiWeb is deployed with 2 interfaces as an active-active cluster in reverse proxy mode.</p> <pre><code>- Web browsers connect to the public IP on Azure's Standard Load Balancers.\n- FortiWeb decrypts and inspect the HTTP traffic, then forwards it to the DVWA via its internal IP\n- Return packets are directed back to FortiWeb's internal IP.\n- For DVWA OS updates or SSH connections, traffic is routed through FortiGate.\n\n&lt;span style=\"color:red;\"&gt;Click on the image if you want to enlarge it.&lt;/span&gt;\n\n![](img/fwb-fortiweb-azure-toplology.png)\n</code></pre>"},{"location":"architecture/","title":"Fortinet Reference Architecture for Azure","text":""},{"location":"architecture/#considerations-and-justifications","title":"Considerations and Justifications","text":"<ul> <li> <p>FortiWeb is primarily designed for web traffic, specifically HTTP/HTTPS, and offers 60+ protections including machine learning and signature-based protections.</p> </li> <li> <p>FortiGate is designed for managing all other types of traffic, supporting multiple protocols, and providing application control and intrusion prevention systems.</p> </li> </ul> <p>??? note \"WAF Feature Comparison: FortiWeb vs. FortiGate\"     | Feature                                  | FortiGate                            | FortiWeb                                                |     |------------------------------------------|--------------------------------------|---------------------------------------------------------|     | Web App Attack Signatures                | Yes | Yes                    |     | WAF Signatures (FortiGuard Subscription) | No    | Yes                    |     | IP Reputation (FortiGuard subscription)  | Yes | Yes                    |     | Layer 7 DoS Protection                   | Yes | Yes (+ Bot validation) |     | Machine Learning based Anomaly Detection | No    | Yes                    |     | Machine Learning based Bot Mitigation    | No    | Yes                    |     | Machine Learning based API Protections   | No    | Yes                    |     | HTTP RFC Validation                      | Yes | Yes                    |     | API Protection                           | No    | Yes                    |     | Cookie Protection, CSRF                  | No    | Yes                    |     | Browser Security (Man-in-the-Browser)    | No    | Yes                    |     | Syntax based detection                   | No    | Yes                    |     | Antivirus/Antimalware                    | Yes | Yes                    |     | Web App Attack Correlation               | No    | Yes                    |     | Web App Vulnerability Scanner            | No    | Yes                    |     | Web Filtering                            | Yes | No                       |     | Data Leak Prevention                     | Yes | Yes                    |     | Attack Alert Tuning                      | No    | Yes                    |     | Web Defacement Protection                | No    | Yes                    |     | Authentication Offload                   | Yes | Yes                    |     | Site Publishing and SSO                  | SSO                                  | Yes                    |     | PCI Compliance                           | Yes | Yes                    |     | Dedicated WAF Throughput                 | No    | Yes                    |     | SSL Inspection                           | Yes | Yes                    |</p>"},{"location":"architecture/#fortiweb-reference-architecture","title":"FortiWeb Reference Architecture","text":"<p>???+ note \"High-Level View\"     Click on the image if you want to enlarge it.</p> <pre><code>![](img/fwb-reference-topology.png)\n</code></pre> <p>??? note \"Detailed View\"     </p> <p>??? note \"Detailed View with Routes\"     </p> <p>??? note \"Internet originating Non-HTTP(S) flows (i.e. SSH etc\u2026)\"     </p> <p>??? note \"Internet originating HTTP(S) flows\"     </p> <p>??? note \"Internal originating Non-HTTP(S) flows (i.e. SSH etc\u2026)\"     </p> <p>??? note \"Internal originating HTTP(S) flows\"     </p>"},{"location":"architecture/#fortigate-reference-architecture","title":"FortiGate Reference Architecture","text":""},{"location":"architecture/#fortigate-vm-active-passive-with-fabric-connector","title":"FortiGate-VM \u2013 Active-Passive with Fabric connector","text":"<p>Strengths</p> <ul> <li>Failover of existing connections</li> <li>Support of non-TCP/UDP protocols (e.g. ESP, ICMP)</li> <li>Source IP of connections that ingress from the Internet is not modified</li> </ul> <p>Weaknesses</p> <ul> <li>Failover time is dependent on Azure API response time and can vary from approximately 45 seconds to up to more than 2 minutes</li> <li>As with all active-passive designs, the passive node is not passing traffic in the majority of times</li> </ul> <p>Uses</p> <ul> <li>Architectures requiring IPSEC VPN with NAT-T support (like IOT or other non-FortiGate IPSEC termination)</li> </ul> <p>??? note \"High-Level View\"     </p> <p>??? note \"Detailed View\"     FortiGate1 is Active </p>"},{"location":"architecture/#fortigate-vm-active-passive-with-load-balancers","title":"FortiGate-VM \u2013 Active-Passive with Load Balancers","text":"<p>Strengths</p> <ul> <li>Relatively fast fail over (10 to 20 seconds on average)</li> <li>Source IP of connections that ingress from Internet is not modified</li> </ul> <p>Weaknesses</p> <ul> <li>Existing established connections are not failed over(Azure Load Balancer limitation)</li> <li>Only supports UDP or TCP connections (Azure Load Balancer limitation)</li> <li>As with all active-passive designs, the passive node is not passing traffic in the majority of times</li> </ul> <p>Uses</p> <ul> <li>Fortinet Azure SDWAN hub</li> </ul> <p>??? note \"High-Level View\"     </p> <p>??? note \"Detailed View\"     </p>"},{"location":"architecture/#fortigate-vm-active-active-with-load-balancers","title":"FortiGate-VM \u2013 Active-Active with Load Balancers","text":"<p>Strengths</p> <ul> <li>Relatively fast fail over (10 to 20 seconds on average)</li> <li>Both firewall VMs are processing traffic during normal operations</li> </ul> <p>Weaknesses</p> <ul> <li>Existing established connections are not failed over(Azure Load Balancer limitation)</li> <li>Only supports UDP or TCP connections (Azure Load Balancer limitation)</li> <li>Source IP of connections that ingress from Internet is often modified with Source NAT</li> </ul> <p>Uses</p> <ul> <li>Recommended Architecture</li> </ul> <p>??? note \"High-Level View\"     </p> <p>??? note \"Detailed View\"     Multiple Public IPs </p>"},{"location":"architecture/#azure-gateway-load-balancer-and-fortigate","title":"Azure Gateway Load Balancer and FortiGate","text":"<ul> <li>The integration of Fortinet FortiGate Next-Generation Firewall (NGFW) with Azure Gateway Load Balancer (GWLB) simplifies deployment and configuration while reducing outages.</li> <li>The Azure GWLB supports service chaining to enable transparent deployment of firewall NVAs without introducing management overhead.</li> <li>It uses the VXLAN protocol for encapsulation and decapsulation, maintaining flow symmetry for traffic inspection by firewall NVAs.</li> </ul> <p>??? note \"Reference Architecture\"     Consumer Load  Balancer Frontend Public IP </p>"},{"location":"architecture/#frequently-asked-questions","title":"Frequently Asked Questions","text":"<p>Q \u2013 Does this apply to other Public Clouds ?</p> <p>A \u2013 This Architecture is specific to Azure.</p> <p>Q \u2013 Why are the FortiWeb VMs and FortiGate VMs in parallel instead of series for Internet web flows?</p> <p>A \u2013 FortiWeb has integrated IPS and AV thus no need to duplicate on FortiGate using up cloud computing cycles.</p> <p>Q \u2013 Why is the FWB Internal LB in the FWBExternal Subnet and not the FWBInternal Subnet?</p> <p>A \u2013 Because it is used only for traffic passing through SDWAN.</p> <p>Q \u2013 Why is there no Azure Internal LB in the FWBInternal subnet</p> <p>A \u2013 FortiWeb can only be deployed in reversed proxy in Azure and thus the traffic replies automatically go back to the appropriate FortiWeb VM thus negating the needs to have Azure Internal Load Balancer in HA Ports.</p>"},{"location":"bootstrap/","title":"FortiWeb Bootstrap","text":"<p>As part of this Hands-On Lab, the FortiWeb configuration is automatically applied when the VM is created. This is accomplished using cloud-init, a widely adopted method for customizing any VM as it boots for the first time.</p> <p></p> <p>The bootstrap bellow includes the FortiWeb Policy that is designed to showcase DVWA for the purposes of security testing and learning.</p>"},{"location":"bootstrap/#part1-student-specific-configuration-settings","title":"Part1 : Student-Specific Configuration Settings","text":"<pre><code>config system global\nset admintimeout 480\nset timezone 12\nend\nconfig log traffic-log\nset status enable\nset packet-log enable\nend\nconfig system feature-visibility\nset wvs enable\nset fortigate-integration enable\nend\nconfig waf url-access url-access-rule\nedit \"DVWA_URL_ACCCESS_RULE\"\nset action alert_deny\nconfig match-condition\nedit 1\nset reg-exp ^/about.php.*\nset type regex-expression\nnext\nend\nnext\nend\nconfig waf url-access url-access-policy\nedit \"DVWA_URL_ACCESS_POLICY\"\nconfig rule\nedit 1\nset url-access-rule-name DVWA_URL_ACCCESS_RULE\nnext\nend\nnext\nend\nconfig waf geo-block-list\nedit \"DVWA_GEO_PROTECTION\"\nconfig country-list\nedit 1\nset country-name Afghanistan\nnext\nend\nnext\nend\nconfig waf ip-list\nedit \"DVWA_IP_LIST\"\nset action alert_deny\nconfig members\nedit 1\nset type black-ip\nset ip 1.1.1.1\nnext\nend\nnext\nend\nconfig user local-user\nedit \"demo\"\nset username demo\nset password demo\nnext\nend\nconfig user user-group\nedit \"DVWA_USER_GROUP\"\nconfig members\nedit 1\nset local-name demo\nnext\nend\nnext\nend\nconfig waf http-authen http-authen-rule\nedit \"DVWA_AUTH_RULE\"\nconfig rule\nedit 1\nset user-realm REALM\nset user-group DVWA_USER_GROUP\nset request-url /instructions.php\nnext\nend\nnext\nend\nconfig waf http-authen http-authen-policy\nedit \"DVWA_AUTH_POLICY\"\nconfig rule\nedit 1\nset http-authen-rule DVWA_AUTH_RULE\nnext\nend\nnext\nend\nconfig waf hidden-fields-rule\nedit \"DVWA_HIDDEN_FIELD_RULE\"\nconfig hidden-field-name\nedit 1\nset argument MAX_FILE_SIZE\nnext\nend\nset action alert_deny\nset request-file /vulnerabilities/upload/\nset action-url0 /vulnerabilities/upload/\nnext\nend\nconfig waf hidden-fields-protection\nedit \"DVWA_HIDDEN_FIELD\"\nconfig hidden_fields_list\nedit 1\nset hidden-field-rule DVWA_HIDDEN_FIELD_RULE\nnext\nend\nnext\nend\nconfig waf user-tracking rule\nedit \"DVWA_USER_TRACKING_RULE\"\nset authentication-url /login.php\nset username-parameter username\nset password-parameter password\nset session-id-name PHPSESSID\nset logoff-path /logout.php\nconfig match-condition\nedit 1\nset value 302\nnext\nend\nnext\nend\nconfig waf user-tracking policy\nedit \"DVWA_USER_TRACKING\"\nconfig input-rule-list\nedit 1\nset input-rule DVWA_USER_TRACKING_RULE\nnext\nend\nnext\nend\nconfig waf url-rewrite url-rewrite-rule\nedit \"DVWA_URL_REWRITE_FORTINET\"\nset action redirect-301\nset location https://www.fortinet.com\nconfig header-removal\nend\nconfig response-header-removal\nend\nconfig match-condition\nedit 1\nset object http-url\nset reg-exp ^/fortinet.*\nnext\nend\nnext\nedit \"DVWA_URL_REWRITE_CHANGE\"\nset url-status enable\nset url /vulnerabilities/csrf/\nconfig header-removal\nend\nconfig response-header-removal\nend\nconfig match-condition\nedit 1\nset object http-url\nset reg-exp ^/change.*\nnext\nend\nnext\nend\nconfig waf url-rewrite url-rewrite-policy\nedit \"DVWA_URL_REWRITE\"\nconfig rule\nedit 1\nset url-rewrite-rule-name DVWA_URL_REWRITE_FORTINET\nnext\nedit 2\nset url-rewrite-rule-name DVWA_URL_REWRITE_CHANGE\nnext\nend\nnext\nend\nconfig waf allow-method-policy\nedit \"DVWA_ALLOW_METHOD\"\nset allow-method get post\nnext\nend\nconfig waf file-upload-restriction-rule\nedit \"DVWA_WEBSHELL_UPLOADING\"\nset request-type regular\nset request-file ^/.*\nset type Block\nset enable_base64_decode disable\nconfig file-types\nedit 1\nset file-type-name EXE(.exe)\nset file-type-id 00126\nnext\nedit 3\nset file-type-name JSP(.jsp)\nset file-type-id 00153\nnext\nedit 4\nset file-type-name ASPX(.aspx)\nset file-type-id 00154\nnext\nedit 5\nset file-type-name SQL(.sql)\nset file-type-id 00166\nnext\nend\nconfig custom-file-types\nend\nnext\nend\nconfig waf file-upload-restriction-policy\nedit \"DVWA_FILE_SECURITY_POLICY\"\nset av-scan enable\nconfig rule\nedit 1\nset file-upload-restriction-rule DVWA_WEBSHELL_UPLOADING\nnext\nend\nnext\nend\nconfig waf webshell-detection-policy\nedit \"DVWA_WEBSHELL_UPLOADING\"\nnext\nend\nconfig waf csrf-protection\nedit \"DVWA_CSRF_PROTECTION\"\nset action alert_deny\nconfig csrf-url-list\nedit 1\nset request-url /vulnerabilities/csrf/\nset parameter-filter enable\nset parameter-name password_new\nset parameter-value-type regular\nset parameter-value .*\nnext\nend\nconfig csrf-page-list\nedit 1\nset request-url /vulnerabilities/csrf/\nnext\nend\nnext\nend\nconfig waf mitb-rule\nedit \"DVWA_MAN_IN_THE_BROWSER_RULE\"\nset action alert_deny\nset severity Medium\nset request-url /login.php\nset post-url /login.php\nconfig protected-parameter-list\nedit \"username\"\nset obfuscate enable\nnext\nedit \"password\"\nset type password-input\nset obfuscate enable\nnext\nend\nconfig allowed-external-domains-list\nend\nnext\nend\nconfig waf mitb-policy\nedit \"DVWA_MAN_IN_THE_BROWSER\"\nconfig rule-list\nedit 1\nset mitb-rule DVWA_MAN_IN_THE_BROWSER_RULE\nnext\nend\nnext\nend\nconfig waf input-rule\nedit \"DVWA_PARAMETER_VALIDATION_RULE\"\nset severity Medium\nset request-type regular\nset request-file ^/vulnerabilities/exec/.*\nconfig rule-list\nedit 1\nset type-checked enable\nset argument-name ip\nset location url body\nset data-type Address\nnext\nend\nnext\nend\nconfig waf parameter-validation-rule\nedit \"DVWA_PARAMETER_VALIDATION\"\nconfig input-rule-list\nedit 1\nset input-rule DVWA_PARAMETER_VALIDATION_RULE\nnext\nend\nnext\nend\nconfig waf ip-intelligence\nedit 1\nset category Botnet\nset status enable\nnext\nedit 2\nset category \"Anonymous Proxy\"\nset status enable\nnext\nedit 3\nset category Phishing\nset status enable\nnext\nedit 4\nset category Spam\nset status enable\nnext\nedit 5\nset category Others\nset status enable\nset action alert\nnext\nedit 6\nset category Tor\nset status enable\nnext\nend\nconfig waf signature\nedit \"DVWA_SIGNATURE_PROFILE\"\nconfig main_class_list\nedit \"010000000\"\nset fpm-status disable\nset action alert_deny\nset severity High\nnext\nedit \"020000000\"\nset fpm-status disable\nnext\nedit \"030000000\"\nset action alert_deny\nset severity High\nnext\nedit \"040000000\"\nnext\nedit \"050000000\"\nset fpm-status disable\nset action alert_deny\nset severity High\nnext\nedit \"060000000\"\nset fpm-status disable\nnext\nedit \"070000000\"\nset fpm-status disable\nnext\nedit \"080000000\"\nset fpm-status disable\nset severity Low\nnext\nedit \"090000000\"\nset fpm-status disable\nset action alert_deny\nset severity High\nnext\nedit \"100000000\"\nset status disable\nset fpm-status disable\nset severity High\nnext\nedit \"120000000\"\nset status disable\nset severity High\nnext\nend\nconfig sub_class_disable_list\nend\nconfig signature_disable_list\nedit \"060030001\"\nnext\nedit \"060120001\"\nnext\nedit \"080080005\"\nnext\nedit \"080200001\"\nnext\nedit \"080080003\"\nnext\nedit \"090410001\"\nnext\nedit \"090410002\"\nnext\nedit \"040000141\"\nnext\nedit \"040000136\"\nnext\nedit \"060180001\"\nnext\nedit \"060180002\"\nnext\nedit \"060180003\"\nnext\nedit \"060180004\"\nnext\nedit \"060180005\"\nnext\nedit \"060180006\"\nnext\nedit \"060180007\"\nnext\nedit \"060180008\"\nnext\nedit \"010000072\"\nnext\nedit \"010000092\"\nnext\nedit \"010000093\"\nnext\nedit \"010000214\"\nnext\nedit \"030000182\"\nnext\nedit \"030000195\"\nnext\nedit \"030000204\"\nnext\nedit \"050140001\"\nnext\nedit \"050140003\"\nnext\nedit \"050140004\"\nnext\nedit \"050220001\"\nnext\nedit \"080200004\"\nnext\nedit \"080200005\"\nnext\nedit \"080210001\"\nnext\nedit \"080210002\"\nnext\nedit \"080210003\"\nnext\nedit \"080210004\"\nnext\nedit \"080210005\"\nnext\nedit \"090240001\"\nnext\nedit \"050180003\"\nnext\nedit \"080110001\"\nnext\nedit \"080140012\"\nnext\nedit \"080050001\"\nnext\nedit \"080150006\"\nnext\nedit \"080150003\"\nnext\nedit \"080150002\"\nnext\nedit \"080150008\"\nnext\nedit \"080150014\"\nnext\nedit \"080150004\"\nnext\nedit \"080150005\"\nnext\nedit \"080150032\"\nnext\nedit \"080150029\"\nnext\nedit \"080150009\"\nnext\nedit \"080120002\"\nnext\nedit \"080150020\"\nnext\nedit \"080150031\"\nnext\nedit \"080140015\"\nnext\nedit \"080120001\"\nnext\nedit \"050070002\"\nnext\nedit \"050160002\"\nnext\nedit \"010000108\"\nnext\nedit \"080110003\"\nnext\nend\nconfig alert_only_list\nend\nconfig fpm_disable_list\nend\nconfig scoring_override_disable_list\nend\nconfig score_grade_list\nend\nconfig filter_list\nend\nnext\nend\nconfig waf x-forwarded-for\nedit \"DVWA_X_FORWARDED_FOR\"\nset x-forwarded-for-support enable\nset original-ip-header X-FORWARDED-FOR\nconfig ip-list\nend\nnext\nend\nconfig server-policy vserver\nedit \"DVWA_VS\"\nconfig vip-list\nedit 1\nset interface port1\nset use-interface-ip enable\nnext\nedit 2\nset vip DVWA_VIP\nnext\nend\nnext\nend\nconfig waf http-protocol-parameter-restriction\nedit \"DVWA_PROTOCOL_CONSTRAINTS\"\nset max-http-header-length 4096\nset max-http-header-length-severity High\nset max-http-content-length 65536\nset max-http-content-length-severity High\nset max-http-body-length 65536\nset max-http-body-length-severity High\nset max-http-request-length 65536\nset max-http-request-length-severity High\nset max-url-parameter-length 2048\nset max-url-parameter-length-severity High\nset Illegal-http-version-check enable\nset Illegal-http-version-check-severity High\nset max-cookie-in-request 16\nset max-cookie-in-request-severity High\nset max-header-line-request-severity High\nset Illegal-http-request-method-check enable\nset Illegal-http-request-method-severity High\nset max-url-parameter 16\nset max-url-parameter-severity High\nset Illegal-host-name-check enable\nset Illegal-host-name-check-action alert\nset Illegal-host-name-check-severity High\nset number-of-ranges-in-range-header-action alert_deny\nset number-of-ranges-in-range-header-severity High\nset http2-max-requests-check enable\nset http2-max-requests-severity High\nset block-malformed-request-check enable\nset block-malformed-request-action alert\nset block-malformed-request-severity High\nset Illegal-content-length-check enable\nset Illegal-content-length-check-severity High\nset Illegal-content-type-check enable\nset Illegal-content-type-check-severity High\nset Illegal-response-code-check enable\nset Illegal-response-code-check-severity High\nset Post-request-ctype-check enable\nset Post-request-ctype-check-severity High\nset max-http-header-name-length 255\nset max-http-header-name-length-severity High\nset max-http-header-value-length 2048\nset max-http-header-value-length-severity High\nset parameter-name-check enable\nset parameter-name-check-severity High\nset parameter-value-check enable\nset parameter-value-check-severity High\nset Illegal-header-name-check enable\nset Illegal-header-name-check-action alert\nset Illegal-header-name-check-severity High\nset Illegal-header-value-check enable\nset Illegal-header-value-check-action alert\nset Illegal-header-value-check-severity High\nset max-http-body-parameter-length 6144\nset max-http-body-parameter-length-severity High\nset max-http-request-filename-length-severity High\nset web-socket-protocol-check enable\nset web-socket-protocol-severity High\nset max-setting-header-table-size-severity High\nset max-setting-current-streams-num-severity High\nset max-setting-initial-window-size-severity High\nset max-setting-frame-size-severity High\nset max-setting-header-list-size-severity High\nset max-url-param-name-len 2048\nset max-url-param-name-len-severity High\nset max-url-param-value-len 2048\nset max-url-param-value-len-severity High\nset url-param-name-check-severity High\nset url-param-value-check-severity High\nset null-byte-in-url-severity High\nset illegal-byte-in-url-severity High\nset malformed-url-severity High\nset redundant-header-action alert\nset redundant-header-severity High\nset chunk-size-severity High\nset Internal-resource-limits-check enable\nset Internal-resource-limits-severity High\nset rpc-protocol-check enable\nset rpc-protocol-severity High\nset odd-and-even-space-attack-severity High\nnext\nend\nconfig waf bot-deception\nedit \"DVWA_BOT_DECEPTION\"\nset deception-url /fake_url.php\nset action alert_deny\nconfig url-list\nedit 1\nset url /login.php\nnext\nend\nnext\nend\nconfig waf biometrics-based-detection\nedit \"DVWA_BOT_BIOMETRICS\"\nset event-collection-time 10\nconfig url-list\nend\nnext\nend\nconfig waf threshold-based-detection policy\nedit \"DVWA_BOT_TRESHOLDS\"\nnext\nend\nconfig waf known-bots\nedit \"DVWA_BOT_SIGNATURES\"\nconfig malicious-bot-disable-list\nend\nconfig known-good-bots-disable-list\nend\nnext\nend\nconfig waf bot-mitigate-policy\nedit \"DVWA_BOT_POLICY\"\nset bot-deception DVWA_BOT_DECEPTION\nset biometrics-based-detection DVWA_BOT_BIOMETRICS\nset threshold-based-detection DVWA_BOT_TRESHOLDS\nset known-bots DVWA_BOT_SIGNATURES\nnext\nend\nconfig waf http-request-flood-prevention-rule\nedit \"DVWA_HTTP_FLOOD\"\nset access-limit-in-http-session 5\nnext\nend\nconfig waf http-connection-flood-check-rule\nedit \"DVWA_CONNECTION_LIMIT\"\nset http-connection-threshold 100\nnext\nend\nconfig waf layer4-access-limit-rule\nedit \"DVWA_HTTP_LIMIT\"\nset access-limit-standalone-ip 500\nset access-limit-share-ip 1000\nnext\nend\nconfig waf layer4-connection-flood-check-rule\nedit \"DVWA_TCP_FLOOD\"\nset layer4-connection-threshold 255\nnext\nend\nconfig waf application-layer-dos-prevention\nedit \"DVWA_DOS_POLICY\"\nset enable-http-session-based-prevention enable\nset http-request-flood-prevention-rule DVWA_HTTP_FLOOD\nset http-connection-flood-check-rule DVWA_CONNECTION_LIMIT\nset enable-layer4-dos-prevention enable\nset layer4-access-limit-rule DVWA_HTTP_LIMIT\nset layer4-connection-flood-check-rule DVWA_TCP_FLOOD\nset layer3-fragment-protection enable\nnext\nend\nconfig waf custom-access rule\nedit \"DVWA_VULNERABILITY_SCANNING\"\nset action block-period\nset severity High\nconfig main-class\nedit \"010000000\"\nset no-subclass enable\nnext\nedit \"030000000\"\nset no-subclass enable\nnext\nedit \"050000000\"\nnext\nedit \"090000000\"\nnext\nedit \"070000000\"\nset no-subclass enable\nnext\nend\nconfig sub-class\nedit \"050010000\"\nnext\nedit \"050020000\"\nnext\nedit \"050030000\"\nnext\nedit \"050050000\"\nnext\nedit \"050060000\"\nnext\nedit \"050070000\"\nnext\nedit \"050080000\"\nnext\nedit \"050090000\"\nnext\nedit \"050100000\"\nnext\nedit \"050110000\"\nnext\nedit \"050130000\"\nnext\nedit \"050140000\"\nnext\nedit \"050150000\"\nnext\nedit \"050160000\"\nnext\nedit \"050170000\"\nnext\nedit \"050180000\"\nnext\nedit \"050190000\"\nnext\nedit \"050200000\"\nnext\nedit \"050220000\"\nnext\nedit \"050230000\"\nnext\nedit \"090230000\"\nnext\nedit \"090240000\"\nnext\nedit \"090300000\"\nnext\nedit \"090310000\"\nnext\nedit \"090320000\"\nnext\nedit \"090330000\"\nnext\nedit \"090340000\"\nnext\nedit \"090410000\"\nnext\nedit \"090440000\"\nnext\nedit \"090480000\"\nnext\nedit \"090490000\"\nnext\nedit \"090500000\"\nnext\nedit \"090510000\"\nnext\nend\nconfig custom-signature\nedit 1\nnext\nend\nconfig occurrence\nedit 2\nset occurrence-num 10\nset within 60\nnext\nend\nnext\nedit \"DVWA_BRUTE_FORCE_LOGIN\"\nset action block-period\nset severity High\nset bot-confirmation enable\nset bot-recognition captcha-enforcement\nset validation-timeout 5\nconfig url-filter\nedit 1\nset request-file \"^/.*\\\\.(php|asp|aspx|jsp)\"\nnext\nend\nconfig occurrence\nedit 2\nset occurrence-num 20\nset within 10\nnext\nend\nnext\nend\nconfig waf custom-access policy\nedit \"DVWA_CUSTOM_POLICY\"\nconfig rule\nedit 1\nset rule-name DVWA_VULNERABILITY_SCANNING\nnext\nedit 2\nset rule-name DVWA_BRUTE_FORCE_LOGIN\nnext\nend\nset threat-weight severe\nnext\nend\nconfig waf http-header-security\nedit \"DVWA_HEADER_SECURITY\"\nconfig http-header-security-list\nedit 1\nset name x-content-type-options\nnext\nedit 2\nset value sameorigin\nnext\nedit 3\nset name x-xss-protection\nset value sanitizing-mode\nnext\nend\nnext\nend\nconfig waf cookie-security\nedit \"DVWA_COOKIE_SECURITY\"\nconfig cookie-security-exception-list\nedit 1\nset cookie-name APSCOOKIE*\nset wildcard enable\nnext\nedit 2\nset cookie-name shortscc\nnext\nend\nset security-mode signed\nset action alert_deny\nset severity Medium\nset secure-cookie enable\nset allow-suspicious-cookies Never\nnext\nend\nconfig waf web-protection-profile inline-protection\nedit \"DVWA_PROTECTION_PROFILE\"\nset url-access-policy DVWA_URL_ACCESS_POLICY\nset signature-rule DVWA_SIGNATURE_PROFILE\nset x-forwarded-for-rule DVWA_X_FORWARDED_FOR\nset parameter-validation-rule DVWA_PARAMETER_VALIDATION\nset hidden-fields-protection DVWA_HIDDEN_FIELD\nset allow-method-policy DVWA_ALLOW_METHOD\nset url-rewrite-policy DVWA_URL_REWRITE\nset http-authen-policy DVWA_AUTH_POLICY\nset file-upload-policy DVWA_FILE_SECURITY_POLICY\nset webshell-detection-policy DVWA_WEBSHELL_UPLOADING\nset http-protocol-parameter-restriction DVWA_PROTOCOL_CONSTRAINTS\nset ip-list-policy DVWA_IP_LIST\nset application-layer-dos-prevention DVWA_DOS_POLICY\nset geo-block-list-policy DVWA_GEO_PROTECTION\nset custom-access-policy DVWA_CUSTOM_POLICY\nset ip-intelligence enable\nset cookie-security-policy DVWA_COOKIE_SECURITY\nset profile-id 2579818973326303562\nset fortigate-quarantined-ips enable\nset csrf-protection DVWA_CSRF_PROTECTION\nset user-tracking-policy DVWA_USER_TRACKING\nset http-header-security DVWA_HEADER_SECURITY\nset bot-mitigate-policy DVWA_BOT_POLICY\nnext\nend\nconfig server-policy policy\nedit \"DVWA_POLICY\"\nset ssl enable\nset vserver DVWA_VS\nset service HTTP\nset web-protection-profile DVWA_PROTECTION_PROFILE\nset replacemsg Predefined\nset server-pool DVWA_POOL\nset https-service HTTPS\nset http-to-https enable\nset syncookie enable\nset policy-id 15841312090804693283\nset tlog enable\nnext\nend\n</code></pre>"},{"location":"download-pdf/","title":"Download this HoL in PDF format","text":"<p>:fontawesome-solid-file-pdf: Download</p>"},{"location":"hol-fwb-lab-2/","title":"Protecting Web Application Using FortiWeb","text":"<p>To begin, we will connect to the DVWA Web Application through FortiWeb.</p> <p>??? note \"Connecting to DVWA\"     ## Connecting to DVWA</p> <pre><code>Connect to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt;\nand authenticate with one of these accounts:\n\n| Username | Password |\n|:---------|:---------|\n| admin    | password |\n| gordonb  | abc123   |\n| 1337     | charley  |\n| pablo    | letmein  |\n| smithy   | password |\n\n??? tip \"Troubleshooting - If you encounter any authentication issues\"\n\n    - Browse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/setup.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/setup.php&lt;/a&gt;\n\n    - Click on **Create / Reset Database**\n\n    ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.006.png)\n</code></pre> <p>This Hands-on Lab allows us to demonstrate 25+ FortiWeb protections. Let's take a closer look at FortiWeb's sequence of scans.</p> <p>??? note \"Sequence of Scans\"     ##Sequence of Scans</p> <pre><code>FortiWeb applies protection rules and performs protection profile scans in the order of execution according to the following list. The second tab ==highlights== the security features that will be demonstrated in this Hands-On Lab.\n\n=== \"Protections\"\n\n    1. TCP Connection Number Limit\u00a0(TCP Flood Prevention)\n    2. Add X-Forwarded-For\n    3. Client Management\n    4. IP List\n    5. IP Reputation\n    6. Quarantined source IP addresses\n    7. Known Bots\n    8. Geo IP\n    9. WebSocket protocol\n    10. Add HSTS Header\n    11. Protected Server Check\n    12. Allow Method\n    13. Mobile Application Identification\n    14. HTTP Request Limit/sec\u00a0(HTTP Flood Prevention)\n    15. TCP Connection Number Limit\u00a0(Malicious IP)\n    16. HTTP Request Limit/sec (Shared IP)\u00a0(HTTP Access Limit)\n    17. HTTP Authentication\n    18. Global Object\u00a0Allow\u00a0List\n    19. ADFS Proxy\n    20. URL Access\n    21. Mobile API Protection\n    22. Padding Oracle Protection\n    23. HTTP Protocol Constraints\n    24. File Parse\n    25. File Security\n    26. Web Shell Protection\n    27. Parameter Validation\n    28. Bot Deception\n    29. ML based Bot Detection\n    30. Cross-site request forgery (CSRF)\u00a0attacks\n    31. Protection for Man-in-the-Browser (MiTB) attacks\n    32. Biometrics Based Detection\n    33. XML Protection\n    34. JSON Protection\n    35. Signatures\n    36. SQL/XSS Syntax Based Detection\n    37. Site Publish\n    38. Hidden Fields Protection\n    39. Custom Policy\n    40. Threshold Based Detection\n    41. User Tracking\n    42. API Gateway\n    43. OpenAPI Validation\n    44. CORS Protection\n    45. URL Rewriting\u00a0(rewriting &amp; redirection)\n    46. ML based API Protection\n    47. File Compress\n    48. Cookie Security Policy\n    49. ML based Anomaly Detection\n\n=== \"Highlights\"\n\n    50. TCP Connection Number Limit\u00a0(TCP Flood Prevention)\n    51. ==Add X-Forwarded-For==\n    52. ==Client Management==\n    53. ==IP List==\n    54. IP Reputation\n    55. ==Quarantined source IP addresses==\n    56. Known Bots\n    57. ==Geo IP==\n    58. WebSocket protocol\n    59. Add HSTS Header\n    60. Protected Server Check\n    61. ==Allow Method==\n    62. Mobile Application Identification\n    1. ==HTTP Request Limit/sec\u00a0(HTTP Flood Prevention)==\n    2. TCP Connection Number Limit\u00a0(Malicious IP)\n    3. HTTP Request Limit/sec (Shared IP)\u00a0(HTTP Access Limit)\n    4. ==HTTP Authentication==\n    5. Global Object\u00a0Allow\u00a0List\n    6. ADFS Proxy\n    7. ==URL Access==\n    8. Mobile API Protection\n    9. Padding Oracle Protection\n    10. ==HTTP Protocol Constraints==\n    11. ==File Parse==\n    12. ==File Security==\n    13. ==Web Shell Protection==\n    14. ==Parameter Validation==\n    15. ==Bot Deception==\n    16. ML based Bot Detection\n    17. ==Cross-site request forgery (CSRF)\u00a0attacks==\n    18. ==Protection for Man-in-the-Browser (MiTB) attacks==\n    19. Biometrics Based Detection\n    20. XML Protection\n    21. JSON Protection\n    22. ==Signatures==\n    23. SQL/XSS Syntax Based Detection\n    24. Site Publish\n    25. ==Hidden Fields Protection==\n    26. ==Custom Policy==\n    27. Threshold Based Detection\n    28. ==User Tracking==\n    29. API Gateway\n    30. OpenAPI Validation\n    31. CORS Protection\n    32. ==URL Rewriting\u00a0(rewriting &amp; redirection)==\n    33. ML based API Protection\n    34. File Compress\n    35. ==Cookie Security Policy==\n    36. ==ML based Anomaly Detection==\n</code></pre> <p>The WAF policy DVWA_PROTECTION_PROFILE is already populated with protections that we will demonstrate in the next sections.</p> <p>??? note \"FortiWeb Policy\"     ## FortiWeb Policy</p> <pre><code>Log in to the FortiWeb GUI &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com:40030\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com:40030&lt;/a&gt;.\n\nBrowse to `Policy &gt; Web Protection Profile` and open **DVWA_PROTECTION_PROFILE**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.011.png)\n</code></pre> <p>Throughout the Hands-On Lab, we will utilize the Attack Logs as well as FortiView to gain a comprehensive view of the activity.</p> <p>??? note \"Security Monitoring with FortiView\"     ## Security Monitoring with FortiView</p> <pre><code>These are the most common views to monitor your device, traffic, and security posture.\n\n`Dashboard &gt; FortiView topology`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.012.png)\n\n`Dashboard &gt; FortiView Countries`\n\nYou can drill down each **Country**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.013.png)\n\n`Dashboard &gt; FortiView Threats`\n\nYou can drill down each **Threat**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.014.png)\n\n`Dashboard &gt; FortiView Countries`\n\nYou can drill down each **Source IP**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.015.png)\n\nAnd you can ban specific IPs.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.016.png)\n\n`Dashboard &gt; Blocked IPs`\n\nMonitoring &amp; Releasing Ban IPs.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.017.png)\n\n`Dashboard &gt; Status` (Throughput &amp; Attack Event History)\n\nYou can drill down each **Threat Level**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.018.png)\n\nYou can also add your own monitor view. We will use them later in this document.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.019.png)\n</code></pre> <p>This page provides you with instructions for demonstrating various FortiWeb protections using the DVWA Application.</p> <p>Given that we have limited time for the workshops, we suggest focusing first on the protections that seem most important to us. If you have extra time, you can choose to test other features.</p> <p>Each section of this lab is independent of the others, so have fun!</p> <p>??? note \"Signatures (Known Attacks)\"     ## Signatures</p> <pre><code>FortiWeb uses signatures to detect a wide range of attacks and data leaks, covering vulnerabilities listed in the OWASP Top 10 and beyond. These include cross-site scripting, SQL injection, remote and local file inclusion, OS commands, trojans/viruses, exploits, and leaks of sensitive server information and personal data.\n\n### Configuration\n\n`Web Protection &gt; Known Attacks &gt; Signatures`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.020.png)\n\n### Signature Update Management\n\nMake sure to approve the latest signatures.\n\nBrowse to `System &gt; Config &gt; FortiGuard &gt; Signature Update Management` and approve all new signatures.\n\nUse the Shift key to select everything and approve all at once.\n\n![](img/signature-update-management.png)\n\n\n### Performing Command Injection\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/&lt;/a&gt; and try one of these Command Injection attacks.\n\n```\n;ls -la\n```\n```\n;more /etc/passwd\n```\n```\n;ps -aux\n```\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.021.png)\n\nCommand Injection will be **blocked**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.022.png)\n\n### Attack Logs\n\n`Log&amp;Report &gt; Log Access &gt; Attack`\n\nDouble click on the last entry.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.023.png)\n\n### Performing SQL Injection\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/sqli/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/sqli/&lt;/a&gt; and try this SQL Injection attack.\n\n```\n' OR 1=1#\n```\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.024.png)\n\nSQL Injection will be **blocked**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.025.png)\n\n### Attack Logs\n\n`Log&amp;Report &gt; Log Access &gt; Attack`\n\n**Refresh Logs** and double click on the new entry.\n\n![](img/fwb-refresh-logs.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.026.png)\n</code></pre> <p>??? note \"Machine Learning\"     ## Machine Learning</p> <pre><code>The anomaly detection model of machine learning feature observes the URLs, parameters, and HTTP Method of HTTP and/or HTTPS sessions passing to your web servers. It builds mathematical models to detect abnormal traffic.\n\n### Configuring Machine Learning\n\nbrowse to `Policy &gt; Server Policy`, open `DVWA_POLICY`, go at the bottom page, and create your Machine Learning policy.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.029.png)\n\nEnter the domain name of your application. We will be using a **wildcard** domain. Click OK.\n\n```\n*.cloudapp.azure.com\n```\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.030.png)\n\nGet the [Machine Learning Model File](download/machine-learning-model.dat) and import it.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.032.png)\n\nBrowse to `Web Protection &gt; ML Based Anomaly Detection`, open the policy, and click on the **domain**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.033.png)\n\nClick on the **Parameter View** tab and select the **ip** parameter.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.034.png)\n\nThe **Parameter View** provides statistics associated with various parameters, including HMM learning stages, boxplots, and the distribution of anomalies. It also allows you to rebuild parameters or adjust the strictness level for anomaly detection.\n\nThe **diagram** illustrates the Distribution of Anomalies. The system determines the legitimacy of a request based on its probability score and the length of the parameter value.\n\nClick on **Test Sample**.\n\n| These are few samples you can test | Samples                   | Examine the Probability Score and Detection Result                 |\n|:---------------------------------- |:--------------------------|:-------------------------------------------------------------------|\n| A real IP                          |`1.1.1.1`                  | ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.035.png) |\n| A typo                             |`1.1.1..1`                 | ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.036.png) |\n| Another typo                       |`1.1.1.1&amp;`                 | ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.037.png) |\n| An email address                   |`abc@real.com`             | ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.038.png) |\n| SQL Injection                      |`'OR 1=1#`                 | ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.039.png) |\n| Zero Day                           |`A 'DIV' B - A 'DIV B`     | ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.040.png) |\n\n??? question \"Why FortiWeb employs two layers of machine learning?\"\n    FortiWeb employs a dual-layer machine learning approach to identify malicious attacks. The first layer utilizes the &lt;a href=\"https://en.wikipedia.org/wiki/Hidden_Markov_model\" target=\"_blank\"&gt;Hidden Markov Model (HMM)&lt;/a&gt; to monitor application access and collect data, which is used to build a mathematical model for each parameter and HTTP method. Once this model is established, FortiWeb assesses each incoming request against it to determine whether it is anomalous.\n\n    If the first machine learning layer flags a request as anomalous, FortiWeb engages its second layer to further scrutinize whether it constitutes a genuine attack or is merely a benign anomaly that can be disregarded. To accomplish this, FortiWeb incorporates pre-trained threat models that utilize &lt;a href=\"https://en.wikipedia.org/wiki/Support_vector_machine\" target=\"_blank\"&gt;Support Vector Machine (SVM)&lt;/a&gt; technology, each representing a specific type of attack, such as SQL Injection or Cross-site Scripting. These models have been trained using data from thousands of attack samples and are consistently updated by the FortiWeb Security Service. When new types of attacks emerge, the FortiGuard team analyzes them and updates the relevant threat models. These updated models are then distributed to all customer installations, similar to how signature updates are carried out.\n\n    ![](img/fwb-ml-two-layers.png)\n\n\n### Testing Machine Learning\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/&lt;/a&gt; and perform those 2 SQL Injections.\n\n```\n'OR 1=1#\n```\n```\nA 'DIV' B - A 'DIV B\n```\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.041.png)\n\n### Attack Logs\n\nThe first pattern is detected by **Signatures** **Detection** and the second one by **Machine Learning**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.042.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.043.png)\n\n??? question \"Why is the first attack blocked by signature-based protection, while the second is blocked through machine learning?\"\"\n    FortiWeb applies protection rules and performs profile scans in a specific order of execution as documented in &lt;a href=\"https://docs.fortinet.com/document/fortiweb/7.4.0/administration-guide/234292/sequence-of-scans\" target=\"_blank\"&gt;FortiWeb 7.4.0 Administration Guide - Sequence of Scans&lt;/a&gt;. If an HTTP request matches a known signature, it will be blocked immediately without ever reaching the machine learning engine. On the other hand, for zero-day attacks where no signature is effective, the machine learning engine takes over to detect and block the attack.\n</code></pre> <p>??? note \"Client Management\"     ## Client Management</p> <pre><code>Tracking a client by either the recognized cookie or the source IP, FortiWeb's client management feature identifies suspected attacks based on the clients. When a client triggers a threat, FortiWeb accumulates the threat score based on the configured threat weight value. When the client's threat score reaches a certain threshold, a corresponding blocking action is performed. To identify a visiting client, FortiWeb generates a unique client ID according to the cookie value or source IP.\n\n### Configuration\n\n`Policy &gt; Client Management`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.044.png)\n\n### Monitoring Clients\u2019 activities\n\n`Dashboard &gt; +`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.045.png)\n\n`Dashboard &gt; Client Management`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.046.png)\n</code></pre> <p>??? note \"X-Forwarded-For\"     ## X-Forwarded-For</p> <pre><code>In some topologies, you must configure FortiWeb to add X-headers such as:\n\n- X-Forwarded-For\n- X-Real-IP\n- True-Client-IP\n\nThe X-Forwarded-For (XFF) HTTP header field is a common method for identifying the originating IP address of a client connecting to a web server through an HTTP proxy or load balancer.\n\n### Configuration\n\nServer Objects &gt; X-Forwarded-For\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.049.png)\n\n### Checking HTTP header information\u2019s\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/phpinfo.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/phpinfo.php&lt;/a&gt; and check if you can see your client public IP.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.050.png)\n</code></pre> <p>??? note \"Cookie Security\"     ## Cookie Security</p> <pre><code>This protection prevents cookie-based attacks. A Cookie Security policy can:\n\n- detect cookie poisoning\n- encrypt or sign the cookies issued by the back-end servers\n- add security attributes to cookies\n\n### Configuration\n\nOn FortiWeb browse to `Web Protection &gt; Cookie Security` and open **DVWA_COOKIE_SECURITY**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.051.png)\n\n### Preventing cookie poisoning by tracking the cookie value\n\nBrowse to  &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/security.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/security.php&lt;/a&gt;\n\nRight click the page and select **Inspect**, go to **Storage** (Firefox) or **Application** (Chrome, Edge) and select **Cookies**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.052.png)\n\nThe security level of the DVWA application (Impossible, High, Medium, Low) is stored in a cookie.\n\nFirst, we'll change the security level using the legitimate method. From the web page, select **Medium** and click **Submit**. You'll notice that your security level has changed.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.053.png)\n\nNow, let's explore how to change our security level by manipulating the cookie named **security**. From the Inspect view, change its value to **high** and **reload** the page.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.054.png)\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.055.png)\n\n### Preventing cookie poisoning with cookie encryption\n\nWe just employed the **Signed Security Mode** to prevent tampering by tracking the cookie value.\n\nWe are now transitioning to the **Encrypted Security Mode**. This feature encrypts the cookie values sent by the back-end web server to clients, ensuring that clients only see encrypted cookies. FortiWeb automatically decrypts cookies submitted by clients before forwarding them to the back-end server, eliminating the need for any back-end server configuration changes.\n\nOn FortiWeb , browse to `Web Protection &gt; Cookie Security` and open **DVWA_COOKIE_SECURITY**.\n\nChange the **Security Mode** to **Encrypted** and click **OK**.\n\n![](img/fwb-cookie-security-encrypted.png)\n\n**Delete** those 3 cookies:\n\n- **cookiesession1**\n- **PHPSESSID**\n- **security**\n\n![](img/fwb-cookie-security-remove-cookies.png)\n\n**Reload** DVWA page.\n\nThe cookies are now **encrypted**. You can try again to change the security cookie value and reload the page. What's happening? Check the **Attack Logs**.\n\n![](img/fwb-cookie-security-encrypted-result.png)\n\n### Preventing client-side scripts from accessing the cookie\n\nDVWA's cookies (**PHPSESSID** and **security**) are set to **Secure** and **HTTPOnly**. The other cookies are not because they belong to FortiWeb which is not part of the policy.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.056.png)\n\n!!! note \"\"\n    A **Secure** cookie is a cookie that is only transmitted over HTTPS (Secure HTTP) connections. When a cookie is marked as \"secure,\" it tells the browser that the cookie should only be sent with requests to HTTPS URLs, thereby reducing the risk of exposing sensitive data in clear text over an insecure network. This attribute is particularly important for cookies that store sensitive information like authentication tokens or session identifiers.\n\n!!! note \"\"\n    An **HTTP Only** cookie is a type of web cookie that is only accessible by the server and not by client-side scripts. This attribute is set by the server when sending the cookie to the client, and it helps to mitigate the risk of cross-site scripting (XSS) attacks. When a cookie has the HttpOnly flag set, it means that the cookie cannot be accessed through client-side languages like JavaScript, making it more secure against certain types of web vulnerabilities.\n\nGo to the Browser **Console** and type `document.cookie`.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.057.png)\n\nThe output displays only those cookies that have the **HTTP Only** attribute set to false. Client-side scripts cannot access cookies that are marked as **HTTP Only**.\n\nOn FortiWeb browse to `Web Protection &gt; Cookie Security`, open **DVWA_COOKIE_SECURITY** and disable **HTTP Only**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.058.png)\n\nClear your browser's cache (or remove cookies from the browser's **Inspect** Element window).\n\nBrowse to  &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt;.\n\nCheck that **PHPSESSID** and **security** have **HTTP Only** disabled.\n\n![](img/fwb-cookie-security-httponly-false.png)\n\nGo to the Browser **Console** and type `document.cookie`.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.059.png)\n\nYou are now able to execute a script that shows cookies. There is no FortiWeb\u2019s log since this is a Browser Cookie Security enforcement.\n</code></pre> <p>??? note \"CSRF Protection\"     ## CSRF Protection</p> <pre><code>Cross-Site Request Forgery (CSRF) is a type of security vulnerability that dupes a web browser into executing an undesired action within an authenticated application.\n\nThe attack usually involves deceptive social engineering tactics, such as sending a misleading email or link to the victim. Because the user is already authenticated within the application when the attack occurs, it becomes challenging to differentiate between legitimate and fraudulent requests.\n\n### Configuration\n\n`Web Protection &gt; Advanced Protection &gt; CSRF Protection`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.069.png)\n\n### Preventing cross-site request forgery\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/csrf/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/csrf/&lt;/a&gt; and change the admin password.\n\nYou should see a token (**tknfv**) in the URL that has been added by FortiWeb, meaning that the request is protected and allowed.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.070.png)\n\nYou can **log out** and then **log in** again with your **new password**.\n\nMake sure you are authenticated to DVWA and browse to this &lt;a href=\"/csrf-demo-page.html\" target=\"_blank\"&gt;demo page&lt;/a&gt; to generate the attack.\n\nThe aforementioned page employs Cross-Site Request Forgery to exploit your authenticated session in order to initiate a password change.\n\n![](img/CSRF-DemoPage.png)\n\nRight-click and choose **Inspect** on the web page to reveal the hidden link.\n\nYou can **log out** and then **log in** again: your password has not been changed.\n\n### Attack Logs\n\nThe password change has been blocked by FortiWeb.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.072.png)\n\n??? tip \"Reseting the database for the next Labs\"\n    - Browse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/setup.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/setup.php&lt;/a&gt;\n    - Click on **Create / Reset Database**\n    - You can now login with the original password\n\n    ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.006.png)\n</code></pre> <p>??? note \"Hidden Fields Protection\"     ## Hidden Fields Protection</p> <pre><code>Hidden form inputs are often written into an HTML page by the web server when it serves that page to the client and are not visible on the rendered web page. Because HTTP is essentially stateless, like cookies, hidden form inputs are one way that web applications can use to remember session data from one page request to the next (called \u201cpersistence\u201d).\n\nSince they are not rendered visible, hidden inputs are sometimes erroneously perceived as safe. But like session cookies, hidden form inputs store the software\u2019s state information client-side, instead of server-side. This makes it vulnerable.\n\n### Configuration\n\n`Web Protection &gt; Input Validation &gt; Hidden Fields`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.078.png)\n\n### Testing hidden field protection\n\nDownload those small and large images to your computer:\n\n  - &lt;a href=\"/download/small.png\" target=\"_blank\"&gt;Small file&lt;/a&gt; (14 Ko)\n  - &lt;a href=\"/download/large.png\" target=\"_blank\"&gt;Large file&lt;/a&gt; (433 Ko)\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload&lt;/a&gt; and **upload** both images.\n\nYou may upload images smaller than 100 KB, but uploading images larger than 100 KB is not allowed.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.079.png)\n\nUploading images larger than 100 KB is not allowed.\n\nRight click the page, select **Inspect**, go to **Inspector** tab (Firefox) or **Element** tab (Chrome, Edge) and find the **MAX_FILE_SIZE** hidden form.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.080.png)\n\nChange the value to **500,000** and try to upload the large image again. **The request is blocked**.\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.081.png)\n</code></pre> <p>??? note \"File Security\"     ## File Security</p> <pre><code>You can configure FortiWeb to perform the following tasks:\n\n- Restrict file uploads based upon file type and size\n- Scan uploaded files for viruses\n- Submit uploaded files to FortiSandbox or FortiNDR\n\n### Configuration\n\n`Web Protection &gt; Input Validation &gt; File Security`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.086.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.087.png)\n\n### Testing file security\n\nDownload &lt;a href=\"https://secure.eicar.org/eicar_com.zip\" target=\"_blank\"&gt;https://secure.eicar.org/eicar_com.zip&lt;/a&gt; on your computer.\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/&lt;/a&gt; and upload **eicar_com.zip**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.088.png)\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.089.png)\n</code></pre> <p>??? note \"Web Shell Detection\"     ## Web Shell Detection</p> <pre><code>Attackers may attempt to upload Trojan horse code (written in scripting languages such as PHP and ASP) to the back-end web servers. The Trojan then infects clients who access an infected web page.\n\n### Configuration\n\n`Web Protection &gt; Input Validation &gt; Web Shell Detection`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.090.png)\n\n### Testing Web Shell detection\n\nFirst you need to **disable Antivirus Scan** as this may overlap Web Shell detection.\n\nBrowse to `Web Protection &gt; Input Validation &gt; File Security`, open **DVWA_FILE_SECURITY_POLICY** and disable Antivirus Scan.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.091.png)\n\nDownload a Webshell on Github: &lt;a href=\"https://raw.githubusercontent.com/tennc/webshell/master/php/wso/wso.php\" target=\"_blank\"&gt;https://raw.githubusercontent.com/tennc/webshell/master/php/wso/wso.php&lt;/a&gt;\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/&lt;/a&gt; and upload wso.php.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.092.png)\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.093.png)\n</code></pre> <p>??? note \"Let\u2019s Encrypt Certificates\"     ## Let\u2019s Encrypt Certificates</p> <pre><code>Let's Encrypt certificates are free and valid for 90 days, during which renewal can take place at any time. This is handled by an automated process designed to overcome manual creation, validation, signing, installation, and renewal of certificates for secure websites.\n\n### Configuration\n\n`Server Objects &gt; Certificates &gt; Let's Encrypt`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.140.png)\n\n### Generating a new Let\u2019s Encrypt certificate\n\nUntil now we have connected to the application with the default certificate.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.141.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.142.png)\n\nLet\u2019s configure FortiWeb to automatically obtain (and renew) a certificate from Let's encrypt.\n\n!!! tip \"\"\n    For this lab, **we need to temporarily shutdown FWB-B**. It's crucial that the Primary member, FWB-A, which manages the configuration, is also the one handling the traffic. This is because the Let's Encrypt procedure relies on a challenge mechanism. If FWB-A sets up a challenge, but Let's Encrypt connects to FWB-B to verify it, the certificate generation will fail.\n\n    You can turn FWB-B back on after completing this lab.\n\nBrowse to `Server Objects &gt; Certificates &gt; Let's Encrypt` and check that the domain is correct.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.143.png)\n\nBrowse to `Policy &gt; Server Policy`, open **DVWA_POLICY**, choose **Let's Encrypt** option and select **DVWA_LE_CERTIFICATE**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.144.png)\n\nGo back to `Server Objects &gt; Certificates &gt; Let's Encrypt` and click on **Issue** (1).\n\nBe patient and avoid clicking on **Issue** multiple times. Refresh the page to check for status updates. You can also view the **Event Logs** to monitor the progress of the process.\n\nAfter an average of 30 seconds, the **Status** (2) should be green.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.145.png)\n\nClose and open your browser.\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt;.\n\nNow you should have a valid certificate.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.146.png)\n\n### Event Logs\n\nCheck the Event Logs.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.147.png)\n</code></pre> <p>??? note \"Allow Method\"     ## Allow Method</p> <pre><code>You can configure policies that allow only specific HTTP request methods. This can be useful for preventing attacks, such as those exploiting the HTTP method TRACE.\n\nMany web applications only require GET and POST. Disabling all unused methods reduces the potential attack surface area for attackers.\n\n### Configuration\n\n`Web Protection &gt; Access &gt; Allow Method`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.097.png)\n\n### Testing Allow Method\n\n&lt;span style=\"color:red;\"&gt;This lab is only compatible with **Firefox**.&lt;/span&gt;\n\n- Open **Firefox** and Browse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt;\n\n- Right-click anywhere on the page and select \"**Inspect**\" or press F12\n\n- Click on the **Network** tab (1).\n\n- **Reload** the page by pressing F5 or clicking the **reload icon** (2) in the toolbar.\n\n- Choose any request, right-click on it, and select **Edit and Resend** (3).\n\n- In the new panel on the left, there is a dropdown menu for selecting the **HTTP method** (4). Click the dropdown arrow and select **HEAD** as the HTTP method you want to use for this request.\n\n- Click the **Send** button (5) to resend the request with the modified HTTP method.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.098.png)\n\n### Attack logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.100.png)\n</code></pre> <p>??? note \"Bot Mitigation Policy\"     ## Bot Mitigation Policy</p> <pre><code>To quickly protect websites, mobile apps and APIs from automated threats, you can configure the bot mitigation feature to check more specific signatures such as client events, and occurrence of suspicious behaviors, etc. of regular clients.\n\n### Configuration\n\n`Bot Mitigation &gt; Bot Mitigation Policy`\n\nBot Mitigation Policy protects from automated threats with different methods:\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.101.png)\n\n| Detection Method          | Description   |\n|---------------------------|---------------|\n| **Bot Deception**             | Inserts invisible links in HTML responses to distinguish between regular clients and malicious bots like web crawlers. |\n| **Biometrics-based Detection** | Uses client events like mouse movement and keyboard activity to determine whether a request is coming from a human or a bot. |\n| **Threshold-based Detection**  | Sets rules based on occurrence, time period, and severity of suspicious behavior to assess whether a request is human or bot-generated. |\n| **Known Bots**                | Protects against malicious bots like DoS and spam, while allowing known good bots like search engines. |\n\n### Testing Bot Deception\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/login.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/login.php&lt;/a&gt;, right click and select \u201cView Page Source\u201d.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.102.png)\n\nThere\u2019s a hidden link. Malicious bots like web crawler may request the link\u2026\n\nClick on it or Browse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/fake_url.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/fake_url.php&lt;/a&gt;.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.103.png)\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.104.png)\n</code></pre> <p>??? note \"DoS Protection Policy\"     ## DoS Protection Policy</p> <pre><code>You can protect your web assets from a wide variety of denial of service (DoS) attacks.\n\nDoS features are organized by which open system interconnections (OSI) model layer they use primarily to apply the rate limit:\n\n- Application layer (HTTP or HTTPS)\n- Network and transport layer (TCP/IP)\n\n### Configuration\n\n`DoS Protection &gt; DoS Protection Policy`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.105.png)\n\n### Testing DoS HTTP Flood\n\nFor this test, HTTP request limit / sec is set very low (5 instead of default 500).\n\nGo to any page and refresh very quickly with F5. Alternatively, hold down SHIFT button and click the Reload button several times.\n\nGo to Attack Logs.\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.106.png)\n</code></pre> <p>??? note \"URL Rewriting\"     ## URL Rewriting</p> <pre><code>URL rewriting can prevent the disclosure of underlying technology or website structures to HTTP clients.\n\nAside from security reasons, rewriting and redirects can be for aesthetic or business purposes, too.\n\n### Configuration\n\n`Application Delivery &gt; URL Rewriting`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.107.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.108.png)\n\n### Testing URL Rewrite (301 Redirect)\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/fortinet\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/fortinet&lt;/a&gt;\n\nYou will be redirected to **www.fortinet.com**.\n\n### Testing URL Rewrite (Rewrite HTTP Header)\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt; and authenticate.\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/change\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/change&lt;/a&gt;.\n\nYou will be redirected to /vulnerabilities/csrf/ page.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.109.png)\n\n### Traffic logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.110.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.111.png)\n</code></pre> <p>??? note \"User Tracking\"     ## User Tracking</p> <pre><code>The user tracking feature allows you to track sessions by user and capture a username for reference in traffic and attack log messages.\n\n### Configuration\n\n`Tracking &gt; User Tracking`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.128.png)\n\n### Testing User Tracking\n\nLogin to DVWA with any username...\n\n| Username | Password |\n|:---------|:---------|\n| admin    | password |\n| gordonb  | abc123   |\n| 1337     | charley  |\n| pablo    | letmein  |\n| smithy   | password |\n\n...and perform any attack in the list:\n\n| URL                                                                                                                       | Attack pattern                                                      |\n|:--------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|\n| &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/\" target=\"_blank\"&gt;/vulnerabilities/exec/&lt;/a&gt;     | **`;ls`**                                                           |\n| &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/sqli/\" target=\"_blank\"&gt;/vulnerabilities/sqli/&lt;/a&gt;     | **`\u2018OR 1=1#`**                                                      |\n| &lt;a href=\"/csrf-demo-page.html\" target=\"_blank\"&gt;CSRF&lt;/a&gt;                                                                   | The page will exploit CSRF attack                                   |\n| &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/\" target=\"_blank\"&gt;/vulnerabilities/upload/&lt;/a&gt; | Change the hidden field **MAX_FILE_SIZE** and reload the page (F5)  |\n| &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/security.php\" target=\"_blank\"&gt;/security.php&lt;/a&gt;                       | Change security cookie value to **medium** and reload the page (F5) |\n| &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/upload/\" target=\"_blank\"&gt;/vulnerabilities/upload/&lt;/a&gt; | Upload **eicar.zip**                                                |\n\n### Attack Logs\n\nBrowse to **Attack Logs** and right click a column heading to select the columns to display. Choose **Username** and **Apply**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.129.png)\n\nThe **Username** will be the last column, but you can move it to the left.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.130.png)\n</code></pre> <p>The remaining labs are optional and can be explored if you have extra time.</p> <p>??? example \"Custom Policy\"     ## Custom Policy</p> <pre><code>Custom rules provide a degree of flexibility for complex conditions. You can combine any or all of these criteria:\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.060.png)\n\n### Configuration\n\nExample #1 \u2013 Detecting Vulnerability Scanning\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.061.png)\n\nExample #2 \u2013 Detecting Brute Force Login\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.062.png)\n\n### Testing Vulnerability Scanning\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/sqli/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/sqli/&lt;/a&gt; and submit `\u2018or 1=1#` 11 times.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.063.png)\n\nFortiWeb blocks SQL injection for the first 10 requests and quarantine the IP at the 11&lt;sup&gt;th&lt;/sup&gt; request.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.064.png)\n\nCheck the blocked IPs and release it for the next test.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.065.png)\n\n\n### Testing brute force attack\n\nTry to login 20 times very quickly with user \u201cp\u201d and no password. You can also reduce the configuration to 3 occurrences for testing purpose. **Don\u2019t forget to configure it back to 20 after your test.**\n\nAfter few requests, FortiWeb enforces a CAPTCHA to check if this is a bot or not. You can put a wrong answer to simulate a bot activity.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.066.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.067.png)\n\nCheck the blocked IPs and release it for the next test.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.065.png)\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.068.png)\n</code></pre> <p>??? example \"HTTP Protocol Constraints\"     ## HTTP Protocol Constraints</p> <pre><code>Protocol constraints govern features such as the HTTP header fields in the protocol itself, as well as the length of the HTML, XML, or other documents or encapsulated protocols carried in the HTTP body payload.\n\nUse protocol constraints to prevent attacks such as buffer overflows. Buffer overflows can occur in web servers and applications that do not restrict elements of the HTTP protocol to acceptable lengths, or that mishandle malformed requests. Such errors can lead to security vulnerabilities.\n\n### Configuration\n\n`Web Protection &gt; Protocol &gt; HTTP`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.047.png)\n\n### Performing duplicate name attack\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/brute/?username=admin&amp;username=admin&amp;password=password&amp;Login=Login#\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/brute/?username=admin&amp;username=admin&amp;password=password&amp;Login=Login#&lt;/a&gt;\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.048.png)\n</code></pre> <p>??? example \"HTTP Header Security\"     ## HTTP Header Security</p> <pre><code>HTTP response security headers are a set of standard HTTP response headers proposed to prevent or mitigate known XSS, clickjacking, and MIME sniffing security vulnerabilities. These response headers define security policies to client browsers so that the browsers avoid exposure to known vulnerabilities when handling requests.\n\nWhen FortiWeb's HTTP Security Headers feature is enabled, headers with specified values are inserted into HTTP responses coming from the backend web servers. This is a quick and simple solution to address the security vulnerabilities on your website without code and configuration changes. The following includes the security headers that FortiWeb can insert into responses:\n\n```py\nX-Frame-Options: DENY\nX-Frame-Options: SAMEORIGIN\nX-Frame-Options: ALLOW-FROM\nX-Content-Type-Options: nosniff\nX-XSS-Protection: 1\nX-XSS-Protection: 1; mode=block\nContent-Security-Policy: default-src 'self'\nFeature-Policy: microphone 'none'; geolocation 'none'\nReferrer-Policy: no-referrer\nReferrer-Policy: no-referrer-when-downgrade\nReferrer-Policy: same-origin\nReferrer-Policy: origin\nReferrer-Policy: strict-origin\nReferrer-Policy: origin-when-cross-origin\nReferrer-Policy: strict-origin-when-cross-origin\nReferrer-Policy: unsafe-url\n```\n\n### Configuration\n\nWeb Protection &gt; Advanced Protection &gt; HTTP Header Security\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.073.png)\n\n### Testing HTTP Header Security\n\nRight click on the Web page, select **Inspect**, select **Network** tab, browse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt;, **reload** the page, select the first **entry**, search for **Response Header** and find the 3 **X-Headers**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.074.png)\n</code></pre> <p>??? example \"Parameter Validation\"     ## Parameter Validation</p> <pre><code>You can configure rules to validate parameters (input) of your web applications.\n\nFor example, one web page might have an HTML form with multiple inputs, including:\n\n- A username\n- A password\n- A preference for whether or not to remember the login\n\nWithin the input rule for that web page, you can define separate rules for each parameter in the request: one rule for the **username** parameter, one rule for the **password** parameter, and one rule for the **preference** parameter. You can use the password rule to enforce password complexity by requiring it to match a\u00a0**Level 2 Password**\u00a0data type.\n\n### Configuration\n\n`Web Protection &gt; Input Validation &gt; Parameter Validation`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.075.png)\n\n### Testing parameter validation\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/exec/&lt;/a&gt;. In the **`Enter an IP address`** form enter a random string that is not an IP.\n\nYou\u2019re not blocked because the rule action is **Alert**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.076.png)\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.077.png)\n</code></pre> <p>??? example \"Man in the Browser (MiTB) Protection\"     ## Man in the Browser (MiTB) Protection</p> <pre><code>The Man-in-the-Browser (MiTB) attack uses Trojan Horse to intercept and manipulate calls between the browser and its security mechanisms or libraries on-the-fly. The Trojan Horse sniffs or modifies transactions as they are formed on the browser, but still displays back the user's intended transaction. The most common objective of this attack is to cause financial fraud by manipulating transactions of Internet Banking systems, even when other authentication factors are in use.\n\nTo protect the user inputs from being attacked by MiTB, FortiWeb implements security rules including obfuscation, encryption, anti-keylogger, and Ajax request allow list.\n\n### Configuration\n\n`Web Protection &gt; Advanced Protection &gt; Man in the Browser Protection`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.082.png)\n\n### Testing MitB\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/brute/\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/brute/&lt;/a&gt;\n\nRight click the page, select **Inspect**, go to **Inspector** tab (Firefox) or **Element** tab (Chrome, Edge) and find the username / password form.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.083.png)\n\nNow go to the web protection profile configuration.\n\n`Policy &gt; Web Protection Profile &gt; DVWA_PROTECTION_PROFILE`\n\nThe \u201cMan in the Browser Protection\u201d setting should be empty. Select DVWA_PROTECTION_PROFILE and click OK.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.084.png)\n\nRefresh your browser. The form is now protected with MitB.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.085.png)\n</code></pre> <p>??? example \"URL Access\"     ## URL Access</p> <pre><code>URL access rules define which HTTP requests FortiWeb accepts or denies based on:\n\n- Host name\n- URL\n- Origin of the request.\n\n### Configuration\n\nWeb Protection &gt; Access &gt; URL Access\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.094.png)\n\n### Testing URL Access\n\nBrowse to [https://@PREFIX.@REGION.cloudapp.azure.com/about.php](https://@PREFIX.@REGION.cloudapp.azure.com/vulnerabilities/about.php)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.095.png)\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.096.png)\n</code></pre> <p>??? example \"HTTP Authentication\"     ## HTTP Authentication</p> <pre><code>FortiWeb can authenticate browsers before they are permitted to access a web page.\n\n### Configuration\n\n`User &gt; Local User`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.112.png)\n\n`User &gt; User Group &gt; User Group`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.113.png)\n\n`Application Delivery &gt; Authentication`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.114.png)\n\n### Testing authentication\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/instructions.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/instructions.php&lt;/a&gt;.\n\nAuthenticate with username `demo`, password `demo`.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.115.png)\n</code></pre> <p>??? example \"IP List\"     ## IP List</p> <pre><code>You can define which source IP addresses are trusted clients, undetermined, or distrusted.\n\n### Configuration\n\n`IP Protection &gt; IP List`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.116.png)\n\n### Testing IP List\n\nBrowse to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com/phpinfo.php\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com/phpinfo.php&lt;/a&gt;.\n\nCopy your **public IP** located in `HTTP Headers Information &gt; X-Forwarded-For`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.117.png)\n\nOn FortiWeb, Browse to `IP Protection &gt; IP List` and add your public IP in the Block IP List.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.118.png)\n\nRefresh your page on DVWA. You should be blocked.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.119.png)\n\n!!! warning \"Warning\"\n    &lt;center&gt;**Remove your IP from the list!**&lt;/center&gt;\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.120.png)\n</code></pre> <p>??? example \"FortiGate Quarantined IPs\"     ## FortiGate Quarantined IPs</p> <pre><code>FortiGate can maintain a list of source IPs that it prevents from interacting with the network and protected systems. You can configure FortiWeb to receive this list of IP addresses at intervals you specify. You can then configure an inline protection profile to detect the IP addresses in the list and take an appropriate action.\n\n### Configuration\n\n`System &gt; Config &gt; FortiGate Integration`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.121.png)\n\n### Testing FortiGate integration\n\nOn FortiWeb browse to `System &gt; Config &gt; FortiGate Integration` and change the admin credentials with yours.\n\nOn FortiGate browse to `Dashboard &gt; Quarantine Monitor` and manually add a **Ban IP**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.122.png)\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.123.png)\n\nOn FortiWeb browse to `Dashboard &gt; Blocked IPs`. You should see the new IP received from FortiGate.\n</code></pre> <p>??? example \"GEO IP\"     ## GEO IP</p> <pre><code>While numerous websites have a global reach, some are region-specific. For instance, government web applications often cater exclusively to their own residents.\n\n### Configuration\n\n`IP Protection &gt; Geo IP`\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.124.png)\n\n### Testing Geo IP\n\nbrowse to `IP Protection &gt; Geo IP` and add Canada as new Country to block.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.125.png)\n\nNow try to go on DVWA; you should be blocked.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.126.png)\n\n!!! warning \"Warning\"\n    &lt;center&gt;**Remove Canada from the list!**&lt;/center&gt;\n\n### Attack Logs\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.127.png)\n</code></pre> <p>??? example \"Vulnerability Scanner\"     ## Vulnerability Scanner</p> <pre><code>You can scan your web servers for known vulnerabilities, which helps you design protection profiles.\n\n### Configuration\n\nWeb Vulnerability Scan &gt; Scan Profile\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.131.png)\n\n### Performing a scan\n\nOpen a browser to DVWA, authenticate and copy the PHPSESSID cookie value.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.132.png)\n\nOn FortiWeb browse to `Web Vulnerability Scan &gt; Scan Profile` and configure the Customer Headers as follow with your `PHPSESSID` value.\n\n```py\nCookie: security=low; PHPSESSID=evgihu3t04ht0tj5agcin4vec1\n```\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.133.png)\n\nClick OK.\n\nbrowse to `Web Vulnerability Scan &gt; Web Vulnerability Scan Policy` and run the scan.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.134.png)\n\nCheck the logs.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.135.png)\n\nbrowse to `Scan History`, select a line and click on Download.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.136.png)\n\nDownload the XML report.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.137.png)\n\nbrowse to `Scanner Integration` and import the XML report.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.138.png)\n\nYou can choose to mitigate a found vulnerability.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.139.png)\n</code></pre>"},{"location":"hol-nsg-fgt-lab-1/","title":"Protecting Web Application Using Azure Network Security Groups and FortiGate","text":""},{"location":"hol-nsg-fgt-lab-1/#accessing-dvwa-via-nsgs","title":"Accessing DVWA via NSG's","text":"<p>The first step in this exercise will be to create a Network Security Group and associate it to the subnet where the DVWA instance is deployed.</p> <p>Tip</p> <p>Click on the images to view them in a larger format.</p> <p>??? note \"Creating a Network Security Group\"     In the search bar type Network Security Groups, and select the non-classic option.</p> <pre><code>![](img/networkSecurityGroup.png)\n\nCreate a new Security Group.\n\n![](img/AddnetworkSecurityGroup.png)\n\nSelect the Resource Group **@RESOURCE_GROUP_NAME** and give the Network Security Group a **unique name**.\n\n**Review +Create** the Resource.\n\n![](img/networkSecurityGroup-filled.png)\n\nOnce created, Click on **Go to Resource** to be redirected to your newly created NSG.\n\n![](img/networkSecurityGroup-created.png)\n\nNavigate to the **Inbound Security Rules** menu Item.\n\n![](img/networkSecurityGroup-InboundSecurityRules.png)\n\nCreate new entries to allow **HTTP, HTTPS, SSH** services from any sources.\n\n| AllowAnyHTTPInbound                                                                                                    | AllowAnyHTTPSInbound                                                                                                    | AllowAnySSHInbound                                                                                                    |\n|------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------|\n| **Source** = Any &lt;br&gt; **Source Port** = Any &lt;br&gt; **Destination** = Any &lt;br&gt; **Service** = HTTP &lt;br&gt; **Action** = Allow | **Source** = Any &lt;br&gt; **Source Port** = Any &lt;br&gt; **Destination** = Any &lt;br&gt; **Service** = HTTPS &lt;br&gt; **Action** = Allow | **Source** = Any &lt;br&gt; **Source Port** = Any &lt;br&gt; **Destination** = Any &lt;br&gt; **Service** = SSH &lt;br&gt; **Action** = Allow |\n\n![](img/networkSecurityGroup-Configure.PNG)\n\nOnce you've created the corresponding rules, you'll see your rules, in addition to the rules Azure had implicitely configured:\n\n![](img/networkSecurityGroup-InboundSecurityRulesComplete.png)\n\nNavigate to the **Subnets** menu and **Associate** the Network security group to the **DMZProtectedA**  Subnet.\n\n![](img/networkSecurityGroup-Association.png)\n\n![](img/networkSecurityGroup-Associated.png)\n</code></pre> <p>??? note \"Testing your Network Security Group\"     In Azure CLI, print your deployment Outputs and click on http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com</p> <pre><code>``` py\naz deployment group show -g @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n```\n\n![](img/BicepOutputviaFGT.png)\n\nLog in to DVWA using the credentials **admin** and **password**.\n\n![](img/dvwalogin.PNG)\n\nNavigate to the **SQL Injection** menu item and type:\n\n```\n' OR 1=1#\n```\n\n![](img/dvwaSQLi.png)\n\nNotice the attack was not prevented.\n\n![](img/dvwaSQLi-Result.png)\n\n**Why?** After the NSG permitted access to the DVWA Workload on Port 80 (HTTP) no subsequent inspection occured.\n</code></pre>"},{"location":"hol-nsg-fgt-lab-1/#accessing-dvwa-via-fortigate","title":"Accessing DVWA via FortiGate","text":"<p>Now, we will execute the same attack, but this time, we will secure the DVWA Workload behind the FortiGate Firewall.</p> <p>??? note \"Testing SQL Injection Attack\"     Log in to the Primary FortiGate using the credentials you established during deployment.</p> <pre><code>```py\naz deployment group show -g  @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n```\n\n![](img/BicepOutputAccessFGT.png)\n\nOnce logged in to the FortiGate, edit the firewall policy named **DVWA-HTTP-Inbound_Access**. Enable all the security profiles with their default settings.\n\n![](img/firewallPolicyToggle.png)\n\nClick OK to apply the changes.\n\nBrowse again to &lt;a href=\"http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/sqli/\" target=\"_blank\"&gt;http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/sqli/&lt;/a&gt; and enter this **SQL injection** attack into the form.\n\n```py\n' OR 1=1#\n```\n\n![](img/dvwaSQLi.png)\n\nNotice that the page is hung.\n\nLet's dive deeper and look at the FortiGate's Log. Open the **Security Events**, select the **Logs** tab and use the **Intrusion Prevention** filter.\n\n![](img/securityEventsIPSLog.PNG)\n\n**Why was this attack dropped?** The attack triggered a signature set to block within the FortiGate's IPS Security Profile.\n</code></pre> <p>??? note \"Testing Command Injection Attack\"     Now lets try a Command Injection attack.</p> <pre><code>Browse to &lt;a href=\"http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/exec/\" target=\"_blank\"&gt;http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/exec/&lt;/a&gt; and enter this **Command injection** attack into the form.\n\n```py\n;ps aux\n```\n\n![](img/dvwaCommandInjection.png)\n\n**Why was the attack let through?** The attack did not match a known IPS signature. Let's enhance the capabilities of the FortiGate by activating the **Web Application Firewall** security profile.\n</code></pre> <p>??? note \"Enable WAF on FortiGate\"     Enable the Web Application Firewall Security Profile from <code>System -&gt; Feature Visibility</code></p> <pre><code>![](img/fortigateWAF.png)\n\nOnce enabled, go back to the **Firewall Policy** and edit the **DVWA-HTTP-Inbound_Access** Firewall Policy.\n\nToggle the **Inspection Mode** to **Proxy-Based** and enable the default **Web Application Firewall** Security Profile.\n\n![](img/fortigateWAFRule.png)\n\nBrowse to &lt;a href=\"http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/exec/\" target=\"_blank\"&gt;http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/exec/&lt;/a&gt; and enter the **Command injection** attack again.\n\n```py\n;ps aux\n```\n\nThe **Command Injection** should now be prevented.\n\n![](img/WAFDrop.png)\n\nThe attack is blocked because WAF signatures have been activated.\n</code></pre> <p>??? note \"Conclusion\"     Did you notice that all of the attacks stopped by the FortiGate were all stopped based on existing signatures?</p>"},{"location":"hol-nsg-fgt-lab-1/#demonstrating-non-signature-based-attacks-via-fortigate","title":"Demonstrating non-signature based attacks via FortiGate","text":"<p>In this section, we will demonstrate various web application attacks to showcase and highlight the significance of the protections the Fortiweb will bring when compared to it's Next Generation Firewall counterpart.</p>"},{"location":"hol-nsg-fgt-lab-1/#csrf-attack-via-fortigate","title":"CSRF Attack via FortiGate","text":"<p>??? question \"What is Cross site request forgery (CSRF) attack?\"     Cross-Site Request Forgery (CSRF) is a type of security vulnerability that dupes a web browser into executing an undesired action within an authenticated application.</p> <pre><code>The attack usually involves deceptive social engineering tactics, such as sending a misleading email or link to the victim. Because the user is already authenticated within the application when the attack occurs, it becomes challenging to differentiate between legitimate and fraudulent requests.\n\n![](img/CSRF-Attack.png)\n</code></pre> <p>??? note \"Authenticating to the Web Application\"     To successfully run the CSRF Attack, you must first authenticate yourself within the application.</p> <pre><code>Browse to &lt;a href=\"http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com&lt;/a&gt; and log in using the username **admin** and password **password**.\n\n??? tip \"Troubleshooting - If you encounter any authentication issues\"\n\n    - Browse to &lt;a href=\"http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/setup.php\" target=\"_blank\"&gt;http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/setup.php&lt;/a&gt;\n\n    - Click on **Create / Reset Database**\n\n    ![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.006.png)\n</code></pre> <p>??? note \"Executing CSRF Attack\"     Once authenticated to DVWA, click on the LINK bellow to generate the attack.</p> <pre><code>| ![](img/outlook-logo.png) |\n|---------------------------|\n| **Dear user**, &lt;br&gt; All Hotmail customers have been upgraded to Outlook.com. Your Hotmail Account services has expired. &lt;br&gt; Due to our new system upgrade to Outlook. In order for it to remain active &lt;br&gt; follow the &lt;a href=\"http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/csrf/?password_new=pwned&amp;password_conf=pwned&amp;Change=Change#\" target=\"_blank\"&gt;&lt;strong&gt;LINK&lt;/strong&gt;&lt;/a&gt; Sign in Re-activate your account to Outlook. &lt;br&gt; Thanks, &lt;br&gt; The Microsoft account team |\n\nThe link employs **Cross-Site Request Forgery** to exploit your authenticated session in order to initiate a password change.\n\n![](img/DVWA-CSRF-Password-Change.png)\n\nYour password has been changed without your knowledge.\n\nLogout of DVWA and Log back in using `admin:pwned`\n</code></pre> <p>??? note \"Reseting the database for the next Lab\"     - Browse to http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/setup.php     - Click on Create / Reset Database     - You can now login with the original password</p> <pre><code>![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.006.png)\n</code></pre> <p>??? note \"Conclusion\"     We have observed that FortiGate provides an additional layer of protection compared to NSGs, thanks to its WAF signatures. However, we can see that more advanced attacks like CSRF are not addressed by FortiGate.</p>"},{"location":"hol-nsg-fgt-lab-1/#cookie-poisoning-via-fortigate","title":"Cookie Poisoning via FortiGate","text":"<p>??? question \"What is Cookie Poisoning?\"</p> <pre><code>In this lab, we will delve into the world of cookies - data stored in a user's browser that is specific to a website and session. These cookies serve a variety of purposes, from tracking user behavior to personalizing the online experience. However, they are also susceptible to cookie poisoning, a form of unauthorized manipulation by attackers aiming to gain access to sensitive information or services. This is particularly concerning because cookies often contain authentication data and other sensitive details, making them a prime target for hackers.\n</code></pre> <p>??? note \"Changing Security Level Through Legitimate Web App Interactions\"     Browse to @PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/security.php</p> <pre><code>Right click the page and select **Inspect**, go to **Storage** (Firefox) or **Application** (Chrome, Edge) and select **Cookies**.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.052.png)\n\nThe security level granted to the user is stored in the cookie.\n\nFrom the **Web page**, select **Medium** and click **submit**. This is a legitimate action, and your security level has changed.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.053.png)\n</code></pre> <p>??? note \"Overriding Security Level with Malicious Cookie Manipulation\"     Instead, now change the security cookie value manually to low and reload the page.</p> <pre><code>![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.052.png)\n\nNotice we were able change the DVWA's security setting by tampering with the value of the **security cookie**.\n</code></pre>"},{"location":"hol-nsg-fgt-lab-1/#hidden-fields-manipulation-via-fortigate","title":"Hidden Fields Manipulation via FortiGate","text":"<p>??? question \"What is Hidden Fields\"     Hidden form inputs are often written into an HTML page by the web server when it serves that page to the client and are not visible on the rendered web page. Because HTTP is essentially stateless, like cookies, hidden form inputs are one way that web applications can use to remember session data from one page request to the next (called \u201cpersistence\u201d).</p> <pre><code>Since they are not rendered visible, hidden inputs are sometimes erroneously perceived as safe. But like session cookies, hidden form inputs store the software\u2019s state information client-side, instead of server-side. This makes it vulnerable.\n</code></pre> <p>??? note \"Enforcing File Size Limitations \u2013 Successfully Blocking a Large File Upload\"     Download those 2 images to your computer:</p> <pre><code>- [Small Image](download/small.png) (14Ko)\n- [Large Image](download/large.png) (433Ko)\n\nGo to &lt;a href=\"http://@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/upload\" target=\"_blank\"&gt;@PREFIX-fgt-to-dvwa.@REGION.cloudapp.azure.com/vulnerabilities/upload&lt;/a&gt; and upload the two images one at a time.\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.079.png)\n\nThe website enforces a policy that prohibits the uploading of images larger than 100 KB. Let's see how we can bypass the policy restrictions.\n</code></pre> <p>??? note \"Bypassing Policy Restrictions to Upload a Large File\"     Right click the page, select Inspect, go to Inspector tab (Firefox) or Element tab (Chrome, Edge) and find the MAX_FILE_SIZE hidden form.</p> <pre><code>![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.080.png)\n\nChange the value to **500,000** and try to upload the large image again. Notice you were now able to successfully upload the larger file.\n</code></pre> <p>??? note \"Conclusion\"     In summary, though the FortiGate is not inherently bound to the use of signatures, many functionalities revolving around Web Applications, IPS and AV are. This means, for attacks that do not have a corresponding signature, the FortiGate will be vulnerable to many unknown attacks.</p> <p>In the next lab, we will evaluate FortiWeb and explore how to comprehensively protect a web application.</p> <p>Info</p> <p>To view the WAF Feature Comparison between FortiWeb and FortiGate, navigate to the Reference Architecture section.</p>"},{"location":"role-play/","title":"Cloud Role Play","text":""},{"location":"role-play/#the-standard-opener","title":"The Standard Opener","text":"<p>:fontawesome-solid-file-pdf: Download Cloud Role Play #1</p>"},{"location":"role-play/#stop-me-if-youve-heard-this-one-or-what-a-hot-mesh","title":"Stop Me If You\u2019ve Heard This One\u2026\u201d OR \u201dWhat a hot mesh","text":"<p>:fontawesome-solid-file-pdf: Download Cloud Role Play #2</p>"},{"location":"start-azure-account/","title":"Accessing your Azure Account","text":"<p>This Hands-on-Lab is configured to allow each student to have their own training lab environment using pre-created Azure resource groups, all in one shared Azure Subscription.</p> <p>??? note \"Accessing the Azure Portal: Login Instructions\"     ##Accessing the Azure Portal</p> <pre><code>Browse to &lt;a href=\"https://portal.azure.com\" target=\"_blank\"&gt;https://portal.azure.com&lt;/a&gt;\n\nUse the credentials provided to you by your instructors.\n\nIf you can't find them, check your junk mail folder. Look for an email with the subject line: **MIS - Xperts Summit - Public Cloud Track - AZURE LAB Credentials**.\n\n**Username**: xpaca**XX**@azurestorefortinet.onmicrosoft.com\n\n![](img/lab0-image1.png)\n\n**Password**: &lt;*password provided by email*\\&gt;\n\n![](img/lab0-image2.png)\n\nClick to log in, and optionally select \"Yes\" to stay signed in.\n\n![](img/lab0-image3.png)\n\nWhen the **Welcome to Microsoft Azure** window appears, skip the tour.\n\n![](img/lab0-image4.png)\n\nNow that you've signed in, you are on the Azure Portal Dashboard.\n\nNotice your **username** in the top right corner.\n</code></pre> <p>??? note \"Changing Your Password\"     ## Changing Your Password     Click on your username located in the top-right corner of the screen.</p> <pre><code>![](img/lab0-image5.png)\n\nSelect **View Account**. This action will automatically open a new tab.\n\n![](img/lab0-image6.png)\n\nYou can skip the Microsoft feedback in this new tab.\n\n![](img/lab0-image7.png)\n\nScroll down, if needed, and click on **Change Password**.\n\n![](img/lab0-image8.png)\n\nFill in the required fields to change your password and click **Submit**.\n\n![](img/lab0-image9.png)\n\nOnce you see the confirmation screen, you can close this tab. Your password has been successfully changed.\n\n![](img/lab0-image10.png)\n</code></pre> <p>??? note \"Switching Language Settings\"     ## Switching Language Settings</p> <pre><code>If you wish to change the language of your Azure dashboard, follow these steps.\n\nAfter logging into your Azure account, click on the **gear icon** in the upper-right corner.\n\n![](img/lab0-image11.png)\n\nNext, select **Language + Regional Format**.\n\n![](img/lab0-image12.png)\n\nChoose your preferred language and regional format.\n\nFor example, if you select \u201cEnglish (Canada),\" it will change the Dashboard language to Canadian English.\n\n![](img/lab0-image13.png)\n\nClick **Apply**. A message will appear asking for confirmation. Click **OK** to confirm the language change.\n\n![](img/lab0-image14.png)\n</code></pre> <p>??? note \"Verifying Resource Groups\"     ## Verifying Resource Groups</p> <pre><code>In a new Azure subscription account, only two resource groups will be pre-existing. These will be used in this lab for security customization.\n\nNavigate to **Resource Groups** on the main page.\n\n![](img/lab0-image16.png)\n\nMake sure **two** resource groups are displayed, prefixed with your student number.\n\n![](img/lab0-image17.png)\n</code></pre> <p>??? warning \"Launching CLI &amp; Setting Up Storage Account (mandatory)\"     ## Launching CLI &amp; Setting Up Storage Account</p> <pre><code>We'll next connect to the **Azure CLI**, which plays a key role in facilitating automated deployments. To do this, you'll need to have a storage account configured.\n\nClick on the **CLI Icon**, found in the top-right corner.\n\n![](img/lab0-image18.png)\n\nThis will open the CLI Shell at the bottom of the screen. Select **Bash Shell**.\n\n![](img/lab0-image19.png)\n\nSelect your **FTNT-Training** subscription and click on **Show Advanced Settings**.\n\n![](img/lab0-image20.png)\n\nThese advanced settings allow you to select existing resources. Note that the default settings may not align with where our Resource Groups are located.\n\nAdjust your settings to match the example below. **Note**: Your student number may differ.\n\n![](img/lab0-image22.png)\n\nYou are now welcomed to the *Azure Cloud Shell*.\n\n![](img/lab0-image23.png)\n\nCongratulation! You are all set to proceed with the lab activities.\n</code></pre>"},{"location":"start-deploy/","title":"Your Lab Environment","text":"<p>The accounts provided as a part of Fortinet XPERTS Academy have adjusted resource quotas to reflect the demands of this Hands on Lab. The subcription has also accepted the terms of the required marketplace offers.</p>"},{"location":"start-deploy/#deploying-your-lab-environment-in-azure","title":"Deploying your Lab Environment in Azure","text":"<p>This section will guide you through the essential steps to deploy your Lab Environment in Azure with the Fortinet Reference Architecture for Azure.</p> <p>Tip</p> <p>Click on the images to view them in a larger format.</p> <p>??? note \"Define your Prefix, Region and Ressource Groupe Name\"</p> <pre><code>Before you proceed, complete the form below to personalize your Hands-on Lab experience by setting your **Prefix**, **Region**, and **Resource Group Name**.\n\n&lt;!-- HTML Form --&gt;\n&lt;form id=\"userInputForm\" style=\"border: 1px solid #ccc; padding: 15px; margin: 15px;\"&gt;\n    &lt;div style=\"display: flex; flex-direction: column; gap: 10px;\"&gt;\n        &lt;label style=\"font-weight: bold;\"&gt;Prefix:&lt;/label&gt;\n        &lt;input type=\"text\" id=\"prefix\" name=\"prefix\" value=\"xpacaXX\" required style=\"border: 1px solid #ccc; padding: 5px;\"&gt;\n        &lt;p&gt;This prefix will be applied to all resources created during this lab for easier management and identification. Your prefix will be &lt;strong&gt;xpacaXX&lt;/strong&gt; where &lt;strong&gt;XX&lt;/strong&gt; is your student number.&lt;/p&gt;\n        &lt;label style=\"font-weight: bold;\"&gt;Region:&lt;/label&gt;\n        &lt;input type=\"text\" id=\"region\" name=\"region\" value=\"eastus\" required style=\"border: 1px solid #ccc; padding: 5px;\"&gt;\n        &lt;p&gt;&lt;span style=\"color:red;\"&gt;You need to choose the &lt;strong&gt;eastus&lt;/strong&gt; region (Richmond, Virginia)&lt;/span&gt; because this is where our Lab Quota is available. Outside of this HOL session, you could select any region in Canada such as &lt;strong&gt;canadacentral&lt;/strong&gt; (Toronto, Ontario) or &lt;strong&gt;canadaeast&lt;/strong&gt; (Quebec City, Quebec).&lt;/p&gt;\n        &lt;label style=\"font-weight: bold;\"&gt;Resource Group Name:&lt;/label&gt;\n        &lt;input type=\"text\" id=\"resourceGroupName\" name=\"resourceGroupName\" value=\"xpacaXX-blueprint\" maxlength=\"19\" required style=\"border: 1px solid #ccc; padding: 5px;\"&gt;\n        &lt;p&gt;This will be the name of the Azure Resource Group where all your lab resources will be contained. Your Azure Resource Group will be &lt;strong&gt;xpacaXX-blueprint&lt;/strong&gt; where &lt;strong&gt;XX&lt;/strong&gt; is your student number.&lt;/p&gt;\n        &lt;input type=\"submit\" value=\"Submit\" style=\"border: 1px solid #ccc; padding: 5px;\"&gt;\n        &lt;div id=\"confirmationMessage\" style=\"margin-top: 10px;\"&gt;&lt;/div&gt;\n    &lt;/div&gt;\n&lt;/form&gt;\n</code></pre> <p>??? note \"Deploy the Lab Environment with Bicep\"</p> <pre><code>- Access the Azure Cloud Shell either through the Azure Portal or directly via &lt;a href=\"https://shell.azure.com\" target=\"_blank\"&gt;https://shell.azure.com&lt;/a&gt;.\n- Log into the Azure Cloud Shell.\n- Run the following commands in the Azure Cloud:\n\n``` py\naz bicep upgrade\ngit clone -b xPerts-HoL https://github.com/AJLab-GH/fortinetCloudBlueprint.git\ncd fortinetCloudBlueprint\n```\n\n![](img/az-git-clone.png)\n\n- Deploy the template\n\n``` py\naz deployment group create --name fortinetCloudBlueprint --resource-group @RESOURCE_GROUP_NAME --template-file 000-main.bicep\n```\n\n- When you execute the script, it will prompt you with a few questions to configure the necessary settings for deployment. You'll need to provide answers for these specific settings.\n\n| Parameter    | Description                                                                                                                                                             | Requirements                                                                                                                                                                         |\n|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| **USERNAME** | The username you provide will grant you access to the FortiGate / FortiWeb GUI and SSH management interface. This username can differ from your Azure account username. | Username **admin** is **not** allowed.                                                                                                                                               |\n| **PASSWORD** | The password that will be used to log in to the FortiGate / FortiWeb GUI and SSH management interface. &lt;span style=\"color:red;\"&gt;It's crucial to use a unique password that hasn't been used elsewhere, as it will appear in plaintext in the bootstrap process.&lt;/span&gt;                                                                  | At least 12 characters long and must include characters from at least three of the following categories: uppercase, lowercase, numbers, special characters (excluding '\\\\' and '-'). |\n| **PREFIX**   | Enter **@PREFIX**. It will be applied to all the resources created to make them easier to manage, use, and identify.                                                    | Needs to be **unique**.                                                                                                                                                              |\n\n- To proceed, please enter the necessary variables when prompted.\n\n![](img/az-deployment-group-create.png)\n\n- &lt;span style=\"color:red;\"&gt;Deployment can take up to 15 minutes. Time for a coffee break, maybe even two.&lt;/span&gt;\n\n- While the template is deploying, you can monitor its progress by navigating to the resource group **@PREFIX-blueprint** and selecting the **Deployments** menu.\n\n![](img/az-deployment-monitor.png)\n\n- After deployment, you can output essential information such as public IP addresses that you will need to connect to your deployment:\n\n``` py\naz deployment group show -g @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n```\n\n![](img/az-deployment-group-show.png)\n</code></pre> <p>??? note \"Connect to FortiWeb\"     Once the deployment is complete, use the following URLs and ports to connect to your instances:</p> <pre><code>| Instance  |                                                              HTTPS Ports                                                        | SSH Ports |\n|:---------:|:-------------------------------------------------------------------------------------------------------------------------------:|:---------:|\n| FWB-A     | &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com:40030\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com:40030&lt;/a&gt; |  50030    |\n| FWB-B     | &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com:40031\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com:40031&lt;/a&gt; |  50031    |\n| DVWA      |     &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com:443&lt;/a&gt;     |   N/A     |\n\n!!! tip \"FAQ\"\n    **Why is it hard to predict which FortiWeb unit will handle my traffic?**\n\n    Traffic is distributed across both FortiWeb units, FWB-A and FWB-B. Due to this load-balancing mechanism, it's unpredictable to determine in advance which unit will manage a particular flow of traffic. That is said, we have enabled **connection persistence** on the external Azure Load Balancer. This ensures that once you've identified the correct FortiWeb unit, your traffic should consistently be managed by that unit.\n\n    **What should I do if I find the traffic log empty?**\n\n    If the traffic log is empty on one of the FortiWeb units, you'll need to log in to the other unit to see if the traffic is being managed there.\n\n    **Why do I get logged out of one GUI when logging into the other?**\n\n    Both FortiWeb units share the same domain and, consequently, the same cookies. Logging in to one GUI will overwrite the cookie for the other, automatically logging you out.\n\n    **How can I stay logged into both GUIs simultaneously?**\n\n    If you wish to keep both GUIs open at the same time, you will need to use two different web browsers. This will allow you to maintain separate sessions for each FortiWeb unit.\n\nYou can use the az **deployment group show** command to display all resources along with their URLs and ports.\n\n``` py\naz deployment group show -g @RESOURCE_GROUP_NAME -n fortinetCloudBlueprint --query properties.outputs\n```\n\n![](img/az-deployment-group-show.png)\n\nWhen connecting to FortiWeb GUI, use the username and password that you provided when deploying the template. You should then be logged in to the main Dashboard.\n\n![](img/fwb-first-connection.png)\n\nYou can double check your **DNS configuration** in the Azure Public IP settings.\n\nIn the Azure portal, search for **FWBAPClusterPublicIP**.\n\n![](img/Search-FWBAPClusterPublicIP.png)\n\nYou will find the DNS configuration under the configuration menu.\n\n![](img/Conf-FWBAPClusterPublicIP.png)\n</code></pre> <p>??? note \"Ensure that your environment is operational\"     Ensure your environment is set up correctly by following this three-step checklist.</p> <pre><code>1 - You should be able to navigate to the DVWA application: &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt;\n\n**If you encounter a FortiWeb block page, clear your browser cache and try again.**\n\n![](img/check-dvwa-connection.png)\n\n2 - Verify the presence of the two FortiWeb instances on the main dashboard by navigating to `Dashboard &gt; Status`. Additionally, check the status of your license. **Note**: we are using PAYG License model for this Lab.\n\n![](img/fwb-check-cluster-status.png)\n\n3 - Verify the topology by going to the menu `Dashboard &gt; FortiView Topology`\n\n![](img/fwb-fortiview-topology.png)\n\nIf you encounter any issues, refer to the following troubleshooting sections or consult your instructor.\n</code></pre> <p>??? tip \"Troubleshooting - What to do if the cluster is not operational?\"     During the initial startup, there's a possibility that ARP on port2 may malfunction, which could render the cluster inoperative, as port2 is deemed faulty. In such cases, you'll need to restart both FortiWeb VMs via the Azure console.</p> <pre><code>**Note that restarting the FortiWebs from the GUI will not resolve the ARP issue; only a restart from the Azure portal will fix it.**\n\nNavigate to the **Virtual Machines** menu in the Azure portal. Select the two FortiWeb VMs and click on **Restart**.\n\n![](img/fwb-restart-vm-from-azure-portal.png)\n</code></pre> <p>??? tip \"Troubleshooting - What to do if there is no policy in place, or if DVWA is not accessible?\"     The FortiWeb configuration, including the WAF policy, is automatically loaded when the VM is created. We achieve this by using the Azure cloud-init feature. Cloud-init is a widely used method for customizing a VM as it boots for the first time. However, there may be circumstances where the configuration doesn't load correctly. If this happens to you, you can simply manually import our configuration file.</p> <pre><code>1 - Navigate to the [bootstrap page](bootstrap.md)\n\n2 - Copy **Part 2** of the configuration to your clipboard\n\n![](img/fwb-bootstrap-part2.png)\n\n3 - Connect to &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com:40030\" target=\"_blank\"&gt;your **FortiWeb** instance&lt;/a&gt;, and open the CLI console located in the upper left corner\n\n4 - Paste the copied configuration into the console\n\n![](img/fwb-cli-console.png)\n\n5 - Navigate to `Dashboard &gt; FortiView Topology` and verify that the policy is now displayed\n\n![](img/fwb-fortiview-topology.png)\n\n6 - You should be able to navigate to the DVWA application: &lt;a href=\"https://@PREFIX.@REGION.cloudapp.azure.com\" target=\"_blank\"&gt;https://@PREFIX.@REGION.cloudapp.azure.com&lt;/a&gt;\n\n![](img/check-dvwa-connection.png)\n</code></pre> <p>??? tip \"Troubleshooting - Delete and rebuild your Lab Environment\"     Here's the process to follow if you need to delete and rebuild your Lab environment:</p> <pre><code>&lt;span style=\"color:red;\"&gt;Do not delete the resource group itself, as you won't be able to recreate it.&lt;/span&gt;\n\n- Navigate to the Azure portal\n- Choose your resource group, identified as **@RESOURCE_GROUP_NAME**\n- Select all the resources within the group\n- Click on **Delete**\n\n![](img/delete-ressource-group-step-1.png)\n\n- Opt for **Apply force delete for selected Virtual machines and Virtual machine scale sets**\n- Type **delete** to confirm deletion\n- Click on **Delete**\n\n![](img/delete-ressource-group-step-2.png)\n\n- Wait for the deletion process to complete\n\n![](img/delete-ressource-group-step-3.png)\n\n- Navigate to &lt;a href=\"https://shell.azure.com\" target=\"_blank\"&gt;Azure Cloud Shell&lt;/a&gt; and make sure you are in the **fortinetCloudBlueprint** folder\n\n``` py\ncd fortinetCloudBlueprint\n```\n\n- Redeploy the template using the following command\n\n``` py\naz deployment group create --name fortinetCloudBlueprint --resource-group @RESOURCE_GROUP_NAME --template-file 000-main.bicep\n```\n</code></pre> <p>??? note \"Check your System Configuration (optional)\"     Once you have access to the FortiWeb GUI, those are the main menu to check your system configuration.</p> <pre><code>| Configuration                 | Menu                                                |\n|:------------------------------|:----------------------------------------------------|\n| FortiWeb Network Access       | `Network &gt; Interface`                               |\n| Routing                       | `Network &gt; Static Route`                            |\n| DNS Configuration             | `Network &gt; DNS`                                     |\n| VM License                    | `Dashboard &gt; Status &gt; Licenses &gt; Update VM License` |\n| FortiGuard Status and Updates | `System &gt; Config &gt; FortiGuard`                      |\n| Time Zone Setting             | `System &gt; Maintenance &gt; System Time`                |\n| Timeout Setting               | `System &gt; Admin &gt; Settings &gt; Idle Timeout`          |\n| Firmware Version              | `System &gt; Maintenance &gt; Firmware`                   |\n</code></pre> <p>??? note \"Check your Application Policy (optional)\"     During the Bicep deployment, we imported this bootstrap. Those are the main menus to check your Application Policy:</p> <pre><code>| Configuration          | Menu                                          |\n|:-----------------------|:----------------------------------------------|\n| Virtual IP             | `Network &gt; Virtual IP`                        |\n| Virtual Server         | `Server Objects &gt; Virtual Server`             |\n| Server Pool            | `Server Objects &gt; Server Pool`                |\n| Signature              | `Web Protection &gt; Known Attacks &gt; Signatures` |\n| Web Protection Profile | `Policy &gt; Web Protection Profile`             |\n| Policy                 | `Policy &gt; Server Policy`                      |\n</code></pre>"},{"location":"start-deploy/#initializing-dvwa","title":"Initializing DVWA","text":"<p>??? note \"Initialize DVWA database and authenticate\"     Connect to https://@PREFIX.@REGION.cloudapp.azure.com/setup.php</p> <pre><code>Click **Create / Reset Database**\n\n![](img/Aspose.Words.fc7ec648-3633-4466-b24a-e7a2902fc6a3.006.png)\n\nClick **Login** and authenticate with any of these accounts:\n\n| Username | Password |\n|:---------|:---------|\n| admin    | password |\n| gordonb  | abc123   |\n| 1337     | charley  |\n| pablo    | letmein  |\n| smithy   | password |\n\nYou should be directed to the welcome page.\n\n![](img/DVWA-Welcome.png)\n</code></pre> <p>??? question \"How to install DVWA in another Lab Environement?\"     If you are not using the :simple-github: Azure Fortinet Cloud Blueprint, you can install your own DVWA instance.</p> <pre><code>The most straightforward way to install DVWA is by utilizing Docker. Install any Linux distribution with Docker and run those 2 commands:\n\n``` py\nsudo docker pull vulnerables/web-dvwa\nsudo docker run -d --restart unless-stopped -p 80:80 vulnerables/web-dvwa\n```\n\nYou can explore additional deployment options on the official :simple-github: &lt;a href=\"https://github.com/digininja/DVWA\" target=\"_blank\"&gt;DVWA GitHub&lt;/a&gt;.\n</code></pre>"}]}